<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grievous Property Tracker</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --secondary: #6366F1;
            --success: #10B981;
            --info: #3B82F6;
            --warning: #F59E0B;
            --danger: #EF4444;
            --light: #F9FAFB;
            --dark: #1F2937;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
        }

        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, sans-serif;
            background-color: var(--gray-100);
            color: var(--gray-800);
            font-size: 14px;
            line-height: 1.5;
        }

        /* Loading Animation */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Header Styles */
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .app-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .app-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin: 0.25rem 0 0 0;
        }

        /* Metrics Bar */
        .metrics-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .metric-card {
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Controls Section */
        .controls-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .search-input {
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            background-color: var(--gray-100);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            outline: none;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-500);
        }

        /* Form Styles */
        .form-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: none;
        }

        .form-container.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .form-label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .form-control, .form-select {
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            padding: 0.75rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            outline: none;
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Property Cards */
        .properties-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .property-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .property-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .property-image-container {
            position: relative;
            height: 180px;
            overflow: hidden;
        }

        .property-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .property-card:hover .property-image {
            transform: scale(1.05);
        }

        .property-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-buyer {
            background-color: rgba(16, 185, 129, 0.9);
            color: white;
        }

        .badge-seller {
            background-color: rgba(59, 130, 246, 0.9);
            color: white;
        }

        .badge-double-ended {
            background-color: rgba(245, 158, 11, 0.9);
            color: white;
        }

        .property-details {
            padding: 1.25rem;
        }

        .property-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .property-address {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .property-parties {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-bottom: 1rem;
        }

        .property-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .property-stat {
            text-align: center;
        }

        .property-stat-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
        }

        .property-stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
        }

        .property-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Table View */
        .table-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .properties-table {
            width: 100%;
            border-collapse: collapse;
        }

        .properties-table th {
            background-color: var(--gray-100);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
            cursor: pointer;
            user-select: none;
        }

        .properties-table th:hover {
            background-color: var(--gray-200);
        }

        .properties-table th.sorted-asc::after {
            content: " ↑";
        }

        .properties-table th.sorted-desc::after {
            content: " ↓";
        }

        .properties-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--gray-200);
            vertical-align: middle;
        }

        .properties-table tr:hover {
            background-color: var(--gray-50);
        }

        .table-image {
            width: 60px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            background-color: var(--gray-100);
            border-radius: 8px;
            padding: 0.25rem;
        }

        .view-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--gray-600);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-btn.active {
            background-color: white;
            color: var(--primary);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Modal Styles */
        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-bottom: none;
        }

        .modal-title {
            font-weight: 600;
        }

        .btn-close {
            filter: brightness(0) invert(1);
        }

        .nav-tabs .nav-link {
            color: var(--gray-600);
            font-weight: 500;
            border: none;
            border-bottom: 2px solid transparent;
            padding: 0.75rem 1rem;
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary);
            border-bottom-color: var(--gray-300);
        }

        .nav-tabs .nav-link.active {
            color: var(--primary);
            background-color: transparent;
            border-bottom-color: var(--primary);
        }

        .modal-dialog.modal-xl {
            max-width: 960px;
        }

        .modal-body {
            padding: 1rem 1.25rem;
        }

        .modal-property-image {
            width: 100%;
            max-height: 220px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .detail-item {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        /* Compact modal tweaks */
        #compactDetails h6.text-muted {
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        #compactDetails .detail-item .form-control,
        #compactDetails .detail-item .form-select,
        #compactDetails .detail-item textarea {
            margin-top: 0.25rem;
        }

        .detail-label {
            min-width: 180px;
            font-weight: 500;
            color: var(--gray-600);
            margin-bottom: 0;
        }

        .detail-value {
            flex: 1;
            color: var(--gray-900);
        }

        .parties-section h6 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.75rem;
            border-bottom: 1px solid var(--gray-200);
            padding-bottom: 0.25rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            color: var(--gray-500);
        }

        .empty-state-icon {
            font-size: 3rem;
            color: var(--gray-300);
            margin-bottom: 1rem;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }

        .custom-toast {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 300px;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast-success .toast-icon {
            color: var(--success);
        }

        .toast-error .toast-icon {
            color: var(--danger);
        }

        .toast-message {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .toast-text {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .properties-container {
                grid-template-columns: 1fr;
            }
            
            .metrics-container {
                padding: 1rem;
            }
            
            .metric-value {
                font-size: 1.5rem;
            }
            
            .controls-container {
                padding: 1rem;
            }
            
            .form-container {
                padding: 1rem;
            }

            .properties-table {
                font-size: 0.875rem;
            }

            .properties-table th,
            .properties-table td {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="app-title">
                        <i class="bi bi-building"></i>
                        Grievous Property Tracker
                    </h1>
                    <p class="app-subtitle">Real Estate Portfolio Management System</p>
                </div>
                <div class="col-md-6 text-md-end mt-3 mt-md-0">
                    <button class="btn btn-light" id="exportBtn">
                        <i class="bi bi-download me-2"></i>Export Data
                    </button>
                    <div class="btn-group ms-2">
                        <input type="file" id="importFile" accept=".json" style="display: none;">
                        <button class="btn btn-light" onclick="document.getElementById('importFile').click()">
                            <i class="bi bi-upload me-2"></i>Import Data
                        </button>
                    </div>
                    <button class="btn btn-outline-secondary ms-2" id="resetDataBtn">
                        <i class="bi bi-arrow-counterclockwise me-2"></i>Reset Data
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container my-4">
        <!-- Metrics Dashboard -->
        <div class="metrics-container fade-in">
            <div class="row g-3">
                <div class="col-md-3 col-6">
                    <div class="metric-card">
                        <div class="metric-value" id="totalProperties">0</div>
                        <div class="metric-label">Total Properties</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="metric-card">
                        <div class="metric-value" id="totalSaleValue">$0</div>
                        <div class="metric-label">Total Sale Value</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="metric-card">
                        <div class="metric-value" id="buyerSideDeals">0</div>
                        <div class="metric-label">Buyer Side Deals</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="metric-card">
                        <div class="metric-value" id="sellerSideDeals">0</div>
                        <div class="metric-label">Seller Side Deals</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls Section -->
        <div class="controls-container fade-in">
            <div class="row align-items-center g-3">
                <div class="col-md-4">
                    <div class="position-relative">
                        <i class="bi bi-search search-icon"></i>
                        <input type="text" class="form-control search-input ps-4" id="searchInput" placeholder="Search by address, name, or owner...">
                    </div>
                </div>
                <div class="col-md-5">
                    <label for="sortSelect" class="form-label mb-1 d-none d-md-block">Sort by:</label>
                    <select class="form-select" id="sortSelect">
                        <option value="saleDate-desc">Most Recent Sale Date</option>
                        <option value="saleDate-asc">Oldest Sale Date</option>
                        <option value="salePrice-desc">Highest Sale Price</option>
                        <option value="salePrice-asc">Lowest Sale Price</option>
                        <option value="propertyType-asc">Property Type (A-Z)</option>
                        <option value="representation-asc">Representation (A-Z)</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="d-flex justify-content-md-end gap-2">
                        <div class="view-toggle">
                            <button class="view-btn active" id="cardViewBtn">
                                <i class="bi bi-grid-3x3-gap me-1"></i> Cards
                            </button>
                            <button class="view-btn" id="tableViewBtn">
                                <i class="bi bi-table me-1"></i> Table
                            </button>
                            <button class="view-btn" id="insightsViewBtn">
                                <i class="bi bi-graph-up me-1"></i> Insights
                            </button>
                        </div>
                        <button class="btn btn-primary" id="addPropertyBtn">
                            <i class="bi bi-plus-circle me-2"></i>Add Property
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit Property Form -->
        <div class="form-container" id="formContainer">
            <h2 class="form-title" id="formTitle">Add New Property</h2>
            <form id="propertyForm">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="propertyAddress" class="form-label">Property Address *</label>
                        <input type="text" class="form-control" id="propertyAddress" required>
                        <div class="invalid-feedback">Property address is required</div>
                    </div>
                    <div class="col-md-6">
                        <label for="propertyName" class="form-label">Property Name</label>
                        <input type="text" class="form-control" id="propertyName">
                    </div>
                    <div class="col-md-4">
                        <label for="salePrice" class="form-label">Sale Price</label>
                        <input type="number" class="form-control" id="salePrice" min="0" step="0.01">
                    </div>
                    <div class="col-md-4">
                        <label for="saleDate" class="form-label">Sale Date</label>
                        <input type="text" class="form-control" id="saleDate" placeholder="e.g., Sep 20, 2024">
                    </div>
                    <div class="col-md-4">
                        <label for="capRate" class="form-label">Cap Rate (%)</label>
                        <input type="number" class="form-control" id="capRate" min="0" step="0.01">
                    </div>
                    <div class="col-md-4">
                        <label for="propertyType" class="form-label">Property Type</label>
                        <select class="form-select" id="propertyType">
                            <option value="">Select Type</option>
                            <option value="Residential">Residential</option>
                            <option value="Commercial">Commercial</option>
                            <option value="Industrial">Industrial</option>
                            <option value="Land">Land</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="representation" class="form-label">Representation *</label>
                        <select class="form-select" id="representation" required>
                            <option value="">Select Representation</option>
                            <option value="Buyer">Buyer</option>
                            <option value="Seller">Seller</option>
                            <option value="Double-Ended">Double-Ended</option>
                        </select>
                        <div class="invalid-feedback">Representation is required</div>
                    </div>
                    <div class="col-md-4">
                        <label for="propertyId" class="form-label">Property ID</label>
                        <input type="text" class="form-control" id="propertyId">
                    </div>
                    <div class="col-md-6">
                        <label for="ownerName" class="form-label">Owner/Seller Name</label>
                        <input type="text" class="form-control" id="ownerName">
                    </div>
                    <div class="col-md-6">
                        <label for="ownerContact" class="form-label">Owner/Seller Contact</label>
                        <input type="text" class="form-control" id="ownerContact" placeholder="Email or phone">
                    </div>
                    <div class="col-md-6">
                        <label for="buyerName" class="form-label">Buyer Name</label>
                        <input type="text" class="form-control" id="buyerName">
                    </div>
                    <div class="col-md-6">
                        <label for="buyerContact" class="form-label">Buyer Contact</label>
                        <input type="text" class="form-control" id="buyerContact" placeholder="Email or phone">
                    </div>
                    <div class="col-md-6">
                        <label for="propertyImageUrl" class="form-label">Property Image URL</label>
                        <input type="url" class="form-control" id="propertyImageUrl" placeholder="https://example.com/image.jpg">
                        <img id="imagePreview" class="image-preview d-none" alt="Property preview">
                    </div>
                    <div class="col-md-6">
                        <label for="costarUrl" class="form-label">CoStar URL</label>
                        <input type="url" class="form-control" id="costarUrl" placeholder="https://example.com">
                    </div>
                    <div class="col-md-12">
                        <label for="commissionCalculation" class="form-label">Commission Calculation</label>
                        <input type="text" class="form-control" id="commissionCalculation">
                    </div>
                    <div class="col-md-12">
                        <label for="saleNotes" class="form-label">Sale Notes</label>
                        <textarea class="form-control" id="saleNotes" rows="3"></textarea>
                    </div>
                </div>
                <div class="d-flex justify-content-end gap-2 mt-4">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save Property</button>
                </div>
            </form>
        </div>

        <!-- Properties List - Card View -->
        <div class="properties-container fade-in" id="cardView">
            <!-- Property cards will be inserted here -->
        </div>

        <!-- Properties List - Table View -->
        <div class="table-container fade-in d-none" id="tableView">
            <table class="properties-table">
                <thead>
                    <tr>
                        <th data-sort="saleDate">Sale Date <i class="bi bi-arrow-down-up"></i></th>
                        <th data-sort="salePrice">Sale Price <i class="bi bi-arrow-down-up"></i></th>
                        <th>Image</th>
                        <th>Property Address</th>
                        <th data-sort="propertyName">Property Name <i class="bi bi-arrow-down-up"></i></th>
                        <th data-sort="propertyType">Property Type <i class="bi bi-arrow-down-up"></i></th>
                        <th data-sort="representation">Representation <i class="bi bi-arrow-down-up"></i></th>
                        <th>Owner/Seller</th>
                        <th>Buyer</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="propertiesTableBody">
                    <!-- Table rows will be inserted here -->
                </tbody>
            </table>
        </div>

        <!-- Insights View -->
        <div class="insights-container fade-in d-none" id="insightsView">
            <div class="row g-3 mb-3">
                <div class="col-md-4 col-12">
                    <div class="metric-card">
                        <div class="metric-value" id="insightsBuyerCount">0</div>
                        <div class="metric-label">Buyer Side (incl. double-ended)</div>
                    </div>
                </div>
                <div class="col-md-4 col-12">
                    <div class="metric-card">
                        <div class="metric-value" id="insightsSellerCount">0</div>
                        <div class="metric-label">Seller Side (incl. double-ended)</div>
                    </div>
                </div>
                <div class="col-md-4 col-12">
                    <div class="metric-card">
                        <div class="metric-value" id="insightsDoubleCount">0</div>
                        <div class="metric-label">Double-Ended Deals</div>
                    </div>
                </div>
            </div>
            
            <!-- Owner Analytics Section -->
            <div class="row g-3 mb-3">
                <div class="col-md-3 col-6">
                    <div class="metric-card bg-light">
                        <div class="metric-value text-primary" id="insightsUniqueOwners">0</div>
                        <div class="metric-label">Unique Owners</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="metric-card bg-light">
                        <div class="metric-value text-success" id="insightsRepeatClients">0</div>
                        <div class="metric-label">Repeat Clients</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="metric-card bg-light">
                        <div class="metric-value text-warning" id="insightsBothSides">0</div>
                        <div class="metric-label">Both Sides Clients</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="metric-card bg-light">
                        <div class="metric-value text-info" id="insightsRepeatRate">0%</div>
                        <div class="metric-label">Repeat Client Rate</div>
                    </div>
                </div>
            </div>
            
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h6 class="card-title">Representation Mix</h6>
                            <canvas id="representationChartCanvas" height="220"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h6 class="card-title">Yearly Deals by Side</h6>
                            <canvas id="yearlyDealsChartCanvas" height="220"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h6 class="card-title">Top Repeat Clients</h6>
                            <canvas id="topClientsChartCanvas" height="220"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h6 class="card-title">Client Relationship Breakdown</h6>
                            <canvas id="clientRelationshipChartCanvas" height="220"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state d-none" id="emptyState">
            <div class="empty-state-icon">
                <i class="bi bi-house"></i>
            </div>
            <h3 class="empty-state-title">No Properties Found</h3>
            <p>Add your first property to get started tracking your real estate portfolio.</p>
        </div>
    </main>

    <!-- Property Detail Modal -->
    <div class="modal fade" id="propertyModal" tabindex="-1" aria-labelledby="propertyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="propertyModalLabel">Property Details</h5>
                    <div class="d-flex align-items-center gap-2">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="viewToggle" checked>
                            <label class="form-check-label" for="viewToggle">
                                <small>Tabbed View</small>
                            </label>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <img id="modalPropertyImage" class="modal-property-image" src="" alt="Property Image">
                    
                    <!-- Single Page View -->
                    <div id="singlePageView" style="display: none;">
                        <div class="mb-2" id="overviewSection">
                            <h6 class="text-muted">Overview</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="detail-item">
                                        <div class="detail-label">Property Address</div>
                                        <div class="detail-value" id="modalAddress"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="detail-item">
                                        <div class="detail-label">Property Name</div>
                                        <div class="detail-value" id="modalName"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="detail-item">
                                        <div class="detail-label">Property Type</div>
                                        <div class="detail-value" id="modalType"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="detail-item">
                                        <div class="detail-label">Property ID</div>
                                        <div class="detail-value" id="modalId"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-2" id="transactionSection">
                            <h6 class="text-muted">Transaction</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="detail-item">
                                        <div class="detail-label">Sale Price</div>
                                        <div class="detail-value" id="modalPrice"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="detail-item">
                                        <div class="detail-label">Sale Date</div>
                                        <div class="detail-value" id="modalDate"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="detail-item">
                                        <div class="detail-label">Cap Rate</div>
                                        <div class="detail-value" id="modalCapRate"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="detail-item">
                                        <div class="detail-label">Representation</div>
                                        <div class="detail-value" id="modalRepresentation"></div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="detail-item">
                                        <div class="detail-label">Commission Calculation</div>
                                        <div class="detail-value" id="modalCommission"></div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="detail-item">
                                        <div class="detail-label">Sale Notes</div>
                                        <div class="detail-value" id="modalNotes"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-2" id="partiesSection">
                            <h6 class="text-muted">Parties</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="parties-section">
                                        <div class="detail-item">
                                            <div class="detail-label">Seller/Owner Name</div>
                                            <div class="detail-value" id="modalOwnerName"></div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">Seller/Owner Contact</div>
                                            <div class="detail-value" id="modalOwnerContact"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="parties-section">
                                        <div class="detail-item">
                                            <div class="detail-label">Buyer Name</div>
                                            <div class="detail-value" id="modalBuyerName"></div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">Buyer Contact</div>
                                            <div class="detail-value" id="modalBuyerContact"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-1" id="linksSection">
                            <h6 class="text-muted">Links</h6>
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <div class="detail-item">
                                        <div class="detail-label">Property Image URL</div>
                                        <div class="detail-value">
                                            <a id="modalImageUrl" href="" target="_blank" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-image me-1"></i>View Image
                                            </a>
                                            <!-- Editable input will appear in edit mode -->
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="detail-item">
                                        <div class="detail-label">CoStar URL</div>
                                        <div class="detail-value">
                                            <a id="modalCostarUrl" href="" target="_blank" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-link-45deg me-1"></i>View on CoStar
                                            </a>
                                            <!-- Editable input will appear in edit mode -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabbed View -->
                    <div id="tabbedView">
                        <ul class="nav nav-tabs" id="propertyTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">Overview</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="transaction-tab" data-bs-toggle="tab" data-bs-target="#transaction" type="button" role="tab" aria-controls="transaction" aria-selected="false">Transaction</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="parties-tab" data-bs-toggle="tab" data-bs-target="#parties" type="button" role="tab" aria-controls="parties" aria-selected="false">Parties</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="links-tab" data-bs-toggle="tab" data-bs-target="#links" type="button" role="tab" aria-controls="links" aria-selected="false">Links</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content mt-3" id="propertyTabContent">
                            <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="detail-item">
                                            <div class="detail-label">Property Address</div>
                                            <div class="detail-value" id="modalAddressTab"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="detail-item">
                                            <div class="detail-label">Property Name</div>
                                            <div class="detail-value" id="modalNameTab"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="detail-item">
                                            <div class="detail-label">Property Type</div>
                                            <div class="detail-value" id="modalTypeTab"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="detail-item">
                                            <div class="detail-label">Property ID</div>
                                            <div class="detail-value" id="modalIdTab"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="transaction" role="tabpanel" aria-labelledby="transaction-tab">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="detail-item">
                                            <div class="detail-label">Sale Price</div>
                                            <div class="detail-value" id="modalPriceTab"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="detail-item">
                                            <div class="detail-label">Sale Date</div>
                                            <div class="detail-value" id="modalDateTab"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="detail-item">
                                            <div class="detail-label">Cap Rate</div>
                                            <div class="detail-value" id="modalCapRateTab"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="detail-item">
                                            <div class="detail-label">Representation</div>
                                            <div class="detail-value" id="modalRepresentationTab"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="detail-item">
                                            <div class="detail-label">Commission Calculation</div>
                                            <div class="detail-value" id="modalCommissionTab"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="detail-item">
                                            <div class="detail-label">Sale Notes</div>
                                            <div class="detail-value" id="modalNotesTab"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="parties" role="tabpanel" aria-labelledby="parties-tab">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="detail-item">
                                            <div class="detail-label">Seller/Owner Name</div>
                                            <div class="detail-value" id="modalOwnerNameTab"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="detail-item">
                                            <div class="detail-label">Seller/Owner Contact</div>
                                            <div class="detail-value" id="modalOwnerContactTab"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="detail-item">
                                            <div class="detail-label">Buyer Name</div>
                                            <div class="detail-value" id="modalBuyerNameTab"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="detail-item">
                                            <div class="detail-label">Buyer Contact</div>
                                            <div class="detail-value" id="modalBuyerContactTab"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="links" role="tabpanel" aria-labelledby="links-tab">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <div class="detail-item">
                                            <div class="detail-label">Property Image URL</div>
                                            <div class="detail-value">
                                                <a id="modalImageUrlTab" href="" target="_blank" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-image me-1"></i>View Image
                                                </a>
                                                <!-- Editable input will appear in edit mode -->
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="detail-item">
                                            <div class="detail-label">CoStar URL</div>
                                            <div class="detail-value">
                                                <a id="modalCostarUrlTab" href="" target="_blank" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-link-45deg me-1"></i>View on CoStar
                                                </a>
                                                <!-- Editable input will appear in edit mode -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-outline-secondary" id="modalCancelEditBtn" style="display:none;">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-success" id="modalSaveBtn" style="display:none;">
                        <i class="bi bi-check-lg me-2"></i>Save Changes
                    </button>
                    <button type="button" class="btn btn-primary" id="modalEditBtn">
                        <i class="bi bi-pencil me-2"></i>Edit in Modal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Charts Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Base data from CSV files
        const baseData = [
  {
    "id": "prop-38",
    "propertyAddress": "2020 NW Industrial Park Rd, Prineville, OR 97754",
    "salePrice": 1125000,
    "saleDate": "2024-09-20",
    "saleNotes": "Literally Referral from Clayton Brown",
    "commissionCalculation": "",
    "propertyType": "Industrial",
    "capRate": 8,
    "propertyName": "Deschutes Labs",
    "ownerName": "Deschutes Labs",
    "ownerContact": "Anthony Vivolo",
    "propertyId": "10094162",
    "representation": "Double-Ended",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/oozqqI4wF5dgB7C2GGnEI9YXlSJ36JchGwXIcSNr6gk/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/10094162/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-37",
    "propertyAddress": "4411 S Settler Dr, Ridgefield, WA 98642",
    "salePrice": 1670000,
    "saleDate": "2024-08-05",
    "saleNotes": "Ridgefield Pioneer Village #14\n- Whitney Rhoades brought the Buyer",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 6.3,
    "propertyName": "Ridgefield Pioneer Village #14",
    "ownerName": "Files Design Company",
    "ownerContact": "Patrick Files",
    "propertyId": "19815074",
    "representation": "Seller",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/opHI7gxoOFqvK4yM76be92m4ufKNgNahdENGlcehuKc/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/19815074/sale",
    "buyerName": "Singh Developments LLC",
    "buyerContact": "Hindpreet Singh"
  },
  {
    "id": "prop-36",
    "propertyAddress": "1326 E Bypass 287, Alvord, TX 76225",
    "salePrice": 1140000,
    "saleDate": "2024-06-21",
    "saleNotes": "Dollar General",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 8.26,
    "propertyName": "Dollar General",
    "ownerName": "Kjt Legacy Llc",
    "ownerContact": "Linda Becher",
    "propertyId": "9691561",
    "representation": "Seller",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/OKCy-h_PZXM76D9lOEU4JtlTYwHiI5G3ThRPSC1KkXU/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/9691561/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-34",
    "propertyAddress": "2095 S Santiam Hwy, Lebanon, OR 97355",
    "salePrice": 1750000,
    "saleDate": "2024-06-13",
    "saleNotes": "Part of a 2 Property Portfolio",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 7.17,
    "propertyName": "Burger King",
    "ownerName": "Boss Aften Properties Llc",
    "ownerContact": "Robert Boss",
    "propertyId": "6485359",
    "representation": "Double-Ended",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/B6HJYIddhPEXMIpjPgMe-NZsQRfjp76cyVf0Mnh0syw/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/6485359/sale",
    "buyerName": "QSR West, Inc.",
    "buyerContact": "Nasser Aliabadi"
  },
  {
    "id": "prop-35",
    "propertyAddress": "1445 N Pacific Hwy, Woodburn, OR 97071",
    "salePrice": 1750000,
    "saleDate": "2024-06-13",
    "saleNotes": "Part of a 2 Property Portfolio",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 7.17,
    "propertyName": "Burger King",
    "ownerName": "Boss Aften Properties Llc",
    "ownerContact": "Robert Boss",
    "propertyId": "1409049",
    "representation": "Double-Ended",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/fuNGuAOs5OybDJ-ybwJBmBvZnvfcvoXtO89kvKlIeqY/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/1409049/sale",
    "buyerName": "QSR West, Inc.",
    "buyerContact": "Nasser Aliabadi"
  },
  {
    "id": "prop-33",
    "propertyAddress": "320 Pacific Ave S, Monmouth, OR 97361",
    "salePrice": 2260000,
    "saleDate": "2024-05-31",
    "saleNotes": "Dairy Queen",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 5.98,
    "propertyName": "Dairy Queen",
    "ownerName": "Mallard Vi Llc",
    "ownerContact": "Jeffrey Douglass",
    "propertyId": "9659375",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/fsMYn1VbryEZ_umV9xHpSAM8DhjtfdCmCir2tnrphQw/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/9659375/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-32",
    "propertyAddress": "11808 NE Fourth Plain Blvd, Vancouver, WA 98682",
    "salePrice": 21000000,
    "saleDate": "2024-05-30",
    "saleNotes": "Evergreen Station",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": null,
    "propertyName": "Evergreen Station",
    "ownerName": "Nili Investments LLC",
    "ownerContact": "Shawn Nili",
    "propertyId": "715721",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/XuuQxZ-ZS1klsjxeenqWk3iLbgG2mQOeSkxO8850-xs/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/715721/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-31",
    "propertyAddress": "2221 NW Myhre Rd, Silverdale, WA 98383",
    "salePrice": 12300000,
    "saleDate": "2024-05-16",
    "saleNotes": "https://www.rosenthalcapitalgroup.com/",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 6,
    "propertyName": "Lowe's",
    "ownerName": "Tomchi Group NV, LLC",
    "ownerContact": "Wallace Ching",
    "propertyId": "7006688",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/8gCb4VKZ0956sbSX6pdjTGXGLxaZ9N6iuMrSQ6f84p0/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/7006688/sale",
    "buyerName": "Rosenthal & Rosenthal",
    "buyerContact": "Peter Rosenthal"
  },
  {
    "id": "prop-30",
    "propertyAddress": "2609-2619 NW 9th St, Corvallis, OR 97330",
    "salePrice": 1650000,
    "saleDate": "2024-03-25",
    "saleNotes": "On March 25th, 2024 a private individual sold the 7,183-square-foot retail building for $1,650,000 or about $229 per square foot to another private individual.\n\nAt time of sale, the property was 90% occupied producing a cap rate of 7.20% and an NOI of $118,800.00.\n\nA 1031 was involved in the transaction, however the down or up-leg has yet to be determined.\n\nAll information in the sale comparable was verified by the listing broker.",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 7.2,
    "propertyName": "Westview Plaza",
    "ownerName": "Armstrong Hann Living Trust",
    "ownerContact": "Deb Armstrong",
    "propertyId": "6576517",
    "representation": "Double-Ended",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/yp-EhPnb9T_vpOaXLuTvw74PPYyNbHpYJpZFLDswvps/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/6576517/sale",
    "buyerName": "Whitakers Cambridge Court Llc",
    "buyerContact": "Dan Whitaker"
  },
  {
    "id": "prop-26",
    "propertyAddress": "14231 E 40 Hwy, Kansas City, MO 64136",
    "salePrice": 306471,
    "saleDate": "2024-01-09",
    "saleNotes": "Hawthorne 40 Shopping Center (Part of a 4 Property Sale)",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 10,
    "propertyName": "Hawthorne 40 Shopping Center",
    "ownerName": "Djurdjura LLC",
    "ownerContact": "Mike Toursal",
    "propertyId": "6273868",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/6RuHOLAU3fBBoR7OEq6zK-DYkeZM-R_TzQbM7cTsic4/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/6273868/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-27",
    "propertyAddress": "14227 E US Hwy 40, Kansas City, MO 64136",
    "salePrice": 342358,
    "saleDate": "2024-01-09",
    "saleNotes": "My Dentist (Part of a 4 Property Sale)",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 10,
    "propertyName": "My Dentist",
    "ownerName": "Djurdjura LLC",
    "ownerContact": "Mike Toursal",
    "propertyId": "5619689",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/U_9_Y6_1lP4kNsPGvjwJMfi43z9jp4dL16x9olLvyu0/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/5619689/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-28",
    "propertyAddress": "14171 E Us-40 Hwy, Kansas City, MO 64136",
    "salePrice": 515535,
    "saleDate": "2024-01-09",
    "saleNotes": "The Hawthrone 40 Shopping Center\n- Pizza Hut & Wing Street (Part of a 4 Property Sale)",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 10,
    "propertyName": "Pizza Hut & Wing Street",
    "ownerName": "Djurdjura LLC",
    "ownerContact": "Mike Toursal",
    "propertyId": "581133",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/4XfNponh5Xn_YFvyjINyJijWVkjHkq8MN0KptNNtmUA/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/581133/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-29",
    "propertyAddress": "14121-14221 E Us Highway 40, Kansas City, MO 64136",
    "salePrice": 7435636,
    "saleDate": "2024-01-09",
    "saleNotes": "Hawthorne 40 S/C (Part of a 4 Property Sale)",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 10,
    "propertyName": "Hawthorne 40 S/C",
    "ownerName": "Djurdjura LLC",
    "ownerContact": "Mike Toursal",
    "propertyId": "597152",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/tpWw3d5Hvye7rPc63sOmaod1ALTM188OcWYKJYWMNMQ/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/597152/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-25",
    "propertyAddress": "1105 NW 9th St, Corvallis, OR 97330",
    "salePrice": 1515000,
    "saleDate": "2024-01-05",
    "saleNotes": "",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": null,
    "propertyName": "",
    "ownerName": "Dickerhoof Properties",
    "ownerContact": "Darren Dickerhoof",
    "propertyId": "6532056",
    "representation": "Double-Ended",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/W6udj-xRNcN0xsI4AoSvZyhiczs76d3TxzGgxxhddv8/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/6532056/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-24",
    "propertyAddress": "105 W 29th St, Vancouver, WA 98660",
    "salePrice": 1750000,
    "saleDate": "2023-12-18",
    "saleNotes": "A private individual sold this 7,800 SF building to another private individual for $1,750,000 or $145,833 per unit. The property was fully occupied at the time of sale.\n\nThe seller was motivated to divest the property because he lives in another country now so he was cashing in on his investments.\n\nThe net operating income for 2023 was reported to be $73,325, yielding a cap rate of 4.19%\n\nIf a source confirms the comparable: All information in the comparable has been verified by the listing broker and the buyer broker.",
    "commissionCalculation": "",
    "propertyType": "Residential",
    "capRate": 4.19,
    "propertyName": "Courtyard Apartments",
    "ownerName": "",
    "ownerContact": "Ruth M Woodruff, Duane K Woodruff",
    "propertyId": "4283062",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/5PL5xeoMEdnjRo3c02bJWN3cTyyZ0XBLn4YGHlJO_cg/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/4283062/sale",
    "buyerName": "105 W29th Llc",
    "buyerContact": "Dave Campos"
  },
  {
    "id": "prop-22",
    "propertyAddress": "14602-14612 NE Fourth Plain Blvd, Vancouver, WA 98682",
    "salePrice": 3575000,
    "saleDate": "2023-10-17",
    "saleNotes": "Y Plaza (Part of a 2 Property Sale)\nAshton Summers",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 6,
    "propertyName": "Y Plaza",
    "ownerName": "Real Asset Management, Inc",
    "ownerContact": "Brian Tucker; Dave Campos",
    "propertyId": "5023349",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/3eWI9gaXhZLjnALOhMvORB83Eg4DRaqmS2rDLeHASDY/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/5023349/summary",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-23",
    "propertyAddress": "14602 NE Fourth Plain Dr, Vancouver, WA 98682",
    "salePrice": 3575000,
    "saleDate": "2023-10-17",
    "saleNotes": "Y Plaza (Part of a 2 Property Sale)\nBuyer Broker: Eric Garske & Ashton Summers",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 6,
    "propertyName": "Y Plaza",
    "ownerName": "Real Asset Management, Inc",
    "ownerContact": "Dave Campos; Brian Tucker",
    "propertyId": "4404779",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/H9s0iHA9CUsno15kKbfHsUjAFTvxF1wQS4M_IAunBl4/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/4404779/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-21",
    "propertyAddress": "340 NE Beacon Dr, Grants Pass, OR 97526",
    "salePrice": 6400000,
    "saleDate": "2023-08-31",
    "saleNotes": "Nicholas Bushong",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 6.5,
    "propertyName": "Grants Pass Shopping Center",
    "ownerName": "Metro Partners LLC",
    "ownerContact": "John Farkash; Rodney Freeman; Nathaniel Williams",
    "propertyId": "5850186",
    "representation": "Seller",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/V6vQG0i5M1ImrBlAh7xf_LHGf2VvnDH6XWr_ymMWrcg/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/5850186/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-20",
    "propertyAddress": "11621 Island Ave, La Grande, OR 97850",
    "salePrice": 1600000,
    "saleDate": "2023-08-01",
    "saleNotes": "",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": "",
    "propertyName": "",
    "ownerName": "",
    "ownerContact": "",
    "propertyId": "6818721",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/0y-Yipft5sZD-rGrOn1s2QCywV_sJL7jRU3_GFT1NGc/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/6818721/sale",
    "buyerName": "The Carrington Company",
    "buyerContact": "Greg Cutler"
  },
  {
    "id": "prop-19",
    "propertyAddress": "2680 Coweeman Park Dr, Kelso, WA 98626",
    "salePrice": 1030568,
    "saleDate": "2023-05-31",
    "saleNotes": "",
    "commissionCalculation": "",
    "propertyType": "Industrial",
    "capRate": null,
    "propertyName": "",
    "ownerName": "Pacific NW Properties",
    "ownerContact": "Mitch Page",
    "propertyId": "7733798",
    "representation": "Double-Ended",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/mWW7RKIavzkDEs4rTyNOSoB6MnsNO_U69wY-Lb8dchc/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/7733798/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-18",
    "propertyAddress": "201 Cascade Mall Dr, Burlington, WA 98233",
    "salePrice": 12295000,
    "saleDate": "2023-04-07",
    "saleNotes": "Cross Court Plaza (Part of a 2 Property Sale)",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 7.63,
    "propertyName": "Cross Court Plaza",
    "ownerName": "Transnational Investments",
    "ownerContact": "Benjamin Cheng",
    "propertyId": "1170876",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/usqcLFjOkC4nVjNbe8Ky3chjGxORWU8MIGdXtuHhm8c/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/1170876/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-16",
    "propertyAddress": "454-470 Lancaster Dr NE, Salem, OR 97301",
    "salePrice": 691476,
    "saleDate": "2022-12-22",
    "saleNotes": "Multi-Property Sale (Part of a 2 Property Sale)\nNicholas Bushong",
    "propertyType": "Commercial",
    "capRate": 7.99,
    "propertyName": "Multi-Property Sale",
    "ownerName": "Joseph R Fox",
    "ownerContact": "Joseph Fox",
    "propertyId": "1237416",
    "representation": "Double-Ended",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/33mjyuLUYlluHgtw7VTWssBNqS-B9eJG825QXCL5jMk/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/1237416/sale",
    "commissionCalculation": "",
    "buyerName": "Lakeside Investment Group Llc",
    "buyerContact": "Mark Weisensee"
  },
  {
    "id": "prop-17",
    "propertyAddress": "446-448 Lancaster Dr, Salem, OR 97301",
    "salePrice": 2258524,
    "saleDate": "2022-12-22",
    "saleNotes": "Multi-Property Sale (Part of a 2 Property Sale)",
    "propertyType": "Commercial",
    "capRate": 6.74,
    "propertyName": "Multi-Property Sale",
    "ownerName": "Joseph R Fox",
    "ownerContact": "Joseph Fox",
    "propertyId": "6637034",
    "representation": "Double-Ended",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/oI1y51s92CWTLi3C-g2IjMmvI3u4ghdbZQNcnjLblf4/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/6637034/sale",
    "commissionCalculation": "",
    "buyerName": "Lakeside Investment Group Llc",
    "buyerContact": "Mark Weisensee"
  },
  {
    "id": "prop-13",
    "propertyAddress": "6606 E McKellips Rd, Mesa, AZ 85215",
    "salePrice": 1038291,
    "saleDate": "2022-12-16",
    "saleNotes": "Red Mountain Plaza (Part of a 3 Property Sale)",
    "propertyType": "Commercial",
    "capRate": null,
    "propertyName": "Red Mountain Plaza",
    "ownerName": "Jakosky Properties; Rielly Red Mountain Llc & H J Red Mounta",
    "ownerContact": "",
    "propertyId": "7102669",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/QZVTuxjz2nVsxn3gm-y7enlxUAitWBKJm42lEbLNjgM/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/7102669/sale",
    "commissionCalculation": "",
    "buyerName": "Red Mountain Plaza LLC",
    "buyerContact": "Leonard Griesel"
  },
  {
    "id": "prop-14",
    "propertyAddress": "6626-6640 E McKellips Rd, Mesa, AZ 85215",
    "salePrice": 5909692,
    "saleDate": "2022-12-16",
    "saleNotes": "Red Mountain Plaza (Part of a 3 Property Sale)",
    "propertyType": "Commercial",
    "capRate": null,
    "propertyName": "Red Mountain Plaza",
    "ownerName": "Jakosky Properties; Rielly Red Mountain Llc & H J Red Mounta",
    "ownerContact": "",
    "propertyId": "850131",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/f7hT13gl1CgYEYoDFZGDz_AIVFHFXZvoytBalRMiYiA/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/850131/sale",
    "commissionCalculation": "",
    "buyerName": "Red Mountain Plaza LLC",
    "buyerContact": "Leonard Griesel"
  },
  {
    "id": "prop-15",
    "propertyAddress": "6620 E McKellips Rd, Mesa, AZ 85215",
    "salePrice": 9452017,
    "saleDate": "2022-12-16",
    "saleNotes": "Red Mountain Plaza-Shops D (Part of a 3 Property Sale)",
    "propertyType": "Commercial",
    "capRate": null,
    "propertyName": "Red Mountain Plaza-Shops D",
    "ownerName": "Jakosky Properties; Rielly Red Mountain Llc & H J Red Mounta",
    "ownerContact": "",
    "propertyId": "6861142",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/sP65B-yyhvZk7U3rVUpQUKQZdXekSoN1ArGOFTVndL0/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/6861142/sale",
    "commissionCalculation": "",
    "buyerName": "Red Mountain Plaza LLC",
    "buyerContact": "Leonard Griesel"
  },
  {
    "id": "prop-12",
    "propertyAddress": "305 NE 4th Ave, Camas, WA 98607",
    "salePrice": 2750000,
    "saleDate": "2022-05-24",
    "saleNotes": "Farrell Building",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 6.01,
    "propertyName": "Farrell Building",
    "ownerName": "Stafford Family Trust",
    "ownerContact": "Douglas Stafford",
    "propertyId": "4489907",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/mgp6u_YQlABJkhDa4tchjWd17oVQB72mx0ObbO6xYSw/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/4489907/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-10",
    "propertyAddress": "3007 22nd Pl, Forest Grove, OR 97116",
    "salePrice": 1700000,
    "saleDate": "2021-12-23",
    "saleNotes": "Nicholas Bushong",
    "commissionCalculation": "",
    "propertyType": "Residential",
    "capRate": "",
    "propertyName": "Kaylee Apartments",
    "ownerName": "Kaylee Apartments Llc",
    "ownerContact": "Stephanie Lommen",
    "propertyId": "9058789",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/8lmHm8cWpc0ho3sB79V2HX9xZnIv25aK7eRGR8n3_sM/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/9058789/sale",
    "buyerName": "Manifaust Destiny Llc",
    "buyerContact": "Nicole Capobianco Scott"
  },
  {
    "id": "prop-11",
    "propertyAddress": "2800 NE 162nd Ave, Vancouver, WA 98682",
    "salePrice": 6195000,
    "saleDate": "2021-12-23",
    "saleNotes": "Nicholas Bushong",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 7.02,
    "propertyName": "Rite Aid",
    "ownerName": "Hummelt Development Co.",
    "ownerContact": "Hank Hummelt",
    "propertyId": "5965451",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/OVp8cZBXhHy558qoIpcREnuEka0O09mcPAWCeOq2PgM/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/5965451/sale",
    "buyerName": "Watumull Properties Corporation",
    "buyerContact": "Jaidev Watumull"
  },
  {
    "id": "prop-9",
    "propertyAddress": "23038 Twain Harte Dr, Twain Harte, CA 95383",
    "salePrice": 267000,
    "saleDate": "2021-11-30",
    "saleNotes": "",
    "commissionCalculation": "",
    "propertyType": "Land",
    "capRate": null,
    "propertyName": "",
    "ownerName": "",
    "ownerContact": "",
    "propertyId": "12621365",
    "representation": "Buyer",
    "propertyImageUrl": "https://photos.zillowstatic.com/fp/ead4f69d3b70ebc4470d5f526ad2df70-cc_ft_768.webp",
    "costarUrl": "https://product.costar.com/detail/lookup/12621365/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-8",
    "propertyAddress": "930 SW Scotton Way, Battle Ground, WA 98604",
    "salePrice": 2842105,
    "saleDate": "2021-10-29",
    "saleNotes": "Nicholas Bushong",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 4.34,
    "propertyName": "Burger King",
    "ownerName": "Paul Yang Property Llc; Yang & Yang Investors LLC",
    "ownerContact": "Paul Yang",
    "propertyId": "12621462",
    "representation": "Buyer",
    "propertyImageUrl": "https://lh3.googleusercontent.com/gps-cs-s/AC9h4nqWZXf6Gknrah6Yfn3dKpXU5w7IniNjq87L6JgOddZJ60sHt_AtMLnx_YYDPG_vq_KniHVUurV8nm3aOvSERuu2cG-bmslKeEc5A4s-mXh4WyACLn4icinu1YEsrFW0lzUwYo1j=w408-h306-k-no",
    "costarUrl": "",
    "buyerName": "Ambrosia QSR",
    "buyerContact": "Luke Pisors"
  },
  {
    "id": "prop-7",
    "propertyAddress": "6105 NE 114th Ave, Vancouver, WA 98662",
    "salePrice": 6050000,
    "saleDate": "2021-09-21",
    "saleNotes": "Orchards Retail Center\nNicholas Bushong and Eric Garske",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 5.71,
    "propertyName": "Orchards Retail Center",
    "ownerName": "Triad Investment Llc",
    "ownerContact": "Mark Halloran",
    "propertyId": "1518725",
    "representation": "Seller",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/HSkHR9MjD4UeHzbd_5GAlKZkQtdzYx3CQPiutOS0gvo/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/1518725/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-6",
    "propertyAddress": "250 Northstar Dr, Rural Hall, NC 27045",
    "salePrice": 4800000,
    "saleDate": "2021-07-26",
    "saleNotes": "American Tire\nNicholas Bushong",
    "commissionCalculation": "",
    "propertyType": "Industrial",
    "capRate": 7.14,
    "propertyName": "American Tire",
    "ownerName": "Horowitz Group",
    "ownerContact": "Adam Horowitz",
    "propertyId": "7533643",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/buE8F2YWC_Fp0NhWKEG6eJz-6j5uTerPyIzdB9mwHXo/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/7533643/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-3",
    "propertyAddress": "3602 NW 119th St, Vancouver, WA 98685",
    "salePrice": 1636504,
    "saleDate": "2021-07-22",
    "saleNotes": "Building 2 (Part of a 3 Property Sale)",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 5.99,
    "propertyName": "Felida Village: Building 2",
    "ownerName": "MAJ Development Corporation",
    "ownerContact": "Mike Jenkins",
    "propertyId": "7064945",
    "representation": "Seller",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/g2-bPS6oFNCBBHrGxw0379tAnF8RSK8kH9S-g2nXDNE/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/7064945/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-4",
    "propertyAddress": "3600 NW 119th St, Vancouver, WA 98685",
    "salePrice": 1735312,
    "saleDate": "2021-07-22",
    "saleNotes": "Building 1 (Part of a 3 Property Sale)",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 5.99,
    "propertyName": "Felida Village: Building 1",
    "ownerName": "MAJ Development Corporation",
    "ownerContact": "Mike Jenkins",
    "propertyId": "9710877",
    "representation": "Seller",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/9o8DhR3aXYIbj2JKoTQPNEfbinY3hinkY1GFqtsO6Pg/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/9710877/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-5",
    "propertyAddress": "3604 NW 119th St, Vancouver, WA 98685",
    "salePrice": 2153984,
    "saleDate": "2021-07-22",
    "saleNotes": "Building 3 (Part of a 3 Property Sale)",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 5.99,
    "propertyName": "Felida Village: Building 3",
    "ownerName": "MAJ Development Corporation",
    "ownerContact": "Mike Jenkins",
    "propertyId": "9742038",
    "representation": "Seller",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/Nr73ZQYSDhubyam_jSnoZmTk3LHP8FhzgpxICWiSJe0/117/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/9742038/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-2",
    "propertyAddress": "12035 NE Halsey St, Portland, OR 97220",
    "salePrice": 1460000,
    "saleDate": "2021-04-05",
    "saleNotes": "Listing Broker: Scott Logan",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 5.5,
    "propertyName": "Arby's",
    "ownerName": "Arctic Circle; Aca Properties Lc",
    "ownerContact": "Mike Jenkins",
    "propertyId": "5060036",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/ShVwRVqTxSuzDrX4EMDnhA6Q1oZkA9Qa_BdY95UcVkY/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/5060036/sale",
    "buyerName": "",
    "buyerContact": ""
  },
  {
    "id": "prop-1",
    "propertyAddress": "11520 SE 82nd Ave, Clackamas, OR 97086",
    "salePrice": 4050000,
    "saleDate": "2020-12-14",
    "saleNotes": "Nicholas Bushong and Eric Garske",
    "commissionCalculation": "",
    "propertyType": "Commercial",
    "capRate": 6.81,
    "propertyName": "Clackamas Service Center",
    "ownerName": "",
    "ownerContact": "",
    "propertyId": "1332101",
    "representation": "Buyer",
    "propertyImageUrl": "https://ahprd1cdn.csgpimgs.com/i2/EZgNuxloyzF0PlvgP-nNumxda8Uy4YjIpWNg9eIvTss/116/image.jpg",
    "costarUrl": "https://product.costar.com/detail/lookup/1332101/sale",
    "buyerName": "Watumull Properties Corporation; Gulsons 82nd LLC",
    "buyerContact": "Jaidev Watumull"
  }
];

        // Data management
        let properties = [];
        let editingId = null;
        let currentView = 'card'; // 'card' | 'table' | 'insights'
        let sortField = 'saleDate';
        let sortDirection = 'desc';
        let currentModalPropertyId = null;
        let representationChart = null;
        let yearlyDealsChart = null;
        let topClientsChart = null;
        let clientRelationshipChart = null;
        const STORAGE_KEY = 'gpt_properties_v3';

        // DOM elements
        const formContainer = document.getElementById('formContainer');
        const formTitle = document.getElementById('formTitle');
        const propertyForm = document.getElementById('propertyForm');
        const cardView = document.getElementById('cardView');
        const tableView = document.getElementById('tableView');
        const propertiesTableBody = document.getElementById('propertiesTableBody');
        const emptyState = document.getElementById('emptyState');
        const searchInput = document.getElementById('searchInput');
        const addPropertyBtn = document.getElementById('addPropertyBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveBtn = document.getElementById('saveBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importFile = document.getElementById('importFile');
        const resetDataBtn = document.getElementById('resetDataBtn');
        const cardViewBtn = document.getElementById('cardViewBtn');
        const tableViewBtn = document.getElementById('tableViewBtn');
        const insightsView = document.getElementById('insightsView');
        const insightsViewBtn = document.getElementById('insightsViewBtn');
        const imagePreview = document.getElementById('imagePreview');
        const propertyImageUrl = document.getElementById('propertyImageUrl');
        const saleDateInput = document.getElementById('saleDate');
        const sortSelect = document.getElementById('sortSelect');
        const propertyModal = new bootstrap.Modal(document.getElementById('propertyModal'));
        const modalEditBtn = document.getElementById('modalEditBtn');
        const modalSaveBtn = document.getElementById('modalSaveBtn');
        const modalCancelEditBtn = document.getElementById('modalCancelEditBtn');
        let modalEditMode = false;
        let modalOriginalValues = {};
        let modalEditInputs = {};

        const modalFieldMap = {
            modalAddress: { key: 'propertyAddress', type: 'text' },
            modalName: { key: 'propertyName', type: 'text' },
            modalType: { key: 'propertyType', type: 'text' },
            modalId: { key: 'propertyId', type: 'text' },
            modalPrice: { key: 'salePrice', type: 'number', step: '0.01' },
            modalDate: { key: 'saleDate', type: 'date' },
            modalCapRate: { key: 'capRate', type: 'number', step: '0.01' },
            modalRepresentation: { key: 'representation', type: 'select', options: ['Seller','Buyer','Double-Ended'] },
            modalCommission: { key: 'commissionCalculation', type: 'text' },
            modalNotes: { key: 'saleNotes', type: 'textarea', rows: 3 },
            modalOwnerName: { key: 'ownerName', type: 'text' },
            modalOwnerContact: { key: 'ownerContact', type: 'text' },
            modalBuyerName: { key: 'buyerName', type: 'text' },
            modalBuyerContact: { key: 'buyerContact', type: 'text' }
        };

        // Initialize the app
        function init() {
            loadPropertiesFromStorage();
            // Ensure buyer fields exist for legacy data
            properties.forEach(p => {
                if (!p.buyerName) p.buyerName = '';
                if (!p.buyerContact) p.buyerContact = '';
            });
            savePropertiesToStorage();
            renderProperties();
            updateStats();
            renderInsights();
            setupEventListeners();
        }

        // Load properties from localStorage or use base data
        function loadPropertiesFromStorage() {
            // Prefer versioned storage key to avoid cross-file conflicts
            const storedV3 = localStorage.getItem(STORAGE_KEY);
            if (storedV3) {
                try {
                    const raw = JSON.parse(storedV3);
                    properties = Array.isArray(raw) ? normalizePropertiesSchema(raw) : [...baseData];
                } catch (err) {
                    properties = [...baseData];
                }
                // Ensure buyer fields exist after normalization
                properties.forEach(p => {
                    if (!p.buyerName) p.buyerName = '';
                    if (!p.buyerContact) p.buyerContact = '';
                });
                savePropertiesToStorage();
                return;
            }

            // Migration: fall back to legacy key 'properties' if present
            const legacy = localStorage.getItem('properties');
            if (legacy) {
                try {
                    const raw = JSON.parse(legacy);
                    properties = Array.isArray(raw) ? normalizePropertiesSchema(raw) : [...baseData];
                } catch (err) {
                    properties = [...baseData];
                }
                properties.forEach(p => {
                    if (!p.buyerName) p.buyerName = '';
                    if (!p.buyerContact) p.buyerContact = '';
                });
                savePropertiesToStorage();
            } else {
                // First time loading - use base data
                properties = [...baseData];
                savePropertiesToStorage();
            }
        }

        // Save properties to localStorage
        function savePropertiesToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(properties));
        }

        // Normalize legacy/variant schemas to current shape
        function normalizePropertiesSchema(list) {
            if (!Array.isArray(list)) return [];
            const pick = (obj, ...keys) => {
                for (const k of keys) {
                    if (obj && obj[k] !== undefined && obj[k] !== null && obj[k] !== '') return obj[k];
                }
                return undefined;
            };
            return list.map(p => {
                const normalizeRep = (rep) => {
                    if (!rep) return '';
                    const s = String(rep).toLowerCase().trim();
                    if (s.startsWith('buyer')) return 'Buyer';
                    if (s.startsWith('seller')) return 'Seller';
                    if (s.includes('double')) return 'Double-Ended';
                    if (s === 'both' || s === 'doubleended' || s === 'double ended' || s === 'double_end') return 'Double-Ended';
                    return '';
                };
                const parsePrice = (v) => {
                    if (v === undefined || v === null || v === '') return null;
                    if (typeof v === 'number') return v;
                    const s = String(v).replace(/[$,\s]/g,'').trim();
                    if (!s) return null;
                    const m = s.match(/^(\d+(?:\.\d+)?)m$/i);
                    if (m) return Math.round(parseFloat(m[1]) * 1000000);
                    const num = parseFloat(s);
                    return isNaN(num) ? null : Math.round(num);
                };
                const parseCap = (v) => {
                    if (v === undefined || v === null || v === '') return null;
                    if (typeof v === 'number') return v;
                    const s = String(v).replace('%','').trim();
                    const num = parseFloat(s);
                    return isNaN(num) ? null : num;
                };
                const normalizeDate = (v) => {
                    if (!v) return null;
                    if (Object.prototype.toString.call(v) === '[object Date]') {
                        const d = v;
                        return isNaN(d) ? null : d.toISOString().split('T')[0];
                    }
                    const d = new Date(v);
                    if (!isNaN(d)) return d.toISOString().split('T')[0];
                    const m = String(v).match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
                    if (m) {
                        const mm = m[1].padStart(2,'0');
                        const dd = m[2].padStart(2,'0');
                        const yyyy = m[3].length === 2 ? String(2000 + parseInt(m[3])) : m[3];
                        const d2 = new Date(`${yyyy}-${mm}-${dd}`);
                        return isNaN(d2) ? null : d2.toISOString().split('T')[0];
                    }
                    return null;
                };
                const q = { ...p };
                q.id = (typeof p.id === 'string' && p.id.trim()) ? p.id : generateId();
                q.propertyAddress = pick(p,'propertyAddress','address','Address','addr','location') || '';
                q.propertyName = pick(p,'propertyName','name','Name','title','Property') || '';
                q.salePrice = parsePrice(p.salePrice ?? pick(p,'price','Price','SalePrice','sale_price'));
                q.saleDate = normalizeDate(p.saleDate ?? pick(p,'date','Date','SaleDate','sale_date'));
                q.saleNotes = pick(p,'saleNotes','notes','Notes','remarks','SaleNotes') || '';
                q.commissionCalculation = pick(p,'commissionCalculation','commission','Commission','commissionCalc','CommissionCalc') || '';
                q.propertyType = pick(p,'propertyType','type','Type') || '';
                q.capRate = parseCap(p.capRate ?? pick(p,'cap_rate','CapRate','capRatePercent','cap'));
                q.ownerName = pick(p,'ownerName','owner','Owner','seller','Seller') || '';
                q.ownerContact = pick(p,'ownerContact','ownerEmail','OwnerContact','owner_contact','sellerContact','SellerContact') || '';
                q.buyerName = pick(p,'buyerName','buyer','Buyer') || '';
                q.buyerContact = pick(p,'buyerContact','buyerEmail','BuyerContact','buyer_contact') || '';
                q.propertyId = pick(p,'propertyId','propertyID','costarId','CoStarID','CoStar Id','CoStarId') || '';
                q.representation = normalizeRep(p.representation ?? pick(p,'role','Role','side','Side'));
                q.propertyImageUrl = pick(p,'propertyImageUrl','imageUrl','ImageURL','image_url','image','img','thumbnail') || '';
                q.costarUrl = pick(p,'costarUrl','coStarUrl','CostarURL','costar','link','URL') || '';
                return q;
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Form submission
            propertyForm.addEventListener('submit', handleFormSubmit);
            
            // Add property button
            if (addPropertyBtn) {
                addPropertyBtn.addEventListener('click', showAddForm);
            }
            
            // Cancel button
            cancelBtn.addEventListener('click', hideForm);
            
            // Search input
            searchInput.addEventListener('input', handleSearch);
            
            // Export button
            exportBtn.addEventListener('click', exportData);
            
            // Import file
            importFile.addEventListener('change', importData);

            // Reset data
            if (resetDataBtn) {
                resetDataBtn.addEventListener('click', handleResetData);
            }
            
            // View toggle buttons
            cardViewBtn.addEventListener('click', () => switchView('card'));
            tableViewBtn.addEventListener('click', () => switchView('table'));
            insightsViewBtn.addEventListener('click', () => switchView('insights'));
            
            // Image URL input
            propertyImageUrl.addEventListener('input', handleImagePreview);
            
            // Sale date input parsing
            saleDateInput.addEventListener('blur', parseSaleDateInput);
            // Allow pasting multiple formats into sale date input
            saleDateInput.addEventListener('paste', handleSaleDatePaste);
            
            // Sort select
            sortSelect.addEventListener('change', handleSortSelect);
            
            // Modal edit buttons
            modalEditBtn.addEventListener('click', enterModalEditMode);
            modalSaveBtn.addEventListener('click', saveModalEdits);
            modalCancelEditBtn.addEventListener('click', cancelModalEdits);
            
            // View toggle for modal
            const viewToggle = document.getElementById('viewToggle');
            if (viewToggle) {
                viewToggle.addEventListener('change', toggleModalView);
            }
            
            // Table headers for sorting
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const field = th.getAttribute('data-sort');
                    sortField = field;
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    updateSortIcons();
                    renderProperties();
                });
            });
        }

        // Flexible parser for pasted/typed sale date values
        function parseFlexibleDate(str) {
            if (!str) return null;
            const s = String(str).trim();
            // ISO yyyy-mm-dd
            const iso = s.match(/^\d{4}-\d{1,2}-\d{1,2}$/);
            if (iso) {
                const d = new Date(s);
                return isNaN(d) ? null : d;
            }
            // US numeric M/D/YYYY or MM-DD-YYYY or with 2-digit year
            const num = s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})$/);
            if (num) {
                let mm = parseInt(num[1], 10);
                let dd = parseInt(num[2], 10);
                let yyyy = parseInt(num[3], 10);
                if (yyyy < 100) yyyy = 2000 + yyyy; // assume 21st century for 2-digit years
                if (mm >= 1 && mm <= 12 && dd >= 1 && dd <= 31) {
                    const d2 = new Date(yyyy, mm - 1, dd);
                    return isNaN(d2) ? null : d2;
                }
            }
            // Month name, e.g., Sep 19, 2024 or September 19 2024
            const months = {
                january: 1, february: 2, march: 3, april: 4, may: 5, june: 6,
                july: 7, august: 8, september: 9, october: 10, november: 11, december: 12,
                jan: 1, feb: 2, mar: 3, apr: 4, jun: 6, jul: 7, aug: 8, sep: 9, sept: 9, oct: 10, nov: 11, dec: 12
            };
            const name = s.match(/^([A-Za-z]+)\s+(\d{1,2})(?:,|\s)\s*(\d{2,4})$/);
            if (name) {
                const monthKey = name[1].toLowerCase();
                const mmIdx = months[monthKey];
                if (mmIdx) {
                    let dd = parseInt(name[2], 10);
                    let yyyy = parseInt(name[3], 10);
                    if (yyyy < 100) yyyy = 2000 + yyyy;
                    const d3 = new Date(yyyy, mmIdx - 1, dd);
                    return isNaN(d3) ? null : d3;
                }
            }
            // Fallback: try native Date
            const d = new Date(s);
            return isNaN(d) ? null : d;
        }

        // Parse and validate sale date input (on blur)
        function parseSaleDateInput() {
            const value = saleDateInput.value.trim();
            if (!value) {
                saleDateInput.classList.remove('is-invalid');
                return;
            }
            const date = parseFlexibleDate(value);
            if (!date) {
                showToast('Invalid date. Use "Sep 20, 2024" or MM/DD/YYYY', 'error');
                saleDateInput.classList.add('is-invalid');
                return;
            }
            saleDateInput.classList.remove('is-invalid');
            // Normalize display to consistent format
            const iso = date.toISOString().split('T')[0];
            saleDateInput.value = formatDate(iso);
        }

        // Handle paste into sale date input to normalize immediately
        function handleSaleDatePaste(e) {
            const text = (e.clipboardData || window.clipboardData)?.getData('text');
            if (!text) return; // let default if nothing
            e.preventDefault();
            const date = parseFlexibleDate(text);
            if (!date) {
                saleDateInput.value = text.trim();
                saleDateInput.classList.add('is-invalid');
                showToast('Invalid date. Use "Sep 20, 2024" or MM/DD/YYYY', 'error');
                return;
            }
            saleDateInput.classList.remove('is-invalid');
            const iso = date.toISOString().split('T')[0];
            saleDateInput.value = formatDate(iso);
        }

        // Handle sort select change
        function handleSortSelect() {
            const [field, dir] = sortSelect.value.split('-');
            sortField = field;
            sortDirection = dir;
            updateSortIcons();
            renderProperties();
        }

        // Update table sort icons
        function updateSortIcons() {
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            const activeTh = document.querySelector(`th[data-sort="${sortField}"]`);
            if (activeTh) {
                activeTh.classList.add(`sorted-${sortDirection}`);
            }
        }

        // Handle form submission
        function handleFormSubmit(e) {
            e.preventDefault();
            
            // Validate required fields
            const propertyAddress = document.getElementById('propertyAddress').value.trim();
            const representation = document.getElementById('representation').value;
            
            let isValid = true;
            
            if (!propertyAddress) {
                document.getElementById('propertyAddress').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('propertyAddress').classList.remove('is-invalid');
            }
            
            if (!representation) {
                document.getElementById('representation').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('representation').classList.remove('is-invalid');
            }
            
            // Validate date
            parseSaleDateInput();
            if (saleDateInput.classList.contains('is-invalid')) {
                isValid = false;
            }
            
            if (!isValid) return;
            
            // Parse sale date
            let saleDate = null;
            const saleDateValue = document.getElementById('saleDate').value.trim();
            if (saleDateValue) {
                const date = parseFlexibleDate(saleDateValue);
                if (date && !isNaN(date.getTime())) {
                    saleDate = date.toISOString().split('T')[0];
                }
            }
            
            // Get form values
            const propertyData = {
                id: editingId || generateId(),
                propertyAddress,
                salePrice: parseFloat(document.getElementById('salePrice').value) || null,
                saleDate,
                saleNotes: document.getElementById('saleNotes').value.trim(),
                commissionCalculation: document.getElementById('commissionCalculation').value.trim(),
                propertyType: document.getElementById('propertyType').value,
                capRate: parseFloat(document.getElementById('capRate').value) || null,
                propertyName: document.getElementById('propertyName').value.trim(),
                ownerName: document.getElementById('ownerName').value.trim(),
                ownerContact: document.getElementById('ownerContact').value.trim(),
                buyerName: document.getElementById('buyerName').value.trim(),
                buyerContact: document.getElementById('buyerContact').value.trim(),
                propertyId: document.getElementById('propertyId').value.trim(),
                representation,
                propertyImageUrl: document.getElementById('propertyImageUrl').value.trim(),
                costarUrl: document.getElementById('costarUrl').value.trim()
            };
            
            if (editingId) {
                // Update existing property
                const index = properties.findIndex(p => p.id === editingId);
                if (index !== -1) {
                    properties[index] = propertyData;
                    showToast('Property updated successfully', 'success');
                }
            } else {
                // Add new property
                properties.push(propertyData);
                showToast('Property added successfully', 'success');
            }
            
            savePropertiesToStorage();
            renderProperties();
            updateStats();
            hideForm();
        }

        // Show add form
        function showAddForm() {
            editingId = null;
            formTitle.textContent = 'Add New Property';
            propertyForm.reset();
            imagePreview.classList.add('d-none');
            saleDateInput.classList.remove('is-invalid');
            formContainer.classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Show edit form
        function showEditForm(id) {
            editingId = id;
            const property = properties.find(p => p.id === id);
            
            if (!property) return;
            
            formTitle.textContent = 'Edit Property';
            
            // Populate form with property data
            document.getElementById('propertyAddress').value = property.propertyAddress || '';
            document.getElementById('salePrice').value = property.salePrice || '';
            if (property.saleDate) {
                const date = new Date(property.saleDate);
                document.getElementById('saleDate').value = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } else {
                document.getElementById('saleDate').value = '';
            }
            document.getElementById('saleNotes').value = property.saleNotes || '';
            document.getElementById('commissionCalculation').value = property.commissionCalculation || '';
            document.getElementById('propertyType').value = property.propertyType || '';
            document.getElementById('capRate').value = property.capRate || '';
            document.getElementById('propertyName').value = property.propertyName || '';
            document.getElementById('ownerName').value = property.ownerName || '';
            document.getElementById('ownerContact').value = property.ownerContact || '';
            document.getElementById('buyerName').value = property.buyerName || '';
            document.getElementById('buyerContact').value = property.buyerContact || '';
            document.getElementById('propertyId').value = property.propertyId || '';
            document.getElementById('representation').value = property.representation || '';
            document.getElementById('propertyImageUrl').value = property.propertyImageUrl || '';
            document.getElementById('costarUrl').value = property.costarUrl || '';
            
            // Show image preview if URL exists
            if (property.propertyImageUrl) {
                imagePreview.src = property.propertyImageUrl;
                imagePreview.classList.remove('d-none');
            } else {
                imagePreview.classList.add('d-none');
            }
            
            saleDateInput.classList.remove('is-invalid');
            formContainer.classList.add('active');

            // Scroll to the top of the page
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Hide form
        function hideForm() {
            formContainer.classList.remove('active');
            propertyForm.reset();
            imagePreview.classList.add('d-none');
            saleDateInput.classList.remove('is-invalid');
            editingId = null;
            
            // Remove validation classes
            document.getElementById('propertyAddress').classList.remove('is-invalid');
            document.getElementById('representation').classList.remove('is-invalid');
        }

        // Delete property
        function deleteProperty(id) {
            if (confirm('Are you sure you want to delete this property?')) {
                properties = properties.filter(p => p.id !== id);
                savePropertiesToStorage();
                renderProperties();
                updateStats();
                showToast('Property deleted successfully', 'success');
            }
        }

        // Handle search
        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            renderProperties(searchTerm);
        }

        // Update statistics
        function updateStats() {
            const totalProperties = properties.length;
            const totalSaleValue = properties.reduce((sum, p) => sum + (p.salePrice || 0), 0);
            const buyerSideDeals = properties.filter(p => p.representation === 'Buyer' || p.representation === 'Double-Ended').length;
            const sellerSideDeals = properties.filter(p => p.representation === 'Seller' || p.representation === 'Double-Ended').length;
            
            document.getElementById('totalProperties').textContent = totalProperties;
            document.getElementById('totalSaleValue').textContent = formatCurrency(totalSaleValue);
            document.getElementById('buyerSideDeals').textContent = buyerSideDeals;
            document.getElementById('sellerSideDeals').textContent = sellerSideDeals;
            // Update insights summary cards
            const doubleEndedDeals = properties.filter(p => p.representation === 'Double-Ended').length;
            const buyerOnly = properties.filter(p => p.representation === 'Buyer').length;
            const sellerOnly = properties.filter(p => p.representation === 'Seller').length;
            const buyerInclDouble = buyerOnly + doubleEndedDeals;
            const sellerInclDouble = sellerOnly + doubleEndedDeals;
            const buyerCountEl = document.getElementById('insightsBuyerCount');
            const sellerCountEl = document.getElementById('insightsSellerCount');
            const doubleCountEl = document.getElementById('insightsDoubleCount');
            if (buyerCountEl) buyerCountEl.textContent = buyerInclDouble;
            if (sellerCountEl) sellerCountEl.textContent = sellerInclDouble;
            if (doubleCountEl) doubleCountEl.textContent = doubleEndedDeals;
            renderInsights();
        }

        // Switch between card and table view
        function switchView(view) {
            currentView = view;
            
            if (view === 'card') {
                cardView.classList.remove('d-none');
                tableView.classList.add('d-none');
                insightsView.classList.add('d-none');
                cardViewBtn.classList.add('active');
                tableViewBtn.classList.remove('active');
                insightsViewBtn.classList.remove('active');
            } else if (view === 'table') {
                cardView.classList.add('d-none');
                tableView.classList.remove('d-none');
                insightsView.classList.add('d-none');
                cardViewBtn.classList.remove('active');
                tableViewBtn.classList.add('active');
                insightsViewBtn.classList.remove('active');
            } else if (view === 'insights') {
                cardView.classList.add('d-none');
                tableView.classList.add('d-none');
                insightsView.classList.remove('d-none');
                cardViewBtn.classList.remove('active');
                tableViewBtn.classList.remove('active');
                insightsViewBtn.classList.add('active');
                renderInsights();
            }
            
            renderProperties();
        }

        // Render Insights charts
        function renderInsights() {
            // If Chart.js failed to load (blocked extension/CDN), skip gracefully
            if (typeof Chart === 'undefined') {
                return;
            }
            
            // Get owner insights
            const ownerInsights = getOwnerInsights();
            
            // Update owner analytics metrics
            document.getElementById('insightsUniqueOwners').textContent = ownerInsights.totalUniqueOwners;
            document.getElementById('insightsRepeatClients').textContent = ownerInsights.repeatClients;
            document.getElementById('insightsBothSides').textContent = ownerInsights.bothSidesClients;
            document.getElementById('insightsRepeatRate').textContent = ownerInsights.repeatClientRate.toFixed(1) + '%';
            
            const buyerOnly = properties.filter(p => p.representation === 'Buyer').length;
            const sellerOnly = properties.filter(p => p.representation === 'Seller').length;
            const doubleEndedDeals = properties.filter(p => p.representation === 'Double-Ended').length;

            const repCanvas = document.getElementById('representationChartCanvas');
            if (repCanvas) {
                const ctx = repCanvas.getContext('2d');
                if (representationChart) representationChart.destroy();
                representationChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Buyer', 'Seller', 'Double-Ended'],
                        datasets: [{
                            data: [buyerOnly, sellerOnly, doubleEndedDeals],
                            backgroundColor: ['#10B981', '#3B82F6', '#F59E0B']
                        }]
                    },
                    options: {
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }

            // Yearly breakdown
            const yearMap = {};
            properties.forEach(p => {
                const y = extractYear(p.saleDate);
                if (!yearMap[y]) yearMap[y] = { Buyer: 0, Seller: 0, 'Double-Ended': 0 };
                const rep = p.representation || 'Unknown';
                if (rep === 'Buyer' || rep === 'Seller' || rep === 'Double-Ended') {
                    yearMap[y][rep] = (yearMap[y][rep] || 0) + 1;
                }
            });
            const years = Object.keys(yearMap).sort();
            const buyerSeries = years.map(y => yearMap[y]['Buyer'] || 0);
            const sellerSeries = years.map(y => yearMap[y]['Seller'] || 0);
            const doubleSeries = years.map(y => yearMap[y]['Double-Ended'] || 0);

            const yearlyCanvas = document.getElementById('yearlyDealsChartCanvas');
            if (yearlyCanvas) {
                const ctx2 = yearlyCanvas.getContext('2d');
                if (yearlyDealsChart) yearlyDealsChart.destroy();
                yearlyDealsChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: years,
                        datasets: [
                            { label: 'Buyer', data: buyerSeries, backgroundColor: '#10B981' },
                            { label: 'Seller', data: sellerSeries, backgroundColor: '#3B82F6' },
                            { label: 'Double-Ended', data: doubleSeries, backgroundColor: '#F59E0B' }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } },
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } }
                        }
                    }
                });
            }
            
            // Top Repeat Clients Chart
            const topClientsCanvas = document.getElementById('topClientsChartCanvas');
            if (topClientsCanvas && ownerInsights.topClients.length > 0) {
                const ctx3 = topClientsCanvas.getContext('2d');
                if (topClientsChart) topClientsChart.destroy();
                
                const clientNames = ownerInsights.topClients.map(client => client.name);
                const clientDeals = ownerInsights.topClients.map(client => client.totalDeals);
                
                topClientsChart = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: clientNames,
                        datasets: [{
                            label: 'Total Deals',
                            data: clientDeals,
                            backgroundColor: '#8B5CF6',
                            borderColor: '#7C3AED',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        plugins: { 
                            legend: { display: false }
                        },
                        scales: {
                            x: { beginAtZero: true, ticks: { stepSize: 1 } }
                        }
                    }
                });
            }
            
            // Client Relationship Breakdown Chart
            const relationshipCanvas = document.getElementById('clientRelationshipChartCanvas');
            if (relationshipCanvas) {
                const ctx4 = relationshipCanvas.getContext('2d');
                if (clientRelationshipChart) clientRelationshipChart.destroy();
                
                const oneTimeClients = ownerInsights.totalUniqueOwners - ownerInsights.repeatClients;
                const loyalClients = ownerInsights.topClients.filter(c => c.totalDeals >= 3).length;
                const regularClients = ownerInsights.repeatClients - loyalClients;
                
                clientRelationshipChart = new Chart(ctx4, {
                    type: 'doughnut',
                    data: {
                        labels: ['One-Time Clients', 'Regular Clients (2 deals)', 'Loyal Clients (3+ deals)', 'Both Sides Clients'],
                        datasets: [{
                            data: [oneTimeClients, regularClients, loyalClients, ownerInsights.bothSidesClients],
                            backgroundColor: ['#EF4444', '#F59E0B', '#10B981', '#8B5CF6']
                        }]
                    },
                    options: {
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
        }

        function extractYear(dateStr) {
            if (!dateStr) return 'Unknown';
            const isoMatch = String(dateStr).match(/^\d{4}/);
            if (isoMatch) return isoMatch[0];
            const d = new Date(dateStr);
            if (!isNaN(d)) return String(d.getFullYear());
            return 'Unknown';
        }

        // Owner Analytics Functions
        function parseOwnerNames(ownerName, ownerContact) {
            const names = new Set();
            
            // Prioritize contact names (actual people) over business entities
            if (ownerContact && ownerContact.trim()) {
                // Parse semicolon-separated names from contact field (actual people)
                const contactNames = ownerContact.split(';')
                    .map(name => name.trim())
                    .filter(name => name.length > 0)
                    .filter(name => !name.includes('@') && !name.match(/^\d+/)); // Filter out emails and phone numbers
                
                contactNames.forEach(name => {
                    // Normalize name formatting (Title Case)
                    const normalizedName = name.split(' ')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                        .join(' ');
                    names.add(normalizedName);
                });
            } else if (ownerName && ownerName.trim()) {
                // Only use business entity name if no contact names are available
                names.add(ownerName.trim());
            }
            
            return Array.from(names);
        }

        function getOwnerAnalytics() {
            const ownerStats = new Map();
            const ownerDeals = new Map();
            
            properties.forEach(property => {
                // Parse buyer names
                const buyerNames = parseOwnerNames(property.buyerName, property.buyerContact);
                buyerNames.forEach(name => {
                    if (!ownerStats.has(name)) {
                        ownerStats.set(name, { 
                            name: name, 
                            buyerDeals: 0, 
                            sellerDeals: 0, 
                            totalDeals: 0,
                            totalValue: 0,
                            avgDealValue: 0,
                            years: new Set()
                        });
                        ownerDeals.set(name, []);
                    }
                    const stats = ownerStats.get(name);
                    stats.buyerDeals++;
                    stats.totalDeals++;
                    if (property.salePrice) {
                        const priceStr = String(property.salePrice);
                        const price = parseFloat(priceStr.replace(/[,$]/g, ''));
                        if (!isNaN(price)) {
                            stats.totalValue += price;
                        }
                    }
                    stats.years.add(extractYear(property.saleDate));
                    ownerDeals.get(name).push({...property, role: 'buyer'});
                });
                
                // Parse seller names
                const sellerNames = parseOwnerNames(property.ownerName, property.ownerContact);
                sellerNames.forEach(name => {
                    if (!ownerStats.has(name)) {
                        ownerStats.set(name, { 
                            name: name, 
                            buyerDeals: 0, 
                            sellerDeals: 0, 
                            totalDeals: 0,
                            totalValue: 0,
                            avgDealValue: 0,
                            years: new Set()
                        });
                        ownerDeals.set(name, []);
                    }
                    const stats = ownerStats.get(name);
                    stats.sellerDeals++;
                    stats.totalDeals++;
                    if (property.salePrice) {
                        const priceStr = String(property.salePrice);
                        const price = parseFloat(priceStr.replace(/[,$]/g, ''));
                        if (!isNaN(price)) {
                            stats.totalValue += price;
                        }
                    }
                    stats.years.add(extractYear(property.saleDate));
                    ownerDeals.get(name).push({...property, role: 'seller'});
                });
            });
            
            // Calculate average deal values
            ownerStats.forEach(stats => {
                if (stats.totalDeals > 0) {
                    stats.avgDealValue = stats.totalValue / stats.totalDeals;
                }
                stats.yearsActive = Array.from(stats.years).sort();
            });
            
            return { ownerStats, ownerDeals };
        }

        function getTopRepeatClients(limit = 10) {
            const { ownerStats } = getOwnerAnalytics();
            return Array.from(ownerStats.values())
                .filter(owner => owner.totalDeals > 1)
                .sort((a, b) => b.totalDeals - a.totalDeals)
                .slice(0, limit);
        }

        function getOwnerInsights() {
            const { ownerStats } = getOwnerAnalytics();
            const allOwners = Array.from(ownerStats.values());
            
            const repeatClients = allOwners.filter(owner => owner.totalDeals > 1);
            const bothSides = allOwners.filter(owner => owner.buyerDeals > 0 && owner.sellerDeals > 0);
            const loyalClients = allOwners.filter(owner => owner.totalDeals >= 3);
            
            const totalRepeatDeals = repeatClients.reduce((sum, owner) => sum + owner.totalDeals, 0);
            const totalDeals = properties.length;
            const repeatClientRate = totalDeals > 0 ? (totalRepeatDeals / totalDeals * 100) : 0;
            
            return {
                totalUniqueOwners: allOwners.length,
                repeatClients: repeatClients.length,
                bothSidesClients: bothSides.length,
                loyalClients: loyalClients.length,
                repeatClientRate: repeatClientRate,
                topClients: getTopRepeatClients(5)
            };
        }

        // Handle image preview
        function handleImagePreview() {
            const url = propertyImageUrl.value.trim();
            
            if (url) {
                imagePreview.src = url;
                imagePreview.classList.remove('d-none');
                
                // Handle image load error
                imagePreview.onerror = function() {
                    this.src = 'https://via.placeholder.com/400x250/E5E7EB/6B7280?text=Invalid+Image+URL';
                };
            } else {
                imagePreview.classList.add('d-none');
            }
        }

        // Helper to set detail value and hide item when empty
        function setDetailValue(id, rawVal, formatter) {
            const el = document.getElementById(id);
            if (!el) return false;
            const has = rawVal !== undefined && rawVal !== null && rawVal !== '';
            el.textContent = has ? (formatter ? formatter(rawVal) : rawVal) : '';
            const item = el.closest('.detail-item');
            if (item) item.classList.toggle('d-none', !has);
            return has;
        }

        function sectionHasVisibleItems(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return false;
            const items = Array.from(section.querySelectorAll('.detail-item'));
            return items.some(it => !it.classList.contains('d-none'));
        }

        // Toggle between single page and tabbed view
        function toggleModalView() {
            const viewToggle = document.getElementById('viewToggle');
            const singlePageView = document.getElementById('singlePageView');
            const tabbedView = document.getElementById('tabbedView');
            
            if (viewToggle.checked) {
                // Show tabbed view
                singlePageView.style.display = 'none';
                tabbedView.style.display = 'block';
            } else {
                // Show single page view
                singlePageView.style.display = 'block';
                tabbedView.style.display = 'none';
            }
        }

        // Populate both single page and tabbed views with property data
        function populateModalViews(property) {
            // Populate single page view
            setDetailValue('modalAddress', property.propertyAddress);
            setDetailValue('modalName', property.propertyName);
            setDetailValue('modalType', property.propertyType);
            setDetailValue('modalId', property.propertyId);
            setDetailValue('modalPrice', property.salePrice, formatCurrency);
            setDetailValue('modalDate', property.saleDate, formatDate);
            setDetailValue('modalCapRate', property.capRate, v => `${v}%`);
            setDetailValue('modalRepresentation', property.representation);
            setDetailValue('modalCommission', property.commissionCalculation);
            setDetailValue('modalNotes', property.saleNotes);
            setDetailValue('modalOwnerName', property.ownerName);
            setDetailValue('modalOwnerContact', property.ownerContact);
            setDetailValue('modalBuyerName', property.buyerName);
            setDetailValue('modalBuyerContact', property.buyerContact);

            // Populate tabbed view with same data
            setDetailValue('modalAddressTab', property.propertyAddress);
            setDetailValue('modalNameTab', property.propertyName);
            setDetailValue('modalTypeTab', property.propertyType);
            setDetailValue('modalIdTab', property.propertyId);
            setDetailValue('modalPriceTab', property.salePrice, formatCurrency);
            setDetailValue('modalDateTab', property.saleDate, formatDate);
            setDetailValue('modalCapRateTab', property.capRate, v => `${v}%`);
            setDetailValue('modalRepresentationTab', property.representation);
            setDetailValue('modalCommissionTab', property.commissionCalculation);
            setDetailValue('modalNotesTab', property.saleNotes);
            setDetailValue('modalOwnerNameTab', property.ownerName);
            setDetailValue('modalOwnerContactTab', property.ownerContact);
            setDetailValue('modalBuyerNameTab', property.buyerName);
            setDetailValue('modalBuyerContactTab', property.buyerContact);

            // Handle links for both views
            const imageUrlLink = document.getElementById('modalImageUrl');
            const imageUrlLinkTab = document.getElementById('modalImageUrlTab');
            const hasImageLink = !!property.propertyImageUrl;
            if (hasImageLink) {
                imageUrlLink.href = property.propertyImageUrl;
                imageUrlLink.style.display = 'inline-block';
                imageUrlLinkTab.href = property.propertyImageUrl;
                imageUrlLinkTab.style.display = 'inline-block';
            } else {
                imageUrlLink.style.display = 'none';
                imageUrlLinkTab.style.display = 'none';
            }

            const costarUrlLink = document.getElementById('modalCostarUrl');
            const costarUrlLinkTab = document.getElementById('modalCostarUrlTab');
            const hasCostarLink = !!property.costarUrl;
            if (hasCostarLink) {
                costarUrlLink.href = property.costarUrl;
                costarUrlLink.style.display = 'inline-block';
                costarUrlLinkTab.href = property.costarUrl;
                costarUrlLinkTab.style.display = 'inline-block';
            } else {
                costarUrlLink.style.display = 'none';
                costarUrlLinkTab.style.display = 'none';
            }

            // Show/hide sections in single page view based on content
            document.getElementById('overviewSection').style.display = sectionHasVisibleItems('overviewSection') ? 'block' : 'none';
            document.getElementById('transactionSection').style.display = sectionHasVisibleItems('transactionSection') ? 'block' : 'none';
            document.getElementById('partiesSection').style.display = sectionHasVisibleItems('partiesSection') ? 'block' : 'none';
            const linksSection = document.getElementById('linksSection');
            if (linksSection) linksSection.style.display = (hasImageLink || hasCostarLink) ? 'block' : 'none';
        }

        // Show property details in modal
        function showPropertyDetails(id) {
            const property = properties.find(p => p.id === id);
            if (!property) return;
            
            currentModalPropertyId = id;
            
            // Set modal title
            document.getElementById('propertyModalLabel').textContent = property.propertyName || 'Property Details';
            
            // Set modal image (hide if no image URL)
            const modalImage = document.getElementById('modalPropertyImage');
            if (property.propertyImageUrl) {
                modalImage.src = property.propertyImageUrl;
                modalImage.classList.remove('d-none');
                modalImage.onerror = function() {
                    this.src = 'https://via.placeholder.com/800x500/E5E7EB/6B7280?text=Invalid+Image+URL';
                };
            } else {
                modalImage.classList.add('d-none');
            }
            
            // Populate both views with property data
            populateModalViews(property);
            
            // Initialize view toggle (default to single page view)
            const viewToggle = document.getElementById('viewToggle');
            viewToggle.checked = false;
            toggleModalView();
            
            // If returning to view mode after edit, ensure buttons are reset
            exitModalEditUIState();

            // Show modal
            propertyModal.show();
        }

        function enterModalEditMode() {
            if (!currentModalPropertyId) return;
            const property = properties.find(p => p.id === currentModalPropertyId);
            if (!property) return;
            modalEditMode = true;
            modalEditBtn.style.display = 'none';
            modalSaveBtn.style.display = 'inline-block';
            modalCancelEditBtn.style.display = 'inline-block';
            modalOriginalValues = {};
            modalEditInputs = {};

            // Create editable inputs for mapped fields
            Object.keys(modalFieldMap).forEach(id => {
                const cfg = modalFieldMap[id];
                const el = document.getElementById(id);
                if (!el) return;
                modalOriginalValues[id] = el.innerHTML;
                const currentValue = property[cfg.key] ?? '';

                let input;
                if (cfg.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.className = 'form-control';
                    input.rows = cfg.rows || 3;
                    input.value = currentValue;
                } else if (cfg.type === 'select') {
                    input = document.createElement('select');
                    input.className = 'form-select';
                    (cfg.options || []).forEach(opt => {
                        const o = document.createElement('option');
                        o.value = opt; o.textContent = opt;
                        if (opt === currentValue) o.selected = true;
                        input.appendChild(o);
                    });
                } else {
                    input = document.createElement('input');
                    input.type = cfg.type || 'text';
                    input.className = 'form-control';
                    if (cfg.step) input.step = cfg.step;
                    input.value = (cfg.type === 'date' && currentValue) ? currentValue : currentValue;
                }

                // Replace display value with input
                el.innerHTML = '';
                el.appendChild(input);
                modalEditInputs[id] = input;
                // Ensure hidden items become visible in edit mode
                el.closest('.detail-item')?.classList.remove('d-none');
            });

            // Special link fields: add inputs after anchors
            const imageUrlContainer = document.getElementById('modalImageUrl')?.parentElement;
            if (imageUrlContainer) {
                const imgInput = document.createElement('input');
                imgInput.type = 'url';
                imgInput.className = 'form-control mt-2';
                imgInput.value = property.propertyImageUrl || '';
                imageUrlContainer.appendChild(imgInput);
                modalEditInputs['modalImageUrlInput'] = imgInput;
            }
            const costarUrlContainer = document.getElementById('modalCostarUrl')?.parentElement;
            if (costarUrlContainer) {
                const costarInput = document.createElement('input');
                costarInput.type = 'url';
                costarInput.className = 'form-control mt-2';
                costarInput.value = property.costarUrl || '';
                costarUrlContainer.appendChild(costarInput);
                modalEditInputs['modalCostarUrlInput'] = costarInput;
            }

            // Reveal sections if they were hidden
            ['overviewSection','transactionSection','partiesSection','linksSection'].forEach(secId => {
                const sec = document.getElementById(secId);
                if (sec) sec.style.display = 'block';
            });
        }

        function saveModalEdits() {
            if (!currentModalPropertyId) return;
            const property = properties.find(p => p.id === currentModalPropertyId);
            if (!property) return;

            // Persist values from inputs
            Object.keys(modalFieldMap).forEach(id => {
                const cfg = modalFieldMap[id];
                const input = modalEditInputs[id];
                if (!input) return;
                let val = input.value;
                if (cfg.type === 'number') {
                    val = val ? parseFloat(val) : '';
                }
                property[cfg.key] = val;
            });
            // Links
            if (modalEditInputs['modalImageUrlInput']) {
                property.propertyImageUrl = modalEditInputs['modalImageUrlInput'].value.trim();
            }
            if (modalEditInputs['modalCostarUrlInput']) {
                property.costarUrl = modalEditInputs['modalCostarUrlInput'].value.trim();
            }

            savePropertiesToStorage();
            showToast('Property updated successfully', 'success');

            // Refresh modal view with updated values
            exitModalEditUIState();
            showPropertyDetails(currentModalPropertyId);
            // Also re-render lists to reflect updates
            renderProperties();
            updateStats();
        }

        function cancelModalEdits() {
            // Restore original display values
            Object.keys(modalOriginalValues).forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = modalOriginalValues[id];
            });
            // Remove link inputs if present
            const imageUrlContainer = document.getElementById('modalImageUrl')?.parentElement;
            if (imageUrlContainer) {
                const inp = modalEditInputs['modalImageUrlInput'];
                if (inp) imageUrlContainer.removeChild(inp);
            }
            const costarUrlContainer = document.getElementById('modalCostarUrl')?.parentElement;
            if (costarUrlContainer) {
                const inp2 = modalEditInputs['modalCostarUrlInput'];
                if (inp2) costarUrlContainer.removeChild(inp2);
            }
            exitModalEditUIState();
            // Re-apply compact view hiding
            if (currentModalPropertyId) {
                showPropertyDetails(currentModalPropertyId);
            }
        }

        function exitModalEditUIState() {
            modalEditMode = false;
            modalEditBtn.style.display = 'inline-block';
            modalSaveBtn.style.display = 'none';
            modalCancelEditBtn.style.display = 'none';
            modalOriginalValues = {};
            modalEditInputs = {};
        }

        // Render properties
        function renderProperties(searchTerm = '') {
            let filteredProperties = properties;
            
            // Apply search filter
            if (searchTerm) {
                filteredProperties = properties.filter(property => {
                    return (
                        (property.propertyAddress && property.propertyAddress.toLowerCase().includes(searchTerm)) ||
                        (property.ownerName && property.ownerName.toLowerCase().includes(searchTerm)) ||
                        (property.buyerName && property.buyerName.toLowerCase().includes(searchTerm)) ||
                        (property.propertyName && property.propertyName.toLowerCase().includes(searchTerm))
                    );
                });
            }
            
            // Apply sorting
            filteredProperties.sort((a, b) => {
                let aValue = a[sortField];
                let bValue = b[sortField];
                
                // Handle null values
                if (aValue === null || aValue === '') aValue = sortDirection === 'asc' ? '' : 'ZZZZZZ';
                if (bValue === null || bValue === '') bValue = sortDirection === 'asc' ? '' : 'ZZZZZZ';
                
                if (sortField === 'saleDate') {
                    aValue = aValue ? new Date(aValue).getTime() : (sortDirection === 'asc' ? -Infinity : Infinity);
                    bValue = bValue ? new Date(bValue).getTime() : (sortDirection === 'asc' ? -Infinity : Infinity);
                } else if (sortField === 'salePrice' || sortField === 'capRate') {
                    aValue = parseFloat(aValue) || 0;
                    bValue = parseFloat(bValue) || 0;
                }
                
                if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
                if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Update sort select
            sortSelect.value = `${sortField}-${sortDirection}`;
            
            // Show empty state if no properties
            if (filteredProperties.length === 0) {
                emptyState.classList.remove('d-none');
                cardView.classList.add('d-none');
                tableView.classList.add('d-none');
                return;
            } else {
                emptyState.classList.add('d-none');
                
                if (currentView === 'card') {
                    cardView.classList.remove('d-none');
                    tableView.classList.add('d-none');
                    insightsView.classList.add('d-none');
                    renderCardView(filteredProperties);
                } else if (currentView === 'table') {
                    cardView.classList.add('d-none');
                    tableView.classList.remove('d-none');
                    insightsView.classList.add('d-none');
                    renderTableView(filteredProperties);
                } else if (currentView === 'insights') {
                    // When viewing insights, hide both card and table containers
                    cardView.classList.add('d-none');
                    tableView.classList.add('d-none');
                    insightsView.classList.remove('d-none');
                    // Charts are rendered via switchView/updateStats -> renderInsights
                }
            }
        }

        // Render card view
        function renderCardView(filteredProperties) {
            cardView.innerHTML = '';
            
            filteredProperties.forEach(property => {
                const card = document.createElement('div');
                card.className = 'property-card';
                card.onclick = (e) => {
                    if (e.target.closest('.property-actions')) return;
                    showPropertyDetails(property.id);
                };
                
                // Determine badge class based on representation
                let badgeClass = '';
                if (property.representation === 'Buyer') {
                    badgeClass = 'badge-buyer';
                } else if (property.representation === 'Seller') {
                    badgeClass = 'badge-seller';
                } else if (property.representation === 'Double-Ended') {
                    badgeClass = 'badge-double-ended';
                }
                
                // Format sale price
                const salePrice = property.salePrice ? formatCurrency(property.salePrice) : 'Not specified';
                
                // Format cap rate
                const capRate = property.capRate ? `${property.capRate}%` : 'N/A';
                
                // Create property image URL with fallback
                const imageUrl = property.propertyImageUrl || 'https://via.placeholder.com/400x250/E5E7EB/6B7280?text=No+Image+Available';
                
                card.innerHTML = `
                    <div class="property-image-container">
                        <img src="${imageUrl}" alt="${property.propertyName || 'Property'}" class="property-image" 
                             onerror="this.src='https://via.placeholder.com/400x250/E5E7EB/6B7280?text=Invalid+Image+URL'">
                        ${property.representation ? `<span class="property-badge ${badgeClass}">${property.representation}</span>` : ''}
                    </div>
                    <div class="property-details">
                        <h3 class="property-name">${property.propertyName || 'Property'}</h3>
                        <p class="property-address">${property.propertyAddress || 'No address specified'}</p>
                        <div class="property-parties">
                            <div><strong>Seller:</strong> ${property.ownerContact || property.ownerName || 'N/A'}</div>
                            <div><strong>Buyer:</strong> ${property.buyerContact || property.buyerName || 'N/A'}</div>
                        </div>
                        <div class="property-stats">
                            <div class="property-stat">
                                <div class="property-stat-value">${salePrice}</div>
                                <div class="property-stat-label">Price</div>
                            </div>
                            <div class="property-stat">
                                <div class="property-stat-value">${capRate}</div>
                                <div class="property-stat-label">Cap Rate</div>
                            </div>
                            <div class="property-stat">
                                <div class="property-stat-value">${property.propertyType || 'N/A'}</div>
                                <div class="property-stat-label">Type</div>
                            </div>
                        </div>
                        <div class="property-actions">
                            <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); showEditForm('${property.id}')">
                                <i class="bi bi-pencil me-1"></i>Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteProperty('${property.id}')">
                                <i class="bi bi-trash me-1"></i>Delete
                            </button>
                        </div>
                    </div>
                `;
                
                cardView.appendChild(card);
            });
        }

        // Render table view
        function renderTableView(filteredProperties) {
            propertiesTableBody.innerHTML = '';
            
            filteredProperties.forEach(property => {
                const row = document.createElement('tr');
                row.onclick = (e) => {
                    if (e.target.closest('.btn-group')) return;
                    showPropertyDetails(property.id);
                };
                
                // Format sale date
                const saleDate = property.saleDate ? formatDate(property.saleDate) : '';
                
                // Format sale price
                const salePrice = property.salePrice ? formatCurrency(property.salePrice) : '';
                
                // Create table image with fallback
                const imageUrl = property.propertyImageUrl || 'https://via.placeholder.com/60x40/E5E7EB/6B7280?text=No+Image';
                
                row.innerHTML = `
                    <td>${saleDate}</td>
                    <td>${salePrice}</td>
                    <td>
                        <img src="${imageUrl}" alt="Property" class="table-image" 
                             onerror="this.src='https://via.placeholder.com/60x40/E5E7EB/6B7280?text=Error'">
                    </td>
                    <td>${property.propertyAddress || ''}</td>
                    <td>${property.propertyName || ''}</td>
                    <td>${property.propertyType || ''}</td>
                    <td>${property.representation || ''}</td>
                    <td>${property.ownerName || ''}</td>
                    <td>${property.buyerName || ''}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); showEditForm('${property.id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteProperty('${property.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                propertiesTableBody.appendChild(row);
            });
            
            updateSortIcons();
        }

        // Export data
        function exportData() {
            const dataStr = JSON.stringify(properties, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `properties_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('Data exported successfully', 'success');
        }

        // Import data
        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedProperties = JSON.parse(event.target.result);
                    
                    if (Array.isArray(importedProperties)) {
                        properties = normalizePropertiesSchema(importedProperties);
                        savePropertiesToStorage();
                        renderProperties();
                        updateStats();
                        renderInsights();
                        showToast('Data imported successfully', 'success');
                    } else {
                        showToast('Invalid file format', 'error');
                    }
                } catch (error) {
                    showToast('Error importing data', 'error');
                }
            };
            
            reader.readAsText(file);
            
            // Reset file input
            e.target.value = '';
        }

        // Reset data to demo dataset
        function handleResetData() {
            const confirmed = confirm('This will clear saved properties and restore the demo dataset. Continue?');
            if (!confirmed) return;
            try {
                // Remove stored properties for current origin (both legacy and versioned keys)
                localStorage.removeItem('properties');
                localStorage.removeItem(STORAGE_KEY);
                // Restore demo data
                properties = normalizePropertiesSchema(baseData);
                savePropertiesToStorage();
                renderProperties();
                updateStats();
                renderInsights();
                showToast('Data reset. Demo dataset restored.', 'success');
            } catch (err) {
                showToast('Failed to reset data', 'error');
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `custom-toast toast-${type}`;
            
            const iconClass = type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-circle-fill';
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="bi ${iconClass}"></i>
                </div>
                <div class="toast-message">
                    <div class="toast-title">${type === 'success' ? 'Success' : 'Error'}</div>
                    <div class="toast-text">${message}</div>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => {
                    toastContainer.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Format currency
        function formatCurrency(value) {
            if (!value && value !== 0) return '$0';
            
            // Format large values with M for millions
            if (value >= 1000000) {
                return `$${(value / 1000000).toFixed(1)}M`;
            }
            
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

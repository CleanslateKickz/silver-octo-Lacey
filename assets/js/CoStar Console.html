<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="https://companieslogo.com/img/orig/CSGP-5955041b.png?t=1720244491">
    <title>CoStar Research Console</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Outfit:wght@100..900&display=swap"
        rel="stylesheet">
    <!-- AG Grid -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-quartz.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', 'sans-serif'],
                        display: ['"Outfit"', 'sans-serif']
                    },
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
                        slate: { 950: '#020617' }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f8fafc;
            overflow: hidden;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* AG Grid Customization - Light Theme (Quartz Override) */
        .ag-theme-quartz {
            --ag-background-color: #ffffff;
            --ag-header-background-color: #f8fafc;
            --ag-header-foreground-color: #64748b;
            --ag-row-hover-color: #f1f5f9;
            --ag-selected-row-background-color: #eff6ff;
            --ag-font-family: 'Inter', sans-serif;
            --ag-font-size: 13px;
            --ag-grid-size: 8px;
            --ag-header-height: 48px;
            --ag-row-border-color: #e2e8f0;
            --ag-header-column-separator-display: none;
            --ag-data-color: #334155;
            /* High contrast text */
            --ag-secondary-foreground-color: #64748b;
        }

        .ag-theme-quartz .ag-header-cell {
            font-weight: 700;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.05em;
            color: #64748b;
        }

        .ag-theme-quartz .ag-row {
            border-bottom: 1px solid #e2e8f0;
        }

        .ag-theme-quartz .ag-row-odd {
            background-color: #f8fafc;
        }

        .ag-theme-quartz .ag-cell {
            display: flex;
            align-items: center;
            color: #334155;
            font-weight: 500;
        }

        .ag-theme-quartz .ag-root-wrapper {
            border: none;
            border-radius: 0;
            background: #ffffff;
        }

        .ag-theme-quartz .ag-header {
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .ag-theme-quartz .ag-header-cell-resize::after {
            height: 50%;
            top: 25%;
            background-color: #cbd5e1;
        }

        /* Drawer/Sidebar Transitions */
        .sidebar-panel {
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.08);
        }

        /* Layout Modes */
        .layout-standard #sidebar-visuals {
            right: 360px;
            /* Width of input sidebar */
            width: 360px;
            transform: translateX(200%);
            /* Hidden */
        }

        .layout-widescreen #sidebar-visuals {
            left: 0;
            width: 45%;
            right: auto;
            border-right: 1px solid #e2e8f0;
            border-left: none;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.05);
            transform: translateX(-100%);
            /* Hidden */
        }

        .layout-widescreen #sidebar-inputs {
            width: 55%;
        }

        /* Sidebar Visible States */
        .sidebar-visible #sidebar-inputs {
            transform: translateX(0) !important;
        }

        .sidebar-visible.layout-standard #sidebar-visuals {
            transform: translateX(0) !important;
        }

        .sidebar-visible.layout-widescreen #sidebar-visuals {
            transform: translateX(0) !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Inputs */
        .input-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .input-field {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.6rem 0.8rem;
            font-size: 0.9rem;
            transition: all 0.2s;
            background: #ffffff;
            color: #1e293b;
        }

        .input-field:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-label-compact {
            display: block;
            font-size: 9px;
            font-weight: 700;
            color: #94a3b8;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .input-field-compact {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            transition: all 0.2s;
            background: #ffffff;
            color: #1e293b;
        }

        .input-field-compact:focus {
            border-color: #3b82f6;
            outline: none;
            background: #f8fafc;
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
        }

        /* Active Button States */
        #view-table.active,
        #view-cards.active,
        #tab-incomplete.active,
        #tab-complete.active {
            background-color: #ffffff;
            color: #0f172a;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        #view-table:not(.active),
        #view-cards:not(.active),
        #tab-incomplete:not(.active),
        #tab-complete:not(.active) {
            color: #64748b;
        }
    </style>
</head>

<body class="h-screen flex flex-col text-gray-800 layout-standard overflow-hidden bg-slate-50" id="app-body">

    <!-- HEADER -->
    <header
        class="bg-white border-b border-gray-200 h-16 flex-none z-50 flex items-center justify-between px-6 shadow-sm">
        <div class="flex items-center gap-4">
            <div
                class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center text-white shadow-md shadow-blue-500/20">
                <i class="fa-solid fa-building text-lg"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-gray-900 leading-tight font-display tracking-tight">CoStar Console
                </h1>
                <p class="text-[10px] text-gray-500 font-semibold tracking-wider uppercase">Research & Analytics</p>
            </div>
        </div>

        <!-- Persistant Global Search -->
        <div class="flex-1 max-w-xl mx-12">
            <div class="relative group">
                <i
                    class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-blue-500 transition-colors"></i>
                <input type="text" id="search-input" placeholder="Search by address, owner, city, ID..."
                    class="w-full bg-gray-100 border-none rounded-xl py-2.5 pl-11 pr-4 text-sm focus:ring-2 focus:ring-blue-500/20 transition-all placeholder-gray-400"
                    oninput="handleSearch()">
            </div>
        </div>

        <div class="flex items-center gap-6">
            <!-- View Toggle (Moved here) -->
            <div class="flex items-center bg-gray-100 rounded-lg p-1 border border-gray-200">
                <button onclick="setView('table')" id="view-table"
                    class="px-4 py-1.5 rounded-md text-xs font-bold transition-all shadow-sm">
                    <i class="fa-solid fa-table-list mr-1.5"></i> Table
                </button>
                <button onclick="setView('cards')" id="view-cards"
                    class="px-4 py-1.5 rounded-md text-xs font-bold transition-all text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-grip-vertical mr-1.5"></i> Cards
                </button>
            </div>

            <div class="h-8 w-px bg-gray-200"></div>

            <!-- Layout Toggle -->
            <div class="flex items-center bg-gray-100 rounded-lg p-1 border border-gray-200" title="Switch Layout">
                <button onclick="toggleLayout('standard')" id="layout-standard-btn"
                    class="px-3 py-1.5 rounded-md text-xs font-bold transition-all text-gray-400 hover:text-gray-900">
                    <i class="fa-solid fa-columns mr-1"></i> Standard
                </button>
                <button onclick="toggleLayout('widescreen')" id="layout-widescreen-btn"
                    class="px-3 py-1.5 rounded-md text-xs font-bold transition-all text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-money-check mr-1"></i> Wide
                </button>
            </div>

            <div
                class="bg-slate-900 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg shadow-slate-900/20 tabular-nums">
                <span id="showing-count">0</span> <span class="text-slate-400 font-medium mx-1">/</span> <span
                    id="total-count">0</span>
            </div>
        </div>
    </header>

    <!-- TOOLBAR -->
    <div class="bg-white border-b border-gray-200 px-6 py-3 flex items-center justify-between flex-none z-40">
        <div class="flex items-center gap-3">
            <input type="file" id="file-input" multiple accept=".csv, .xlsx, .xls" style="display:none">

            <button onclick="document.getElementById('file-input').click()"
                class="flex items-center gap-2 px-4 py-2 bg-slate-900 hover:bg-slate-800 text-white text-sm font-bold rounded-lg shadow-sm transition-all hover:shadow-md hover:-translate-y-0.5">
                <i class="fa-solid fa-plus"></i> Import Data
            </button>

            <div class="h-6 w-px bg-gray-200"></div>

            <!-- Tabs -->
            <div class="flex items-center bg-gray-100 rounded-lg p-1">
                <button onclick="setTab('incomplete')" id="tab-incomplete"
                    class="px-4 py-1.5 rounded-md text-sm font-bold transition-all bg-white text-gray-900 shadow-sm">
                    Research Queue <span id="incomplete-count"
                        class="ml-2 bg-gray-200 text-gray-600 px-2 py-0.5 rounded-md text-[10px]">0</span>
                </button>
                <button onclick="setTab('complete')" id="tab-complete"
                    class="px-4 py-1.5 rounded-md text-sm font-semibold transition-all text-gray-500 hover:text-gray-700">
                    Completed <span id="complete-count" class="ml-2 opacity-50">0</span>
                </button>
            </div>

            <div class="h-6 w-px bg-gray-200"></div>

            <button onclick="reloadGrid()"
                class="w-9 h-9 flex items-center justify-center rounded-lg text-gray-400 hover:text-gray-700 hover:bg-gray-100 transition-all"
                title="Refresh">
                <i class="fa-solid fa-rotate"></i>
            </button>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="exportData()"
                class="flex items-center gap-2 px-4 py-2 border border-gray-200 hover:bg-gray-50 text-gray-700 text-sm font-bold rounded-lg transition-all">
                <i class="fa-solid fa-download text-gray-400"></i> Export
            </button>
        </div>
        <!-- Search -->
        <div class="relative group">
            <i
                class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-blue-500 transition-colors"></i>
            <input type="text" id="search-input" onkeyup="handleSearch()" placeholder="Search properties..."
                class="pl-9 pr-4 py-2 border border-gray-200 rounded-lg text-sm w-64 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all bg-slate-50 focus:bg-white">
        </div>

        <button onclick="reloadGrid()"
            class="w-9 h-9 flex items-center justify-center rounded-lg text-gray-400 hover:text-gray-700 hover:bg-gray-100 transition-all"
            title="Refresh">
            <i class="fa-solid fa-rotate"></i>
        </button>

        <button onclick="exportData()"
            class="w-9 h-9 flex items-center justify-center rounded-lg text-emerald-600 hover:text-emerald-700 hover:bg-emerald-50 transition-all"
            title="Export Excel">
            <i class="fa-solid fa-file-excel"></i>
        </button>

        <button onclick="clearAll()"
            class="w-9 h-9 flex items-center justify-center rounded-lg text-red-400 hover:text-red-600 hover:bg-red-50 transition-all"
            title="Reset All Data">
            <i class="fa-solid fa-trash-can"></i>
        </button>
    </div>
    </div>

    <!-- MAIN WORKSPACE -->
    <main class="flex-1 relative overflow-hidden flex">

        <!-- Upload Overlay -->
        <div id="upload-overlay"
            class="absolute inset-0 z-[60] bg-white/95 backdrop-blur-sm flex flex-col items-center justify-center text-center">
            <div class="bg-white p-12 rounded-3xl shadow-2xl border border-gray-100 max-w-lg w-full transform hover:scale-105 transition-all duration-300 cursor-pointer group"
                id="drop-area">
                <div
                    class="w-20 h-20 bg-blue-50 text-blue-500 rounded-2xl flex items-center justify-center text-3xl mx-auto mb-6 group-hover:bg-blue-600 group-hover:text-white transition-all shadow-md">
                    <i class="fa-solid fa-cloud-arrow-up"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2 font-display">Drop Files Here</h2>
                <p class="text-gray-500 mb-8">Import your master Excel or CSV file</p>

                <div class="flex flex-col gap-4">
                    <button onclick="document.getElementById('file-input').click()"
                        class="w-full py-3.5 bg-gray-900 hover:bg-black text-white font-bold rounded-xl transition-all shadow-lg hover:shadow-xl">
                        Browse Files
                    </button>
                    <!-- Clear Option -->
                    <div class="flex items-center justify-center gap-2">
                        <input type="checkbox" id="clear-data-checkbox"
                            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="clear-data-checkbox" class="text-xs text-gray-500 font-medium">Clear existing
                            data</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- View Containers -->
        <div id="table-view" class="w-full h-full">
            <!-- AG Grid Container -->
            <div id="myGrid" class="ag-theme-quartz w-full h-full"></div>
        </div>

        <div id="cards-view" class="w-full h-full overflow-y-auto hidden bg-slate-50 p-6">
            <div id="card-container"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6">
                <!-- Cards injected here -->
            </div>
        </div>

        <!-- SIDEBAR OVERLAY -->
        <div id="sidebar-overlay"
            class="fixed inset-0 z-[70] bg-slate-900/20 backdrop-blur-[1px] hidden transition-opacity opacity-0"
            onclick="closeDrawer()"></div>

        <!-- VISUALS SIDEBAR (Left in Wide mode, Inner Right in Standard) -->
        <aside id="sidebar-visuals"
            class="sidebar-panel fixed inset-y-0 bg-white z-[80] flex flex-col pointer-events-auto border-l border-gray-200 transform translate-x-full">
            <div class="h-full flex flex-col" id="sidebar-visuals-content">
                <!-- Injected via JS -->
            </div>
        </aside>

        <!-- INPUTS SIDEBAR (Always Right) -->
        <aside id="sidebar-inputs"
            class="sidebar-panel fixed inset-y-0 right-0 w-[360px] bg-white z-[81] flex flex-col pointer-events-auto border-l border-gray-200 transform translate-x-full shadow-2xl">
            <!-- Header -->
            <div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 bg-white flex-none"
                id="sidebar-header">
                <!-- Injected via JS -->
            </div>

            <div class="flex-1 overflow-y-auto p-4 bg-slate-50" id="sidebar-inputs-content">
                <!-- Injected via JS -->
            </div>

            <!-- Footer -->
            <div class="p-4 border-t border-gray-100 bg-white flex-none">
                <button onclick="deleteProperty()"
                    class="w-full py-2 text-xs font-bold text-red-500 hover:bg-red-50 rounded-lg transition-colors border border-red-100">
                    Delete Property
                </button>
            </div>
        </aside>
    </main>

    <!-- TOAST -->
    <div id="toast"
        class="fixed bottom-6 right-6 transform translate-y-20 opacity-0 transition-all duration-300 z-[100]">
        <div class="bg-gray-900 text-white px-5 py-3 rounded-xl shadow-xl flex items-center gap-3 text-sm font-medium">
            <i id="toast-icon" class="fa-solid fa-circle-check text-green-400"></i>
            <span id="toast-msg">Notification</span>
        </div>
    </div>

    <script>
        const DEFAULT_DATA_URL = 'Master.xlsx';
        const API_URL = 'https://costar-api.vercel.app/api/properties';

        // Field mapping: HTML (camelCase) <-> API (snake_case)
        const FIELD_MAP_TO_API = {
            imageurl: 'image_url',
            buildingname: 'building_name',
            postalcode: 'postal_code',
            newsalestatus: 'new_sale_status',
            currentprice: 'current_price',
            daysonmarket: 'days_on_market',
            analysisnotes: 'analysis_notes',
            changedate: 'change_date',
            om: 'om_url',
            costarid: 'costar_id',
            ownerphone: 'phone1',
            ownerphone2: 'phone2',
            owneremail: 'email',
            ownercontact: 'owner_contact',
            ownerfullname: 'owner_full_name',
            ownerentity: 'owner_entity',
            otherowners: 'other_owners',
            owneraddress: 'owner_address',
            contactnotes: 'contact_notes',
            withdrawaloccurrences: 'withdrawal_occurrences',
            pricereductions: 'price_reductions',
            propertytype: 'property_type',
            _completed: 'completed'
        };

        const FIELD_MAP_FROM_API = Object.fromEntries(
            Object.entries(FIELD_MAP_TO_API).map(([k, v]) => [v, k])
        );

        function toApiFormat(prop) {
            const out = {};
            for (const [k, v] of Object.entries(prop)) {
                if (k.startsWith('_') && k !== '_completed') continue;
                const apiKey = FIELD_MAP_TO_API[k] || k;
                out[apiKey] = v;
            }
            return out;
        }

        function fromApiFormat(row) {
            const out = {};
            for (const [k, v] of Object.entries(row)) {
                const htmlKey = FIELD_MAP_FROM_API[k] || k;
                out[htmlKey] = v;
            }
            // Compute internal keys
            if (!out.ownername) out.ownername = pickOwnerName(out);
            const costar = (out.costarid || '').toString().trim();
            const addressKey = computeAddressKey(out);
            out._addressKey = addressKey;
            out._id = costar ? `c:${costar}` : `a:${addressKey}`;
            out._uniqueKey = out._id;
            out._dbId = row.id; // Store the database ID
            out._completed = row.completed || false;
            return out;
        }

        const STATUS_TYPES = ["", "Still Active", "Still Expired", "Sold", "Under Contract", "Unknown", "Demolished", "Withdrawn"];
        const OWNER_TYPES = ["", "Institutional", "Corporate", "Private Equity", "Mom & Pop", "Individual", "Unknown", "N/A"];

        const PROPERTY_TYPE_EMOJIS = {
            'Bank': 'ðŸ¦',
            'Coffee': 'ðŸµ',
            'Fast Food': 'ðŸ”',
            'Restaurant': 'ðŸ½ï¸',
            'Department': 'ðŸ¬',
            'Supermarket': 'ðŸ›’',
            'Pharmacy': 'ðŸ’Š',
            'Auto Repair': 'ðŸš—',
            'Gas Station': 'â›½',
            'Truck Stop': 'ðŸ›»',
            'Car Wash': 'ðŸ«§',
            'Gym': 'ðŸƒâ€â™‚ï¸',
            'Big Box': 'ðŸ“¦',
            'Center': 'Center'
        };

        const DEFAULT_COLUMNS = [
            { id: 'imageurl', label: 'Image', width: '150px', visible: true },
            { id: 'tenant', label: 'Tenant', width: '180px', visible: true },
            { id: 'address', label: 'Address', width: '240px', visible: true },
            { id: 'city', label: 'City', width: '140px', visible: true },
            { id: 'state', label: 'State', width: '70px', visible: true },
            { id: 'price', label: 'Price', width: '120px', visible: true },
            { id: 'daysonmarket', label: 'DOM', width: '80px', visible: true },
            { id: 'status', label: 'Status', width: '140px', visible: true },
            { id: 'ownername', label: 'Owner', width: '220px', visible: true },
            { id: 'ownerphone', label: 'Phone 1', width: '150px', visible: false },
            { id: 'ownerphone2', label: 'Phone 2', width: '150px', visible: false },
            { id: 'owneremail', label: 'Email', width: '220px', visible: false },
            { id: 'ownerfullname', label: 'Owner Full Name', width: '200px', visible: false },
            { id: 'otherowners', label: 'Other Owners', width: '200px', visible: false },
            { id: 'buildingname', label: 'Building Name', width: '220px', visible: false },
            { id: 'costarid', label: 'CoStar ID', width: '120px', visible: true },
            { id: 'propertytype', label: 'Type', width: '140px', visible: true },
            { id: 'contactnotes', label: 'Contact Notes', width: '260px', visible: false },
            { id: 'notes', label: 'Internal Notes', width: '260px', visible: false },
        ];

        let currentView = 'table';
        let currentViewIndex = 0;
        let currentTab = 'incomplete';
        let sortColumn = null;
        let sortDirection = 'asc'; // 'asc' or 'desc'
        let searchQuery = '';
        let selectedRowKey = null; // To highlight selected row
        // IndexedDB constants (moved from global scope)
        const DB_NAME = 'CoStarConsoleDB';
        const DB_VERSION = 1;
        const STORE_PROPERTIES = 'properties';
        const STORE_KV = 'kv';
        let dbPromise = openDb();
        // Data
        let properties = [];
        let filteredProperties = [];
        let columnConfig = [];
        // Filtering
        let columnFilters = {}; // { colId: ['val1', 'val2'] }
        window.addEventListener('DOMContentLoaded', () => {
            init().catch(err => {
                console.error(err);
                showToast('Failed to initialize app. Check console.', 'error');
            });
            setupDragDrop();
        });

        async function init() {
            await loadConfig();
            await loadDataFromDb();
            if (!properties.length) {
                const loaded = await tryBootstrapFromDefaultWorkbook();
                if (loaded) {
                    hideUpload();
                }
            }
            updateColumnConfigFromData();
            renderAll();
        }

        function openDb() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onupgradeneeded = () => {
                    const db = req.result;
                    if (!db.objectStoreNames.contains(STORE_PROPERTIES)) {
                        db.createObjectStore(STORE_PROPERTIES, { keyPath: '_id' });
                    }
                    if (!db.objectStoreNames.contains(STORE_KV)) {
                        db.createObjectStore(STORE_KV, { keyPath: 'key' });
                    }
                };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        async function kvGet(key) {
            const db = await dbPromise;
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_KV, 'readonly');
                const store = tx.objectStore(STORE_KV);
                const req = store.get(key);
                req.onsuccess = () => resolve(req.result ? req.result.value : undefined);
                req.onerror = () => reject(req.error);
            });
        }

        async function kvSet(key, value) {
            const db = await dbPromise;
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_KV, 'readwrite');
                const store = tx.objectStore(STORE_KV);
                store.put({ key, value });
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        // --- API FUNCTIONS ---
        async function apiGetAllProperties() {
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error(`API error: ${res.status}`);
                const rows = await res.json();
                return rows.map(fromApiFormat);
            } catch (err) {
                console.error('Failed to fetch properties:', err);
                return [];
            }
        }

        async function apiCreateProperty(prop) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(toApiFormat(prop))
                });
                if (!res.ok) throw new Error(`API error: ${res.status}`);
                return await res.json();
            } catch (err) {
                console.error('Failed to create property:', err);
                return null;
            }
        }

        async function apiUpdateProperty(dbId, prop) {
            try {
                const res = await fetch(`${API_URL}?id=${dbId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(toApiFormat(prop))
                });
                if (!res.ok) throw new Error(`API error: ${res.status}`);
                return await res.json();
            } catch (err) {
                console.error('Failed to update property:', err);
                return null;
            }
        }

        async function apiDeleteProperty(dbId) {
            try {
                const res = await fetch(`${API_URL}?id=${dbId}`, { method: 'DELETE' });
                if (!res.ok) throw new Error(`API error: ${res.status}`);
                return true;
            } catch (err) {
                console.error('Failed to delete property:', err);
                return false;
            }
        }

        async function apiClearAll() {
            // Delete all properties one by one
            const toDelete = properties.filter(p => p._dbId);
            for (const p of toDelete) {
                await apiDeleteProperty(p._dbId);
            }
        }

        async function loadConfig() {
            const saved = await kvGet('columnConfig');
            columnConfig = saved ? saved : JSON.parse(JSON.stringify(DEFAULT_COLUMNS));
        }

        async function saveConfig() {
            await kvSet('columnConfig', columnConfig);
            renderAll();
        }

        function resetColumns() {
            if (!confirm("Reset columns?")) return;
            kvSet('columnConfig', undefined).catch(() => { });
            columnConfig = JSON.parse(JSON.stringify(DEFAULT_COLUMNS));
            saveConfig().catch(() => { });
        }

        async function loadDataFromDb() {
            properties = await apiGetAllProperties();
            if (properties.length) {
                hideUpload();
            }
        }

        let pendingSaves = new Map(); // Track pending saves by _uniqueKey

        function schedulePersist() {
            // No-op for API mode - saves are immediate per property
        }

        async function saveData(immediate = false) {
            // For API mode, we handle saves per-property
            // This is called after bulk operations, so we sync new properties without _dbId
            const newProps = properties.filter(p => !p._dbId);
            for (const p of newProps) {
                const result = await apiCreateProperty(p);
                if (result) {
                    p._dbId = result.id;
                }
            }
            updateStats();
        }

        function updateStats() {
            const incomplete = properties.filter(p => isIncomplete(p)).length;
            const complete = properties.length - incomplete;

            const incEl = document.getElementById('incomplete-count');
            const compEl = document.getElementById('complete-count');
            const totalEl = document.getElementById('total-count');
            const showEl = document.getElementById('showing-count');

            if (incEl) incEl.innerText = incomplete;
            if (compEl) compEl.innerText = complete;
            if (totalEl) totalEl.innerText = properties.length;
            if (showEl) showEl.innerText = filteredProperties.length;
        }

        function isIncomplete(p) {
            // Property is complete if explicitly marked complete
            if (p._completed === true) return false;

            const name = (p.ownername || '').toString().trim();
            const phone = (p.ownerphone || '').toString().trim();
            const email = (p.owneremail || '').toString().trim();

            // Incomplete if missing name AND (phone or email)
            // (If we have a name plus at least one contact method, it's "complete enough" for now)
            return !name || (!phone && !email);
        }

        function normalizeKey(key) {
            if (!key) return '';
            return key.toString().trim().toLowerCase().replace(/[^a-z0-9]/g, '');
        }

        function updateColumnConfigFromData() {
            if (properties.length === 0) return;
            const foundKeys = new Set();
            properties.forEach(p => Object.keys(p).forEach(k => foundKeys.add(k)));
            let updated = false;
            foundKeys.forEach(key => {
                if (key.startsWith('_')) return;
                const exists = columnConfig.find(c => c.id === key);
                if (!exists) {
                    const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()).trim() || key.toUpperCase();
                    columnConfig.push({ id: key, label: label, width: '120px', visible: false });
                    updated = true;
                }
            });
            if (updated) saveConfig().catch(() => { });
        }

        const fileInput = document.getElementById('file-input');
        fileInput.addEventListener('change', handleFiles);

        function setupDragDrop() {
            const dz = document.getElementById('drop-area');
            dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('ring-4', 'ring-blue-300', 'scale-105'); });
            dz.addEventListener('dragleave', () => dz.classList.remove('ring-4', 'ring-blue-300', 'scale-105'));
            dz.addEventListener('drop', (e) => {
                e.preventDefault(); dz.classList.remove('ring-4', 'ring-blue-300', 'scale-105');
                processFiles(Array.from(e.dataTransfer.files));
            });
        }

        function handleFiles(e) { processFiles(Array.from(e.target.files)).catch(err => console.error(err)); }

        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error);
                reader.readAsArrayBuffer(file);
            });
        }

        async function processFiles(files) {
            if (!files.length) return;
            let totalAdded = 0;
            let totalMerged = 0;

            const clearData = document.getElementById('clear-data-checkbox').checked;
            if (clearData) {
                await apiClearAll();
                properties = [];
                columnConfig = JSON.parse(JSON.stringify(DEFAULT_COLUMNS));
            }

            for (const file of files) {
                try {
                    const ab = await readFileAsArrayBuffer(file);
                    const wb = XLSX.read(ab, { type: 'array' });
                    const ws = wb.Sheets['Master'] || wb.Sheets[wb.SheetNames[0]];
                    const rawData = XLSX.utils.sheet_to_json(ws, { defval: "" });
                    const stats = mergeData(rawData);
                    totalAdded += stats.added;
                    totalMerged += stats.merged;
                } catch (err) {
                    console.error('Error processing file:', err);
                    showToast('Error reading file. Check console for details.', 'error');
                }
            }

            hideUpload();
            updateColumnConfigFromData();
            saveData(true);
            renderAll();
            const clearMsg = clearData ? ' (cleared existing data)' : '';
            showToast(`Imported ${totalAdded} new, merged ${totalMerged} duplicates${clearMsg}`, 'success');
        }

        const HEADER_MAP = {
            image: 'imageurl',
            imageurl: 'imageurl',
            address: 'address',
            buildingname: 'buildingname',
            city: 'city',
            state: 'state',
            zip: 'zip',
            postalcode: 'zip',
            tenant: 'tenant',
            status: 'status',
            price: 'price',
            newsalestatus: 'newsalestatus',
            currentprice: 'currentprice',
            daysonmarket: 'daysonmarket',
            analysisnotes: 'analysisnotes',
            changedate: 'changedate',
            om: 'om',
            costarid: 'costarid',
            phone1: 'ownerphone',
            phone2: 'ownerphone2',
            email: 'owneremail',
            ownercontact: 'ownercontact',
            ownerfullname: 'ownerfullname',
            owner: 'ownerentity',
            otherowners: 'otherowners',
            owneraddress: 'owneraddress',
            contactnotes: 'contactnotes',
            notes: 'notes',
        };

        function computeAddressKey(row) {
            const addr = (row.address || "").toString().toLowerCase().trim();
            const city = (row.city || "").toString().toLowerCase().trim();
            const state = (row.state || "").toString().toLowerCase().trim();
            const zip = (row.zip || "").toString().toLowerCase().trim();
            return `${addr}|${city}|${state}|${zip}`;
        }

        function pickOwnerName(row) {
            const candidates = [row.ownername, row.ownercontact, row.ownerfullname, row.ownerentity, row.owner];
            for (const c of candidates) {
                if (c !== undefined && c !== null && String(c).trim() !== '') return String(c).trim();
            }
            return '';
        }

        function normalizeIncomingRow(raw) {
            const out = {};
            for (const k of Object.keys(raw)) {
                if (!k) continue;
                const nk = normalizeKey(k);
                if (!nk) continue;
                const mapped = HEADER_MAP[nk] || nk;
                const v = raw[k];
                out[mapped] = v;
            }

            if (!out.imageurl && out.image) out.imageurl = out.image;
            if (!out.ownerphone && out.phone) out.ownerphone = out.phone;
            if (!out.owneremail && out.emailaddress) out.owneremail = out.emailaddress;
            if (!out.ownername) out.ownername = pickOwnerName(out);

            const costar = (out.costarid || '').toString().trim();
            const addressKey = computeAddressKey(out);
            out._addressKey = addressKey;
            out._id = costar ? `c:${costar}` : `a:${addressKey}`;
            out._uniqueKey = out._id;

            return out;
        }

        function mergeData(newRows) {
            let addedCount = 0;
            let mergedCount = 0;

            const byId = new Map(properties.map(p => [p._id, p]));
            const byAddress = new Map(properties.filter(p => p._addressKey).map(p => [p._addressKey, p]));

            for (const raw of newRows) {
                const normalizedRow = normalizeIncomingRow(raw);
                const existing = byId.get(normalizedRow._id) || (normalizedRow._addressKey ? byAddress.get(normalizedRow._addressKey) : undefined);
                if (existing) {
                    for (const k of Object.keys(normalizedRow)) {
                        if (k.startsWith('_')) continue;
                        if (existing[k] === undefined || existing[k] === null || String(existing[k]).trim() === '') {
                            if (normalizedRow[k] !== undefined && normalizedRow[k] !== null && String(normalizedRow[k]).trim() !== '') {
                                existing[k] = normalizedRow[k];
                            }
                        }
                    }
                    if (!existing.ownername) existing.ownername = pickOwnerName(existing);
                    if (!existing._addressKey) existing._addressKey = normalizedRow._addressKey;
                    mergedCount++;
                } else {
                    const p = { ...normalizedRow };
                    if (p.status === '' && p.newsalestatus) p.status = p.newsalestatus;
                    if (p.price === '' && p.currentprice) p.price = p.currentprice;
                    if (!p.ownername) p.ownername = pickOwnerName(p);
                    properties.push(p);
                    byId.set(p._id, p);
                    if (p._addressKey) byAddress.set(p._addressKey, p);
                    addedCount++;
                }
            }

            return { added: addedCount, merged: mergedCount };
        }

        function hideUpload() { document.getElementById('upload-overlay').style.display = 'none'; }

        function setView(view) {
            currentView = view;

            // Update Table Button
            const tableBtn = document.getElementById('view-table');
            tableBtn.classList.toggle('active', view === 'table');
            tableBtn.classList.toggle('bg-white', view === 'table');
            tableBtn.classList.toggle('text-gray-900', view === 'table');
            tableBtn.classList.toggle('text-gray-400', view !== 'table');

            // Update Cards Button
            const cardsBtn = document.getElementById('view-cards');
            cardsBtn.classList.toggle('active', view === 'cards');
            cardsBtn.classList.toggle('bg-white', view === 'cards');
            cardsBtn.classList.toggle('text-gray-900', view === 'cards');
            cardsBtn.classList.toggle('text-gray-400', view !== 'cards');

            document.getElementById('table-view').classList.toggle('hidden', view !== 'table');
            document.getElementById('cards-view').classList.toggle('hidden', view !== 'cards');
            renderAll();
        }

        function setTab(tab) {
            currentTab = tab;

            const incBtn = document.getElementById('tab-incomplete');
            incBtn.classList.toggle('active', tab === 'incomplete');
            incBtn.classList.toggle('bg-white', tab === 'incomplete');
            incBtn.classList.toggle('text-gray-900', tab === 'incomplete');
            incBtn.classList.toggle('text-gray-500', tab !== 'incomplete');

            const comBtn = document.getElementById('tab-complete');
            comBtn.classList.toggle('active', tab === 'complete');
            comBtn.classList.toggle('bg-white', tab === 'complete');
            comBtn.classList.toggle('text-gray-900', tab === 'complete');
            comBtn.classList.toggle('text-gray-500', tab !== 'complete');

            renderAll();
        }

        function handleSearch() {
            searchQuery = document.getElementById('search-input').value.toLowerCase();
            renderAll();
        }

        function reloadGrid() {
            renderAll();
            showToast('Refreshed', 'success');
        }

        function getFilteredProperties() {
            let result = properties;

            // 1. Tab Filtering
            if (currentTab === 'incomplete') {
                result = result.filter(p => isIncomplete(p));
            } else {
                result = result.filter(p => !isIncomplete(p));
            }

            // 2. Global Search
            if (searchQuery) {
                result = result.filter(p => {
                    const searchFields = ['address', 'city', 'state', 'ownername', 'ownerphone', 'owneremail', 'tenant', 'buildingname', 'agent', 'notes', 'costarid', 'propertytype', 'status'];
                    return searchFields.some(f => (p[f] || '').toString().toLowerCase().includes(searchQuery));
                });
            }

            // 3. Column Filters
            Object.keys(columnFilters).forEach(colId => {
                const activeValues = columnFilters[colId];
                if (activeValues && activeValues.length > 0) {
                    result = result.filter(p => {
                        let val = p[colId];
                        if (val === undefined || val === null || val === '') {
                            return activeValues.includes('(Missing)');
                        }
                        return activeValues.includes(String(val));
                    });
                }
            });

            // 4. Sort
            if (sortColumn) {
                result = [...result].sort((a, b) => {
                    let valA = a[sortColumn] || '';
                    let valB = b[sortColumn] || '';

                    const numericFields = ['price', 'currentprice', 'daysonmarket', 'withdrawaloccurrences', 'pricereductions'];
                    if (numericFields.includes(sortColumn)) {
                        valA = parseFloat(String(valA).replace(/[^0-9.-]/g, '')) || 0;
                        valB = parseFloat(String(valB).replace(/[^0-9.-]/g, '')) || 0;
                    } else {
                        valA = String(valA).toLowerCase();
                        valB = String(valB).toLowerCase();
                    }

                    if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            return result;
        }

        function handleSort(colId) {
            if (sortColumn === colId) {
                // Toggle direction
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = colId;
                sortDirection = 'asc';
            }
            renderAll();
        }



        function formatValue(val, key) {
            if (val === undefined || val === null || val === '') return "";
            const s = val.toString();

            if (key === 'imageurl' && s) {
                return `<div class="w-12 h-12 rounded-lg bg-gray-100 overflow-hidden flex items-center justify-center">
                    <img src="${s}" class="w-full h-full object-cover" onerror="this.parentElement.innerHTML='<i class=\\'fa-regular fa-image text-gray-300\\'></i>'">
                </div>`;
            }
            if (key === 'price' || key === 'currentprice') {
                const num = parseFloat(s.toString().replace(/[^0-9.-]/g, ''));
                if (!isNaN(num)) return '$' + num.toLocaleString();
            }
            return s;
        }

        // --- AG GRID SETUP ---
        let gridApi;



        const gridOptions = {
            rowData: [],
            defaultColDef: {
                sortable: true,
                filter: true,
                resizable: true,
                flex: 1,
                minWidth: 100
            },
            columnDefs: [
                {
                    field: "imageurl",
                    headerName: "",
                    width: 150,
                    minWidth: 150,
                    maxWidth: 150,
                    flex: 0,
                    cellRenderer: params => {
                        const url = params.value;
                        if (!url) return `<div class="w-full h-24 bg-slate-800 rounded-lg flex items-center justify-center text-slate-700 border border-slate-700/50"><i class="fa-regular fa-image text-3xl"></i></div>`;
                        return `<div class="w-full h-24 bg-slate-800 rounded-lg overflow-hidden border border-slate-700/50 shadow-lg"><img src="${url}" class="w-full h-full object-cover"></div>`;
                    }
                },
                { field: "tenant", headerName: "Tenant", minWidth: 150 },
                { field: "address", headerName: "Address", minWidth: 180, flex: 2 },
                { field: "city", headerName: "City", width: 120 },
                { field: "state", headerName: "State", width: 80, maxWidth: 80 },
                { field: "price", headerName: "Price", valueFormatter: p => p.value ? '$' + parseFloat(String(p.value).replace(/[^0-9.]/g, '')).toLocaleString() : '' },
                {
                    field: "status", headerName: "Status", width: 120, cellRenderer: params => {
                        const val = params.value || '';
                        let colorClass = "bg-gray-100/10 text-gray-400";
                        if (['Sold', 'Under Contract', 'Still Active'].includes(val)) colorClass = "bg-green-500/20 text-green-400";
                        if (['Withdrawn', 'Demolished', 'Still Expired'].includes(val)) colorClass = "bg-red-500/20 text-red-400";
                        return `<span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider ${colorClass}">${val}</span>`;
                    }
                },
                { field: "ownername", headerName: "Owner", minWidth: 150 },
                { field: "daysonmarket", headerName: "DOM", width: 80, maxWidth: 80 },
                {
                    field: "propertytype",
                    headerName: "Type",
                    width: 130,
                    cellRenderer: params => {
                        if (!params.value) return '';
                        const emoji = PROPERTY_TYPE_EMOJIS[params.value] || '';
                        // Special handling for 'Center' which has no emoji in the spec but was listed as 'Center'
                        if (params.value === 'Center') return '<span class="px-2 py-1 bg-gray-100 rounded text-xs font-bold text-gray-600">Center</span>';

                        return `<span class="text-base" title="${params.value}">${emoji} <span class="text-xs font-medium text-gray-600 ml-1">${params.value}</span></span>`;
                    }
                },
                {
                    headerName: "Actions",
                    width: 90,
                    maxWidth: 90,
                    minWidth: 90,
                    flex: 0,
                    cellRenderer: params => {
                        if (!params.data) return '';
                        return `<button class="text-blue-400 hover:text-blue-300 px-2" onclick="openDrawer(window.currentRowData['${params.data._uniqueKey}'])"><i class="fa-solid fa-pen-to-square"></i></button>`;
                    }
                }
            ],
            rowSelection: 'single',
            rowHeight: 120,
            onRowClicked: event => openDrawer(event.data),
            getRowId: params => params.data._uniqueKey || Math.random().toString()
        };

        function initAgGrid() {
            const gridDiv = document.querySelector('#myGrid');
            gridApi = agGrid.createGrid(gridDiv, gridOptions);
            gridDiv.classList.add('ag-theme-quartz');
        }

        // --- LAYOUT LOGIC ---
        function toggleLayout(mode) {
            document.getElementById('app-body').classList.remove('layout-standard', 'layout-widescreen');
            document.getElementById('app-body').classList.add(`layout-${mode}`);

            document.getElementById('layout-standard-btn').className = mode === 'standard'
                ? 'px-3 py-1.5 rounded-md text-xs font-bold transition-all text-gray-900 bg-white shadow-sm'
                : 'px-3 py-1.5 rounded-md text-xs font-bold transition-all text-gray-500 hover:text-gray-700';

            document.getElementById('layout-widescreen-btn').className = mode === 'widescreen'
                ? 'px-3 py-1.5 rounded-md text-xs font-bold transition-all text-gray-900 bg-white shadow-sm'
                : 'px-3 py-1.5 rounded-md text-xs font-bold transition-all text-gray-500 hover:text-gray-700';

            closeDrawer();
        }

        // Overwrite renderAll to update Grid
        function renderAll() {
            filteredProperties = getFilteredProperties();
            updateStats();

            // Expose for global access if needed (helper for string onclicks)
            window.currentRowData = {};
            filteredProperties.forEach(p => window.currentRowData[p._uniqueKey] = p);

            if (currentView === 'table') {
                if (gridApi) {
                    gridApi.setGridOption('rowData', filteredProperties);
                } else {
                    initAgGrid();
                    gridApi.setGridOption('rowData', filteredProperties);
                }
            } else {
                renderCards();
            }
        }

        function renderCards() {
            const container = document.getElementById('card-container');
            container.innerHTML = '';

            filteredProperties.forEach((row, idx) => {
                const card = document.createElement('div');
                card.className = 'property-card cursor-pointer';
                card.onclick = () => openDrawer(row);

                const imgUrl = row.imageurl || '';
                const price = formatValue(row.price, 'price') || '$0';
                const dom = row.daysonmarket || '-';
                const isIncomp = isIncomplete(row);

                card.innerHTML = `
                     <div class="relative bg-white rounded-xl overflow-hidden border border-gray-200 shadow-sm hover:shadow-md transition-all">
                         <div class="h-48 bg-gray-100 overflow-hidden relative border-b border-gray-100">
                             ${imgUrl
                        ? `<img src="${imgUrl}" class="w-full h-full object-cover">`
                        : `<div class="w-full h-full flex items-center justify-center text-gray-300"><i class="fa-regular fa-image text-3xl"></i></div>`
                    }
                             ${isIncomp
                        ? `<span class="absolute top-3 right-3 badge-incomplete text-xs font-bold uppercase px-2 py-1 rounded-full shadow bg-white/90 text-gray-600 backdrop-blur-sm">Needs Research</span>`
                        : `<span class="absolute top-3 right-3 badge-complete text-xs font-bold uppercase px-2 py-1 rounded-full shadow bg-emerald-500 text-white backdrop-blur-sm">Done</span>`
                    }
                             <div class="absolute bottom-3 left-3">
                                 <span class="bg-slate-900/90 backdrop-blur-md text-white text-xs font-bold px-3 py-1.5 rounded-lg border border-white/10 shadow-lg">${price}</span>
                             </div>
                         </div>
                         <div class="p-4">
                             <h3 class="font-bold text-slate-800 text-lg truncate mb-1" title="${row.buildingname || row.address || 'Unknown'}">${row.buildingname || row.address || 'Unknown'}</h3>
                             <p class="text-[11px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1.5"><i class="fa-solid fa-location-dot text-slate-300"></i> ${row.city || ''}${row.state ? `, ${row.state}` : ''}</p>
                             
                             <div class="mt-4 pt-3 border-t border-slate-100 flex items-center justify-between text-xs font-medium text-slate-500">
                                 <div class="flex flex-col">
                                    <span class="text-[10px] text-slate-300 uppercase font-bold tracking-wider">DOM</span>
                                    <span class="text-slate-700 font-bold">${dom}</span>
                                 </div>
                                 <div class="flex flex-col items-end">
                                    <span class="text-[10px] text-slate-300 uppercase font-bold tracking-wider">Owner</span>
                                    <span class="text-slate-700 font-bold max-w-[120px] truncate" title="${row.ownername || 'N/A'}">${row.ownername || 'N/A'}</span>
                                 </div>
                             </div>
                         </div>
                     </div>
                 `;
                container.appendChild(card);
            });

            if (filteredProperties.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-24 text-gray-400">
                        <i class="fa-regular fa-folder-open text-6xl mb-4"></i>
                        <p class="font-medium text-xl">No properties found</p>
                    </div>
                `;
            }
        }

        // --- SIDEBAR LOGIC (TWO PANELS) ---
        function openDrawer(row) {
            selectedRowKey = row._uniqueKey;
            tempDrawerData = { ...row };
            currentViewIndex = filteredProperties.findIndex(p => p._uniqueKey === row._uniqueKey);

            renderAll();
            renderDrawerContent();
            updateNavButtons();

            document.getElementById('sidebar-overlay').classList.remove('hidden');
            // Add active class to trigger slide-in
            setTimeout(() => {
                document.getElementById('sidebar-visuals').classList.add('active');
                document.getElementById('sidebar-inputs').classList.add('active');
                document.getElementById('app-body').classList.add('sidebar-visible');
            }, 10);
        }

        // --- NEW DRAWER FUNCTIONS ---
        function toggleCompletedState() {
            if (!tempDrawerData) return;
            const isComp = !isIncomplete(tempDrawerData);
            tempDrawerData._completed = !isComp;

            // Re-render only buttons/sidebar UI
            renderDrawerContent();
        }

        function renderDrawerContent() {
            const leftPanel = document.getElementById('sidebar-visuals-content');
            const rightPanel = document.getElementById('sidebar-inputs-content');
            const headerPanel = document.getElementById('sidebar-header');

            if (leftPanel) leftPanel.innerHTML = '';
            if (rightPanel) rightPanel.innerHTML = '';

            const row = tempDrawerData;
            const isComplete = !isIncomplete(row);

            // Update Header
            if (headerPanel) {
                headerPanel.innerHTML = `
                    <div class="flex items-center gap-2">
                        <button onclick="closeDrawer()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-400 transition-colors">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                        <div class="flex items-center gap-1.5 ml-1 border-l border-gray-200 pl-3">
                            <button id="btn-prev" onclick="navigateRow(-1)" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-500 transition-all ${currentViewIndex <= 0 ? 'opacity-30 pointer-events-none' : ''}">
                                <i class="fa-solid fa-chevron-left text-xs"></i>
                            </button>
                            <span class="text-[11px] font-bold text-gray-400 uppercase tracking-wider w-16 text-center">
                                <span class="text-gray-900">${currentViewIndex + 1}</span> / ${filteredProperties.length}
                            </span>
                            <button id="btn-next" onclick="navigateRow(1)" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-500 transition-all ${currentViewIndex >= filteredProperties.length - 1 ? 'opacity-30 pointer-events-none' : ''}">
                                <i class="fa-solid fa-chevron-right text-xs"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <button onclick="openCoStarPage()" title="Open CoStar" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-blue-50 border border-transparent hover:border-blue-100 transition-all group grayscale hover:grayscale-0">
                            <img src="https://companieslogo.com/img/orig/CSGP-5955041b.png?t=1720244491" class="w-4 h-4 object-contain opacity-60 group-hover:opacity-100 transition-opacity">
                        </button>

                        <div class="h-6 w-px bg-gray-100"></div>

                        <div class="flex items-center" title="Toggle Completed">
                            <button onclick="toggleCompletedState()" id="complete-toggle-btn" 
                                class="w-8 h-4 rounded-full relative transition-all duration-300 ${isComplete ? 'bg-green-500' : 'bg-gray-200'}">
                                <div class="absolute top-0.5 left-0.5 w-3 h-3 bg-white rounded-full shadow-sm transition-transform duration-300 ${isComplete ? 'translate-x-4' : ''}"></div>
                            </button>
                        </div>

                        <button onclick="saveDrawer()" class="w-8 h-8 flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-sm transition-all shadow-blue-500/10" title="Save Changes">
                            <i class="fa-solid fa-floppy-disk text-xs"></i>
                        </button>
                    </div>
                `;
            }

            const imgUrl = row.imageurl || '';

            // Fix Address Format: No comma after state
            const cityStateZip = [row.city, row.state, row.zip].filter(Boolean).join(' ');
            const fullAddress = row.address ? `${row.address}, ${cityStateZip}` : cityStateZip;
            const mapQuery = encodeURIComponent(fullAddress);

            // ========== LEFT PANEL (Property Details & Financials) ==========
            if (leftPanel) {
                leftPanel.innerHTML = `
                    <div class="h-full flex flex-col overflow-hidden">
                        <div class="p-4 flex-none space-y-4">
                            <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm">
                                <h2 class="text-base font-bold text-gray-900 truncate" title="${row.buildingname || row.address || 'Unknown'}">${row.buildingname || row.address || 'Unknown Property'}</h2>
                                <p class="text-[11px] text-gray-500 flex items-center gap-1.5 mt-1 truncate">
                                    <i class="fa-solid fa-location-dot"></i>
                                    <span class="cursor-pointer hover:text-blue-600" onclick="copyToClipboard('${fullAddress.replace(/'/g, "\\'")}')">${fullAddress || 'No address'}</span>
                                </p>
                            </div>
                            
                            <div class="bg-gray-100 rounded-xl overflow-hidden border border-gray-200 shadow-sm h-52">
                                ${imgUrl
                        ? `<img src="${imgUrl}" class="w-full h-full object-cover">`
                        : `<div class="w-full h-full flex items-center justify-center text-gray-400"><i class="fa-regular fa-image text-3xl"></i></div>`
                    }
                            </div>
                            
                            <!-- Financials (Moved Here) -->
                            <div class="bg-blue-50/50 rounded-xl p-4 border border-blue-100 space-y-4 shadow-inner">
                                <h4 class="text-[10px] font-bold text-blue-600 uppercase tracking-widest flex items-center gap-2">
                                    <i class="fa-solid fa-chart-line"></i> Financials & Details
                                </h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="bg-white rounded-lg p-3 border border-blue-100 shadow-sm">
                                        <label class="input-label-compact">Price</label>
                                        <input id="field-price" class="input-field-compact font-bold text-blue-700" value="${row.price || ''}" onchange="updateDrawerField('price', this.value)">
                                    </div>
                                    <div class="bg-white rounded-lg p-3 border border-blue-100 shadow-sm">
                                        <label class="input-label-compact">Cap Rate (%)</label>
                                        <input id="field-caprate" class="input-field-compact font-bold text-blue-700" value="${row.caprate || ''}" onchange="updateDrawerField('caprate', this.value)">
                                    </div>
                                    <div class="bg-white rounded-lg p-3 border border-blue-100 shadow-sm">
                                        <label class="input-label-compact">DOM</label>
                                        <div class="text-lg font-bold mt-1 ${parseInt(row.daysonmarket) > 365 ? 'text-red-600' : 'text-gray-900'}">${row.daysonmarket || '-'}</div>
                                    </div>
                                    <div class="bg-white rounded-lg p-3 border border-blue-100 shadow-sm">
                                        <label class="input-label-compact">CoStar ID</label>
                                        <input id="field-costarid" class="input-field-compact" value="${row.costarid || ''}" onchange="updateDrawerField('costarid', this.value)">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Google Maps -->
                        <div class="px-4 pb-4">
                            <div class="bg-white rounded-xl overflow-hidden border border-gray-200 shadow-sm">
                                <div class="h-44">
                                    ${fullAddress
                        ? `<iframe src="https://maps.google.com/maps?q=${mapQuery}&t=k&z=17&ie=UTF8&iwloc=&output=embed" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy"></iframe>`
                        : `<div class="w-full h-full flex items-center justify-center bg-gray-100 text-gray-400"><i class="fa-solid fa-map text-2xl"></i></div>`
                    }
                                </div>
                                <a href="https://www.google.com/maps/search/?api=1&query=${mapQuery}" target="_blank"
                                    class="flex items-center justify-center gap-1.5 py-2 text-[11px] font-bold text-blue-600 hover:bg-blue-50 transition-colors border-t border-gray-100 uppercase tracking-wider">
                                    <i class="fa-solid fa-location-dot"></i> Open in Google Maps
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }

            // ========== RIGHT PANEL (Owner Data & General) ==========
            if (rightPanel) {
                const isComplete = !isIncomplete(row);
                rightPanel.innerHTML = `
                     <div class="flex flex-col h-full">
                        <!-- Quick Paste (Collapsible) -->
                        <details class="bg-slate-900 mb-4 rounded-xl shadow-inner border border-slate-800 group">
                            <summary class="p-3 cursor-pointer list-none flex items-center justify-between text-[10px] text-slate-400 font-bold uppercase tracking-widest hover:text-white transition-colors">
                                <span>Quick Property Import</span>
                                <i class="fa-solid fa-chevron-down transition-transform group-open:rotate-180"></i>
                            </summary>
                            <div class="p-3 pt-0">
                                <textarea id="address-paste" rows="1" placeholder="Paste data block here..." 
                                    class="w-full text-xs p-2.5 rounded-lg border-none bg-slate-800 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500 transition-all text-center" 
                                    onpaste="setTimeout(() => parseAddressPaste(), 100)"></textarea>
                            </div>
                        </details>

                        <div class="flex-1 space-y-4 pr-1">
                            <!-- General Info Section -->
                            <div class="bg-white p-3.5 rounded-xl border border-gray-200 shadow-sm">
                                <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                                    <i class="fa-solid fa-circle-info text-blue-500"></i> General Info
                                </h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="col-span-2">
                                        <label class="input-label-compact">Building Name / Title</label>
                                        <input id="field-buildingname" class="input-field-compact" value="${row.buildingname || ''}" onchange="updateDrawerField('buildingname', this.value)">
                                    </div>
                                    <div class="col-span-2">
                                        <label class="input-label-compact">Tenant</label>
                                        <input id="field-tenant" class="input-field-compact" value="${row.tenant || ''}" onchange="updateDrawerField('tenant', this.value)">
                                    </div>
                                    <div>
                                        <label class="input-label-compact">Status</label>
                                        <select id="field-status" class="input-field-compact" onchange="updateDrawerField('status', this.value)">
                                            ${STATUS_TYPES.map(t => `<option value="${t}" ${row.status === t ? 'selected' : ''}>${t}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="col-span-1">
                                        <label class="input-label-compact">Property Type</label>
                                        <select id="field-propertytype" class="input-field-compact" onchange="updateDrawerField('propertytype', this.value)">
                                            <option value="">(Select Type)</option>
                                            ${Object.keys(PROPERTY_TYPE_EMOJIS).map(k => {
                    const emoji = k === 'Center' ? '' : PROPERTY_TYPE_EMOJIS[k];
                    const display = k === 'Center' ? 'Center' : `${emoji} ${k}`;
                    return `<option value="${k}" ${row.propertytype === k ? 'selected' : ''}>${display}</option>`;
                }).join('')}
                                        </select>
                                    </div>
                                    <div class="col-span-2">
                                         <label class="input-label-compact">Image URL</label>
                                         <input id="field-imageurl" class="input-field-compact" value="${row.imageurl || ''}" onchange="updateDrawerField('imageurl', this.value)">
                                    </div>
                                </div>
                            </div>

                            <!-- Address Section -->
                            <div class="bg-white p-3.5 rounded-xl border border-gray-200 shadow-sm">
                                <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                                    <i class="fa-solid fa-location-dot text-blue-500"></i> Property Address
                                </h4>
                                <div class="grid grid-cols-6 gap-3">
                                    <div class="col-span-6">
                                        <label class="input-label-compact">Street Address</label>
                                        <input id="field-address" class="input-field-compact" value="${row.address || ''}" onchange="updateDrawerField('address', this.value)">
                                    </div>
                                    <div class="col-span-3">
                                        <label class="input-label-compact">City</label>
                                        <input id="field-city" class="input-field-compact" value="${row.city || ''}" onchange="updateDrawerField('city', this.value)">
                                    </div>
                                    <div class="col-span-1">
                                        <label class="input-label-compact">State</label>
                                        <input id="field-state" class="input-field-compact" value="${row.state || ''}" onchange="updateDrawerField('state', this.value)">
                                    </div>
                                    <div class="col-span-2">
                                        <label class="input-label-compact">Zip</label>
                                        <input id="field-zip" class="input-field-compact" value="${row.zip || ''}" onchange="updateDrawerField('zip', this.value)">
                                    </div>
                                </div>
                            </div>

                            <!-- Owner Info Section -->
                            <div class="bg-white p-3.5 rounded-xl border border-gray-200 shadow-sm">
                                <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                                    <i class="fa-solid fa-user-tie text-blue-500"></i> Owner Data
                                </h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="col-span-1">
                                        <label class="input-label-compact">Contact Name</label>
                                        <input id="field-ownername" class="input-field-compact" value="${row.ownername || ''}" onchange="updateDrawerField('ownername', this.value)">
                                    </div>
                                    <div class="col-span-1">
                                        <label class="input-label-compact">Owner Full Name</label>
                                        <input id="field-ownerfullname" class="input-field-compact" value="${row.ownerfullname || ''}" onchange="updateDrawerField('ownerfullname', this.value)">
                                    </div>
                                    <div>
                                        <label class="input-label-compact">Phone 1</label>
                                        <input id="field-ownerphone" class="input-field-compact" value="${row.ownerphone || ''}" onchange="updateDrawerField('ownerphone', this.value)">
                                    </div>
                                    <div>
                                        <label class="input-label-compact">Phone 2</label>
                                        <input id="field-ownerphone2" class="input-field-compact" value="${row.ownerphone2 || ''}" onchange="updateDrawerField('ownerphone2', this.value)">
                                    </div>
                                    <div class="col-span-2">
                                        <label class="input-label-compact">Email</label>
                                        <input id="field-owneremail" class="input-field-compact" value="${row.owneremail || ''}" onchange="updateDrawerField('owneremail', this.value)">
                                    </div>
                                    <div class="col-span-2">
                                        <label class="input-label-compact text-red-700">Owner Entity</label>
                                        <div class="flex gap-2">
                                            <input id="field-ownerentity" class="input-field-compact bg-red-50 border-red-200 text-red-900 placeholder-red-300 focus:ring-red-500 focus:border-red-500" value="${row.ownerentity || ''}" onchange="updateDrawerField('ownerentity', this.value)">
                                            
                                            <button onclick="handleBusinessSearch('${(row.ownerentity || '').replace(/'/g, "\\'")}')" 
                                                title="Search Entity in SOS Database (Copies to Clipboard)"
                                                class="px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 border border-red-200 rounded-md transition-colors flex items-center justify-center">
                                                <i class="fa-solid fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-span-2">
                                        <label class="input-label-compact text-red-700">Owner Address</label>
                                        <input id="field-owneraddress" class="input-field-compact bg-red-50 border-red-200 text-red-900 placeholder-red-300 focus:ring-red-500 focus:border-red-500" value="${row.owneraddress || ''}" onchange="updateDrawerField('owneraddress', this.value)">
                                    </div>
                                    <div class="col-span-2">
                                        <label class="input-label-compact">Other Owners / Partners</label>
                                        <input id="field-otherowners" class="input-field-compact" value="${row.otherowners || ''}" onchange="updateDrawerField('otherowners', this.value)">
                                    </div>
                                </div>
                            </div>

                            <!-- Notes -->
                            <div class="grid grid-cols-1 gap-4 pb-4">
                                <div class="bg-white p-3.5 rounded-xl border border-gray-200 shadow-sm transition-all hover:border-blue-200">
                                    <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2 flex items-center gap-2">
                                        <i class="fa-solid fa-note-sticky text-blue-500"></i> Internal Notes
                                    </h4>
                                    <textarea id="field-notes" class="input-field-compact min-h-[50px] bg-slate-50" onchange="updateDrawerField('notes', this.value)">${row.notes || ''}</textarea>
                                </div>
                                <div class="bg-white p-3.5 rounded-xl border border-gray-200 shadow-sm transition-all hover:border-amber-200">
                                    <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2 flex items-center gap-2">
                                        <i class="fa-solid fa-address-book text-amber-500"></i> Contact Notes
                                    </h4>
                                    <textarea id="field-contactnotes" class="input-field-compact min-h-[50px] bg-amber-50/30" onchange="updateDrawerField('contactnotes', this.value)">${row.contactnotes || ''}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

            }
        }

        // --- ADDRESS PARSER ---
        function parseAddressPaste() {
            const textarea = document.getElementById('address-paste');
            const raw = textarea.value.trim();
            if (!raw) return;

            // Clean up the input - remove parentheses, extra spaces
            let cleaned = raw.replace(/^\(|\)$/g, '').trim();

            // Common state abbreviations
            const stateAbbreviations = ['AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA', 'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD', 'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ', 'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC', 'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY', 'DC'];

            // Patterns to try
            // Pattern 1: Full address "123 Main St, City, ST 12345"
            // Pattern 2: Street only "123 Main St"
            // Pattern 3: City, State Zip "City, ST 12345"

            let address = '';
            let city = '';
            let state = '';
            let zip = '';

            // Try to find zip code
            const zipMatch = cleaned.match(/\b(\d{5}(?:-\d{4})?)\b/);
            if (zipMatch) {
                zip = zipMatch[1];
                cleaned = cleaned.replace(zipMatch[0], '').trim();
            }

            // Try to find state abbreviation
            const stateRegex = new RegExp(`\\b(${stateAbbreviations.join('|')})\\b`, 'i');
            const stateMatch = cleaned.match(stateRegex);
            if (stateMatch) {
                state = stateMatch[1].toUpperCase();
                cleaned = cleaned.replace(stateMatch[0], '').trim();
            }

            // Split remaining by comma
            const parts = cleaned.split(',').map(p => p.trim()).filter(p => p);

            if (parts.length >= 2) {
                // Assume: Address, City OR just City (if we already have address)
                address = parts[0];
                city = parts[1];
            } else if (parts.length === 1) {
                // Could be just address or just city
                // If it looks like a street address (has numbers at start), treat as address
                if (/^\d+/.test(parts[0])) {
                    address = parts[0];
                } else {
                    // Likely just a city
                    city = parts[0];
                }
            }

            // Update fields
            if (address) {
                document.getElementById('field-address').value = address;
                updateDrawerField('address', address);
            }
            if (city) {
                document.getElementById('field-city').value = city;
                updateDrawerField('city', city);
            }
            if (state) {
                document.getElementById('field-state').value = state;
                updateDrawerField('state', state);
            }
            if (zip) {
                document.getElementById('field-zip').value = zip;
                updateDrawerField('zip', zip);
            }

            // Clear paste area
            textarea.value = '';

            showToast('Address parsed successfully', 'success');
        }

        function updateDrawerField(key, value) {
            tempDrawerData[key] = value;
            if (['address', 'city', 'state', 'zip', 'costarid', 'ownercontact', 'ownerfullname', 'ownerentity', 'owner'].includes(key)) {
                tempDrawerData._addressKey = computeAddressKey(tempDrawerData);
                const costar = (tempDrawerData.costarid || '').toString().trim();
                const nextId = costar ? `c:${costar}` : `a:${tempDrawerData._addressKey}`;
                tempDrawerData._id = nextId;
                tempDrawerData._uniqueKey = nextId;
                if (!tempDrawerData.ownername) tempDrawerData.ownername = pickOwnerName(tempDrawerData);
            }
        }

        function autoResizeTextarea(el) {
            el.style.height = 'auto';
            el.style.height = Math.max(80, el.scrollHeight) + 'px';
        }

        function openCoStarPage() {
            const propertyId = tempDrawerData.costarid;
            if (!propertyId) {
                // If no ID, open home page and copy address
                const fullAddress = [tempDrawerData.address, tempDrawerData.city, tempDrawerData.state, tempDrawerData.zip].filter(Boolean).join(', ');
                if (fullAddress) {
                    copyToClipboard(fullAddress);
                    showToast('Address copied to clipboard', 'success');
                }
                window.open('https://product.costar.com/suiteapps/home', '_blank');
                return;
            }
            window.open(`https://product.costar.com/detail/lookup/${propertyId}/analytic-changes`, '_blank');
        }


        function toggleDrawerComplete(checked) {
            tempDrawerData._completed = checked;
        }

        // --- OBSOLETE: Replaced by toggleCompletedState ---
        // function toggleDrawerComplete(checked) { ... }

        async function saveDrawer() {
            const oldId = selectedRowKey;
            const nextId = tempDrawerData._uniqueKey;
            const existingIdx = properties.findIndex(p => p._uniqueKey === oldId);
            if (existingIdx === -1) return;
            if (!tempDrawerData.ownername) tempDrawerData.ownername = pickOwnerName(tempDrawerData);

            // Sync to API
            if (tempDrawerData._dbId) {
                await apiUpdateProperty(tempDrawerData._dbId, tempDrawerData);
            } else {
                const result = await apiCreateProperty(tempDrawerData);
                if (result) tempDrawerData._dbId = result.id;
            }

            if (oldId !== nextId) {
                properties.splice(existingIdx, 1);
                properties.push(tempDrawerData);
                selectedRowKey = nextId;
            } else {
                properties[existingIdx] = tempDrawerData;
            }
            renderAll();
            renderDrawerContent(); // Refresh the sidebar to show updated images/maps
            showToast("Changes saved", 'success');
        }

        function closeDrawer() {
            document.getElementById('sidebar-overlay').classList.add('hidden');
            document.getElementById('sidebar-visuals').classList.remove('active');
            document.getElementById('sidebar-inputs').classList.remove('active');
            document.getElementById('app-body').classList.remove('sidebar-visible');
            selectedRowKey = null;
            renderAll();
        }

        async function deleteProperty() {
            if (!confirm('Are you sure you want to delete this property?')) return;
            const idx = properties.findIndex(p => p._uniqueKey === selectedRowKey);
            if (idx > -1) {
                const prop = properties[idx];
                if (prop._dbId) {
                    await apiDeleteProperty(prop._dbId);
                }
                properties.splice(idx, 1);
                closeDrawer();
                showToast('Property deleted', 'error');
            }
        }

        async function deletePropertyByKey(key) {
            if (!confirm('Are you sure you want to delete this property?')) return;
            const idx = properties.findIndex(p => p._uniqueKey === key);
            if (idx > -1) {
                const prop = properties[idx];
                if (prop._dbId) {
                    await apiDeleteProperty(prop._dbId);
                }
                properties.splice(idx, 1);
                renderAll();
                showToast('Property deleted', 'error');
            }
        }

        // --- NAVIGATION LOGIC ---
        function navigateRow(dir) {
            const idx = properties.findIndex(p => p._uniqueKey === selectedRowKey);
            if (idx > -1) {
                properties[idx] = tempDrawerData;
                saveData(true);
            }

            currentViewIndex += dir;
            if (currentViewIndex < 0) currentViewIndex = 0;
            if (currentViewIndex >= filteredProperties.length) currentViewIndex = filteredProperties.length - 1;

            const row = filteredProperties[currentViewIndex];
            if (row) {
                selectedRowKey = row._uniqueKey;
                tempDrawerData = { ...row };
                renderDrawerContent();
                updateNavButtons();
            }
        }

        function updateNavButtons() {
            const prev = document.getElementById('btn-prev');
            const next = document.getElementById('btn-next');
            prev.disabled = currentViewIndex <= 0;
            next.disabled = currentViewIndex >= filteredProperties.length - 1;
            prev.classList.toggle('opacity-30', currentViewIndex <= 0);
            next.classList.toggle('opacity-30', currentViewIndex >= filteredProperties.length - 1);
        }

        // --- ACTIONS ---
        function toggleComplete(key) {
            const p = properties.find(p => p._uniqueKey === key);
            if (p) {
                p._completed = !p._completed;
                saveData(true);
                renderAll();
                showToast(p._completed ? 'Marked complete' : 'Marked incomplete', 'success');
            }
        }

        function skipProperty(key) {
            // Find current index in filtered list
            const currentIdx = filteredProperties.findIndex(p => p._uniqueKey === key);
            if (currentIdx < filteredProperties.length - 1) {
                openDrawer(filteredProperties[currentIdx + 1]);
            }
        }

        function callOwner(phone) {
            if (phone) {
                window.open(`tel:${phone}`, '_self');
            } else {
                showToast('No phone number available', 'error');
            }
        }

        // --- BUSINESS SEARCH INTEGRATION ---
        const stateData = {
            'ALABAMA': { sosUrl: 'https://arc-sos.state.al.us/CGI/CORPNAME.MBR/INPUT' },
            'ALASKA': { sosUrl: 'https://www.commerce.alaska.gov/cbp/main/search/entities' },
            'ARIZONA': {
                multi: true,
                links: [
                    { label: 'AZ Business Center', url: 'https://arizonabusinesscenter.azcc.gov/businesssearch', param: 'SearchTerm' },
                    { label: 'AZ Trademarks/Names', url: 'https://apps.azsos.gov/apps/tntp/se.html', param: 'SearchTerm' }
                ]
            },
            'ARKANSAS': { sosUrl: 'https://www.sos.arkansas.gov/corps/search_all.php' },
            'CALIFORNIA': { sosUrl: 'https://bizfileonline.sos.ca.gov/search/business' },
            'COLORADO': { sosUrl: 'https://www.sos.state.co.us/biz/BusinessEntityCriteriaExt.do?resetTransTyp=Y' },
            'CONNECTICUT': { sosUrl: 'https://www.concord-sots.ct.gov/CONCORD/online?sn=WebBusinessExternal' },
            'DELAWARE': { sosUrl: 'https://icis.corp.delaware.gov/Ecorp/EntitySearch/NameSearch.aspx' },
            'DISTRICT OF COLUMBIA': { sosUrl: 'https://corponline.dcra.dc.gov/Home.aspx' },
            'FLORIDA': { sosUrl: 'https://search.sunbiz.org/Inquiry/CorporationSearch/ByName' },
            'GEORGIA': { sosUrl: 'https://ecorp.sos.ga.gov/BusinessSearch' },
            'HAWAII': { sosUrl: 'https://hbe.ehawaii.gov/documents/search.html' },
            'IDAHO': { sosUrl: 'https://sosbiz.idaho.gov/search/business' },
            'ILLINOIS': { sosUrl: 'https://www.ilsos.gov/corporatellc/' },
            'INDIANA': { sosUrl: 'https://bsd.sos.in.gov/publicbusinesssearch' },
            'IOWA': { sosUrl: 'https://sos.iowa.gov/search/business/search.aspx' },
            'KANSAS': { sosUrl: 'https://www.sos.ks.gov/eforms/BusinessEntity/Search.aspx' },
            'KENTUCKY': { sosUrl: 'https://sosbes.sos.ky.gov/BusSearchNProfile/search.aspx' },
            'LOUISIANA': { sosUrl: 'https://coraweb.sos.la.gov/CommercialSearch/CommercialSearch.aspx' },
            'MAINE': { sosUrl: 'https://www10.informe.org/bdl/online/entity' },
            'MARYLAND': { sosUrl: 'https://egov.maryland.gov/BusinessExpress/EntitySearch' },
            'MASSACHUSETTS': { sosUrl: 'https://corp.sec.state.ma.us/Corp/CorpSearch/CorpSearch.aspx' },
            'MICHIGAN': { sosUrl: 'https://mibusinessregistry.lara.state.mi.us/search/business' },
            'MINNESOTA': { sosUrl: 'https://mblsportal.sos.state.mn.us/Business/Search' },
            'MISSISSIPPI': { sosUrl: 'https://corp.sos.ms.gov/corp/portal/c/page/corpBusinessIdSearch/portal.aspx' },
            'MISSOURI': { sosUrl: 'https://bsd.sos.mo.gov/BusinessEntity/BESearch.aspx' },
            'MONTANA': { sosUrl: 'https://biz.sosmt.gov/search/business' },
            'NEBRASKA': { sosUrl: 'https://www.nebraska.gov/sos/corp/corpsearch.cgi' },
            'NEVADA': { sosUrl: 'https://esos.nv.gov/EntitySearch/OnlineEntitySearch' },
            'NEW HAMPSHIRE': { sosUrl: 'https://quickstart.sos.nh.gov/online/BusinessInquire' },
            'NEW JERSEY': { sosUrl: 'https://www.njportal.com/DOR/BusinessNameSearch/Search/BusinessName' },
            'NEW MEXICO': { sosUrl: 'https://portal.sos.state.nm.us/BFS/online/Account/SearchBusiness' },
            'NEW YORK': { sosUrl: 'https://apps.dos.ny.gov/publicInquiry/' },
            'NORTH CAROLINA': { sosUrl: 'https://www.sosnc.gov/search/index/corp' },
            'NORTH DAKOTA': { sosUrl: 'https://firststop.sos.nd.gov/search/business' },
            'OHIO': { sosUrl: 'https://businesssearch.ohiosos.gov/' },
            'OKLAHOMA': { sosUrl: 'https://www.sos.ok.gov/corp/corpinquiryfind.aspx' },
            'OREGON': { sosUrl: 'https://egov.sos.state.or.us/br/pkg_web_name_srch_inq.do_name_srch' },
            'PENNSYLVANIA': { sosUrl: 'https://file.dos.pa.gov/search/business' },
            'RHODE ISLAND': { sosUrl: 'https://business.sos.ri.gov/CorpWeb/CorpSearch/CorpSearch.aspx' },
            'SOUTH CAROLINA': { sosUrl: 'https://businessfilings.sc.gov/BusinessFiling/Entity/Search' },
            'SOUTH DAKOTA': { sosUrl: 'https://sosenterprise.sd.gov/BusinessServices/Business/FilingSearch.aspx', directLink: true },
            'TENNESSEE': { sosUrl: 'https://tncab.tnsos.gov/business-entity-search' },
            'TEXAS': { sosUrl: 'https://mycpa.cpa.state.tx.us/coa/' },
            'UTAH': { sosUrl: 'https://secure.utah.gov/bes/' },
            'VERMONT': { sosUrl: 'https://sos.vermont.gov/corporations/search/' },
            'VIRGINIA': { sosUrl: 'https://cis.scc.virginia.gov/' },
            'WASHINGTON': { sosUrl: 'https://ccfs.sos.wa.gov/#/' },
            'WEST VIRGINIA': { sosUrl: 'https://apps.sos.wv.gov/business/corporations/' },
            'WISCONSIN': { sosUrl: 'https://www.wdfi.org/apps/CorpSearch/Search.aspx' },
            'WYOMING': { sosUrl: 'https://wyobiz.wyo.gov/Business/FilingSearch.aspx' }
        };

        const abbreviations = {
            'AL': 'ALABAMA', 'AK': 'ALASKA', 'AZ': 'ARIZONA', 'AR': 'ARKANSAS', 'CA': 'CALIFORNIA',
            'CO': 'COLORADO', 'CT': 'CONNECTICUT', 'DE': 'DELAWARE', 'DC': 'DISTRICT OF COLUMBIA',
            'FL': 'FLORIDA', 'GA': 'GEORGIA', 'HI': 'HAWAII', 'ID': 'IDAHO', 'IL': 'ILLINOIS',
            'IN': 'INDIANA', 'IA': 'IOWA', 'KS': 'KANSAS', 'KY': 'KENTUCKY', 'LA': 'LOUISIANA',
            'ME': 'MAINE', 'MD': 'MARYLAND', 'MA': 'MASSACHUSETTS', 'MI': 'MICHIGAN', 'MN': 'MINNESOTA',
            'MS': 'MISSISSIPPI', 'MO': 'MISSOURI', 'MT': 'MONTANA', 'NE': 'NEBRASKA', 'NV': 'NEVADA',
            'NH': 'NEW HAMPSHIRE', 'NJ': 'NEW JERSEY', 'NM': 'NEW MEXICO', 'NY': 'NEW YORK',
            'NC': 'NORTH CAROLINA', 'ND': 'NORTH DAKOTA', 'OH': 'OHIO', 'OK': 'OKLAHOMA',
            'OR': 'OREGON', 'PA': 'PENNSYLVANIA', 'RI': 'RHODE ISLAND', 'SC': 'SOUTH CAROLINA',
            'SD': 'SOUTH DAKOTA', 'TN': 'TENNESSEE', 'TX': 'TEXAS', 'UT': 'UTAH', 'VT': 'VERMONT',
            'VA': 'VIRGINIA', 'WA': 'WASHINGTON', 'WV': 'WEST VIRGINIA', 'WI': 'WISCONSIN',
            'WY': 'WYOMING'
        };

        function findState(addr) {
            if (!addr) return null;
            const upper = addr.toUpperCase();
            // 1. Check Abbreviations with word boundaries
            for (const abbr in abbreviations) {
                const regex = new RegExp(`\\b${abbr}\\b`);
                if (regex.test(upper)) return abbreviations[abbr];
            }
            // 2. Check Full Names
            for (const key in stateData) {
                if (upper.includes(key)) return key;
            }
            return null;
        }

        function handleBusinessSearch(entityName) {
            if (!entityName) {
                showToast('No Owner Entity to search', 'error');
                return;
            }

            // Get address from current drawer data
            const ownerAddr = document.getElementById('field-owneraddress').value || '';
            const stateKey = findState(ownerAddr);

            if (!stateKey) {
                showToast('Could not detect State from Owner Address', 'error');
                return;
            }

            // Copy to clipboard
            navigator.clipboard.writeText(entityName).then(() => {
                showToast(`Copied "${entityName}" to clipboard`, 'success');
            }).catch(err => console.error('Clipboard failed', err));

            // Open URL
            const data = stateData[stateKey];
            if (data.multi) {
                // For multi-link states (AZ), default to first one for now or open both? 
                // Let's open the first one.
                let url = data.links[0].url;
                if (!url.includes('?')) url += `?${data.links[0].param}=${encodeURIComponent(entityName)}`;
                window.open(url, '_blank');
            } else {
                let url = data.sosUrl;
                if (!data.directLink && !url.includes('?')) {
                    url += `?search_term=${encodeURIComponent(entityName)}`;
                }
                window.open(url, '_blank');
            }
        }

        // --- COL MANAGER ---
        function openColumnManager() {
            const list = document.getElementById('column-list');
            list.innerHTML = '';
            columnConfig.forEach((col, idx) => {
                const item = document.createElement('div');
                item.className = 'flex items-center gap-3 p-3 border border-gray-200 rounded-lg bg-white';
                item.innerHTML = `
                    <div class="flex items-center gap-3 flex-1">
                        <input type="checkbox" ${col.visible ? 'checked' : ''} onchange="toggleColVis(${idx})" class="accent-blue-600 h-4 w-4">
                        <span class="text-sm font-medium text-gray-700">${col.label}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="moveCol(${idx}, -1)" class="w-7 h-7 rounded hover:bg-gray-100 flex items-center justify-center text-gray-400 hover:text-gray-600"><i class="fa-solid fa-arrow-up text-xs"></i></button>
                        <button onclick="moveCol(${idx}, 1)" class="w-7 h-7 rounded hover:bg-gray-100 flex items-center justify-center text-gray-400 hover:text-gray-600"><i class="fa-solid fa-arrow-down text-xs"></i></button>
                    </div>
                `;
                list.appendChild(item);
            });
            document.getElementById('column-modal').classList.remove('hidden');
        }
        function toggleColVis(idx) { columnConfig[idx].visible = !columnConfig[idx].visible; }
        function moveCol(idx, dir) {
            const newIdx = idx + dir;
            if (newIdx < 0 || newIdx >= columnConfig.length) return;
            [columnConfig[idx], columnConfig[newIdx]] = [columnConfig[newIdx], columnConfig[idx]];
            openColumnManager();
        }
        function applyColumnSettings() { saveConfig(); closeColumnManager(); }
        function closeColumnManager() { document.getElementById('column-modal').classList.add('hidden'); }

        // --- UTILS ---
        function autoFillStates() {
            let count = 0;
            properties.forEach(p => {
                if (!p.state || p.state.trim() === "") {
                    const m = p['market'];
                    if (m && m.includes(',')) {
                        const st = m.split(',').pop().trim();
                        if (/^[A-Z]{2}$/.test(st)) { p.state = st; count++; }
                    }
                }
            });
            saveData(true); renderAll(); showToast(`Auto-filled ${count} states`, 'success');
        }

        async function clearAll() {
            if (confirm("Clear all data? This cannot be undone.")) {
                await apiClearAll();
                await kvSet('columnConfig', undefined);
                location.reload();
            }
        }

        function exportData() {
            if (!properties.length) {
                showToast('No data to export', 'error');
                return;
            }
            const clean = properties.map(p => {
                const c = {};
                columnConfig.forEach(col => c[col.label] = p[col.id] || "");
                return c;
            });
            const ws = XLSX.utils.json_to_sheet(clean);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Properties");
            XLSX.writeFile(wb, `CoStar_Export_${new Date().toISOString().slice(0, 10)}.xlsx`);
            showToast('Exported successfully', 'success');
        }

        async function tryBootstrapFromDefaultWorkbook() {
            try {
                const res = await fetch(DEFAULT_DATA_URL, { cache: 'no-store' });
                if (!res.ok) return false;
                const ab = await res.arrayBuffer();
                const wb = XLSX.read(ab, { type: 'array' });
                const ws = wb.Sheets['Master'] || wb.Sheets[wb.SheetNames[0]];
                const rawData = XLSX.utils.sheet_to_json(ws, { defval: "" });
                properties = [];
                mergeData(rawData);
                updateColumnConfigFromData();
                saveData(true);
                showToast('Loaded Master.xlsx', 'success');
                return true;
            } catch (e) {
                return false;
            }
        }

        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            const m = document.getElementById('toast-msg');
            const icon = document.getElementById('toast-icon');
            m.innerText = msg;

            if (type === 'error') {
                icon.className = 'fa-solid fa-circle-exclamation text-red-400';
            } else {
                icon.className = 'fa-solid fa-circle-check text-green-400';
            }

            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 2500);
        }

        function copyToClipboard(text) {
            if (!text) return;
            // Try modern API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('Copied to clipboard', 'success');
                }).catch(err => {
                    console.error('Clipboard API failed', err);
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            try {
                document.execCommand('copy');
                showToast('Copied to clipboard', 'success');
            } catch (err) {
                showToast('Failed to copy', 'error');
            }
            document.body.removeChild(ta);
        }
    </script>
</body>

</html>

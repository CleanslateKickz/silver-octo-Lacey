<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Intelligence | Command Center</title>
    <style>
        :root {
            /* Palette */
            --primary: #0f172a;       /* Deep Navy */
            --primary-light: #334155;
            --accent: #2563eb;        /* Modern Blue */
            --accent-hover: #1d4ed8;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            
            /* Tiers */
            --success: #10b981;       /* Emerald */
            --success-bg: #ecfdf5;
            --warning: #f59e0b;       /* Amber */
            --warning-bg: #fffbeb;
            --danger: #ef4444;        /* Red */
            --danger-bg: #fef2f2;

            /* Text */
            --text-main: #1e293b;
            --text-muted: #64748b;
            --text-light: #94a3b8;

            /* Spacing & UI */
            --radius-lg: 12px;
            --radius-md: 8px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.4;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* App-like feel */
        }

        /* --- Header --- */
        header {
            background-color: var(--bg-card);
            border-bottom: 1px solid #e2e8f0;
            padding: 0.6rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            flex-shrink: 0;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand-icon {
            width: 28px;
            height: 28px;
            background: var(--primary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .brand-text h1 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }
        .brand-text span {
            font-size: 0.7rem;
            color: var(--text-muted);
            display: block;
        }

        /* --- Main Layout --- */
        main {
            flex: 1;
            width: 100%;
            max-width: 1920px;
            margin: 0 auto;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            min-height: 0;
            overflow: auto;
        }

        /* --- Search Section --- */
        .search-section {
            background: var(--bg-card);
            padding: 0.6rem 1rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-shrink: 0;
        }

        .search-wrapper {
            position: relative;
            flex: 1;
            max-width: 600px;
        }
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            width: 18px;
        }

        input[type="text"] {
            width: 100%;
            padding: 8px 12px 8px 36px;
            font-size: 0.9rem;
            border: 1px solid #e2e8f0;
            border-radius: var(--radius-md);
            outline: none;
            background: #f8fafc;
        }
        input[type="text"]:focus {
            border-color: var(--accent);
            background: #fff;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .btn-analyze {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-analyze:hover { background-color: var(--accent); }

        /* --- Dashboard Grid (3 Columns) --- */
        .dashboard-grid {
            display: none;
            /* 3-column grid for Property Facts, Visuals, and Demographics */
            grid-template-columns: minmax(280px, 1fr) minmax(400px, 1.5fr) minmax(280px, 1fr);
            gap: 1rem;
            flex: 1;
            height: auto;
            min-height: 0;
            padding-bottom: 2rem;
        }

        /* Summary Row at Top */
        .summary-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .summary-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid #e2e8f0;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .summary-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 700;
        }

        .summary-content {
            display: flex;
            flex-direction: column;
        }

        .summary-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
        }

        .summary-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
            .col-center {
                grid-column: 1 / -1; /* Map takes full width on medium screens */
                order: -1; /* Put map on top */
            }
        }

        @media (max-width: 768px) {
            body { height: auto; overflow: auto; }
            .dashboard-grid {
                display: flex;
                flex-direction: column;
                height: auto;
            }
            .map-card { height: 400px !important; min-height: 400px; }
        }

        /* --- Column Containers --- */
        .col-left, .col-right {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 0;
        }

        .col-center {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 0;
        }

        /* --- Cards --- */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            flex-shrink: 0;
            z-index: 10;
        }

        .card-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Map Cards Specifics */
        .map-card {
            flex: 1;
            height: auto;
            min-height: 0;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            padding: 0; /* No padding inside map cards */
            overflow: hidden;
            position: relative;
        }

        .iframe-wrapper {
            flex: 1;
            background-color: #e2e8f0;
            width: 100%;
            min-height: 0;
            position: relative;
            display: flex;
            overflow: hidden;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
            flex: 1;
            min-height: 0;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .icon-btn {
            border: 1px solid #e2e8f0;
            background: var(--bg-card);
            color: var(--primary);
            border-radius: var(--radius-md);
            padding: 7px 10px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.15s, border-color 0.15s, transform 0.05s;
        }

        .icon-btn:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .icon-btn:active {
            transform: translateY(1px);
        }

        .tooltip-wrap {
            position: relative;
            display: inline-flex;
        }

        .tooltip-wrap::before {
            content: "";
            position: absolute;
            left: 50%;
            bottom: calc(100% + 4px);
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid rgba(15, 23, 42, 0.95);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
        }

        .tooltip-wrap::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            bottom: calc(100% + 10px);
            transform: translateX(-50%) translateY(4px);
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease, transform 0.15s ease;
            box-shadow: var(--shadow-md);
        }

        .tooltip-wrap:hover::after,
        .tooltip-wrap:focus-within::after,
        .tooltip-wrap:hover::before,
        .tooltip-wrap:focus-within::before {
            opacity: 1;
        }

        .tooltip-wrap:hover::after,
        .tooltip-wrap:focus-within::after {
            transform: translateX(-50%) translateY(0);
        }

        .tax-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            z-index: 350;
            display: none;
        }

        .tax-overlay.active {
            display: block;
        }

        .tax-drawer {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            width: min(560px, 92vw);
            background: var(--bg-card);
            box-shadow: -12px 0 30px rgba(0,0,0,0.2);
            transform: translateX(100%);
            transition: transform 0.22s ease;
            display: flex;
            flex-direction: column;
        }

        .tax-overlay.active .tax-drawer {
            transform: translateX(0);
        }

        .tax-drawer-header {
            padding: 0.9rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8fafc;
            flex-shrink: 0;
        }

        .tax-drawer-title {
            font-size: 0.85rem;
            font-weight: 800;
            letter-spacing: 0.03em;
            color: var(--primary);
            text-transform: uppercase;
        }

        .tax-close {
            border: 1px solid #e2e8f0;
            background: var(--bg-card);
            color: var(--primary);
            width: 34px;
            height: 34px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .tax-close:hover {
            background: #f1f5f9;
        }

        .tax-drawer-body {
            flex: 1;
            min-height: 0;
        }

        .tax-iframe {
            width: 100%;
            height: 100%;
            border: 0;
            display: block;
            background: white;
        }

        .placer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            z-index: 340;
            display: none;
        }

        .placer-overlay.active {
            display: block;
        }

        .placer-drawer {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            width: min(980px, 96vw);
            background: var(--bg-card);
            box-shadow: -12px 0 30px rgba(0,0,0,0.2);
            transform: translateX(100%);
            transition: transform 0.22s ease;
            display: flex;
            flex-direction: column;
        }

        .placer-overlay.active .placer-drawer {
            transform: translateX(0);
        }

        .placer-drawer-header {
            padding: 0.9rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8fafc;
            flex-shrink: 0;
        }

        .placer-drawer-title {
            font-size: 0.85rem;
            font-weight: 800;
            letter-spacing: 0.03em;
            color: var(--primary);
            text-transform: uppercase;
        }

        .placer-drawer-body {
            flex: 1;
            min-height: 0;
            display: flex;
        }

        .placer-drawer-body .map-card {
            border: none;
            border-radius: 0;
            box-shadow: none;
        }

        /* --- Content Components --- */
        
        /* Score Widget */
        .score-widget {
            padding: 1rem;
            text-align: center;
            background: #fff;
        }

        .score-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 800;
            color: white;
            margin: 0 auto 0.5rem;
            box-shadow: var(--shadow-md);
        }
        .score-top { background: linear-gradient(135deg, var(--success), #059669); }
        .score-mid { background: linear-gradient(135deg, var(--warning), #d97706); }
        .score-low { background: linear-gradient(135deg, var(--danger), #b91c1c); }

        .score-label { font-size: 1.1rem; font-weight: 700; color: var(--primary); }
        .rank-badge {
            background: #f1f5f9; color: var(--text-muted); padding: 4px 8px;
            border-radius: 12px; font-size: 0.75rem; font-weight: 600;
            border: 1px solid #e2e8f0; display: inline-block; margin-top: 4px;
        }
        .score-sub { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }

        .badge {
            padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
        }
        .badge.top { background: var(--success-bg); color: #065f46; }
        .badge.mid { background: var(--warning-bg); color: #92400e; }
        .badge.low { background: var(--danger-bg); color: #991b1b; }

        /* Advice & Notes */
        .advice-box {
            padding: 0.75rem; background: #eff6ff; border-left: 3px solid var(--accent);
            margin-top: 0.5rem; border-radius: 0 4px 4px 0;
        }
        .advice-text { font-size: 0.8rem; color: #1e3a8a; font-weight: 600; }
        .notes-text { font-size: 0.75rem; color: #475569; line-height: 1.4; margin-top: 0.5rem; }

        /* Comparison List */
        .comp-list { display: flex; flex-direction: column; }
        .comp-item {
            padding: 0.6rem; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; font-size: 0.85rem;
        }
        .comp-item:last-child { border-bottom: none; }
        .comp-score { font-weight: 700; width: 24px; text-align: center; margin-right: 8px; }
        .comp-name { flex: 1; font-weight: 600; color: var(--primary); }
        .comp-reason { font-size: 0.7rem; color: var(--text-muted); }

        /* Demographics (Compact in Sidebar) */
        .demo-card { padding: 0.75rem; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.85rem; }
        .stat-val { font-weight: 700; color: var(--primary); }
        
        .progress-row { margin-bottom: 0.75rem; }
        .p-head { display: flex; justify-content: space-between; font-size: 0.7rem; margin-bottom: 3px; font-weight: 600; color: var(--text-muted); }
        .p-track { background: #e2e8f0; height: 6px; border-radius: 3px; overflow: hidden; }
        .p-fill { height: 100%; border-radius: 3px; transition: width 0.6s ease; }

        .verif-footer { margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed #e2e8f0; font-size: 0.7rem; color: var(--text-muted); }

        /* Loader */
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Toast */
        .toast {
            position: fixed; bottom: 20px; right: 20px;
            background: #1e293b; color: white;
            padding: 10px 20px; border-radius: 6px;
            font-size: 0.85rem;
            transform: translateY(100px);
            transition: transform 0.3s;
            z-index: 200;
            box-shadow: var(--shadow-md);
        }
        .toast.active { transform: translateY(0); }

    </style>
</head>
<body>

    <header>
        <div class="brand">
            <div class="brand-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21h18M5 21V7l8-4 8 4v14"/></svg>
            </div>
            <div class="brand-text">
                <h1>NNN Intelligence</h1>
                <span>Command Center</span>
            </div>
        </div>
        <div class="header-actions">
            <span class="tooltip-wrap" data-tooltip="View income tax-free states">
                <button class="icon-btn" id="openTaxInfoBtn" type="button" aria-haspopup="dialog" aria-controls="taxOverlay">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h18v18H3z"></path><path d="M7 7h10"></path><path d="M7 12h10"></path><path d="M7 17h10"></path></svg>
                    Tax-Free States
                </button>
            </span>
            <span class="tooltip-wrap" data-tooltip="Show Placer.ai foot traffic sidebar">
                <button class="icon-btn" id="openPlacerBtn" type="button" aria-haspopup="dialog" aria-controls="placerOverlay">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h18v18H3z"></path><path d="M7 16h10"></path><path d="M7 12h6"></path><path d="M7 8h4"></path></svg>
                    Foot Traffic
                </button>
            </span>
            <div style="font-size: 0.7rem; font-weight: 600; color: var(--text-muted);">
                v2.2 | 2025 Data
            </div>
        </div>
    </header>

    <main>
        <!-- Search -->
        <section class="search-section">
            <div class="search-wrapper">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" id="addressInput" placeholder="Enter Address (e.g., 1002 N Spence Ave, Goldsboro, NC)">
            </div>
            <button class="btn-analyze" id="analyzeBtn">Analyze</button>
        </section>

        <!-- Summary Row (Visible after analysis) -->
        <div class="summary-row" id="summaryRow" style="display:none;">
            <!-- State Status -->
            <div class="summary-card">
                <div class="summary-icon" id="scoreCircleSmall">--</div>
                <div class="summary-content">
                    <div class="summary-label">State Score</div>
                    <div class="summary-value" id="stateNameSmall">---</div>
                    <div id="stateBadgeSmall" class="badge" style="width:fit-content; margin-top:2px;">---</div>
                </div>
            </div>
            <!-- Rank -->
            <div class="summary-card">
                <div class="summary-icon" style="background:#f0fdf4; color:#16a34a;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2h-4a2 2 0 0 0-2 2h0a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h2"></path><path d="M18 9v2a2 2 0 0 1-2 2h-2"></path></svg>
                </div>
                <div class="summary-content">
                    <div class="summary-label">National Rank</div>
                    <div class="summary-value" id="rankBadgeSmall">#--</div>
                    <div style="font-size:0.7rem; color:var(--text-muted);" id="exchangeAdviceSmall">---</div>
                </div>
            </div>
            <!-- Market Context -->
            <div class="summary-card" style="flex:1.5;">
                <div class="summary-content" style="width:100%;">
                    <div class="summary-label" style="margin-bottom:4px;">Market Context</div>
                    <div style="display:flex; gap:1rem; align-items:center;" id="neighborContainerSmall">
                        <span style="font-size:0.8rem; color:var(--text-muted);">Analysis pending...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3-Column Dashboard -->
        <div class="dashboard-grid" id="dashboard">
            
            <!-- COLUMN 1: LEFT (Insights & Environment) -->
            <aside class="col-left">
                
                <!-- Location Insights Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Location Insights</div>
                    </div>
                    <div class="demo-card">
                        <div style="margin-bottom: 0.8rem;">
                            <div style="font-size: 0.7rem; font-weight: 600; color: var(--text-muted); margin-bottom: 2px;">METRO / MICRO AREA</div>
                            <div id="msaName" style="font-size: 0.85rem; font-weight: 700; color: var(--primary); line-height: 1.3;">---</div>
                        </div>
                        
                        <div>
                            <div style="font-size: 0.7rem; font-weight: 600; color: var(--text-muted); margin-bottom: 4px;">PROXIMITY TO MAJOR HUBS</div>
                            <div id="cityProximityList" style="display: flex; flex-direction: column; gap: 4px;">
                                <div style="font-size: 0.8rem; color: var(--text-muted);">---</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Property Environment Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Property Environment</div>
                    </div>
                    <div class="demo-card">
                        <div class="stat-row">
                            <span>Current Weather</span>
                            <div style="text-align:right;">
                                <div id="weatherTemp" style="font-weight:700; color:var(--primary);">--°F</div>
                                <div id="weatherDesc" style="font-size:0.7rem; color:var(--text-muted);">---</div>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span>Elevation</span>
                            <span class="stat-val" id="elevationDisplay">-- ft</span>
                        </div>
                        <div class="stat-row">
                            <span>County</span>
                            <span class="stat-val" id="countyName">---</span>
                        </div>
                    </div>
                </div>

            </aside>

            <!-- COLUMN 2: CENTER (Google Maps) -->
            <section class="col-center">
                <div class="map-card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" color="var(--primary)"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                            Location & Aerial View
                        </div>
                        <span style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">GOOGLE MAPS</span>
                    </div>
                    <div class="iframe-wrapper">
                        <iframe id="googleMapFrame" src="" loading="lazy"></iframe>
                    </div>
                </div>
            </section>

            <!-- COLUMN 3: RIGHT (Demographics) -->
            <aside class="col-right">
                
                <!-- Demographics Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Demographics</div>
                    </div>
                    <div class="demo-card">
                        <div class="stat-row"><span>Population</span> <span class="stat-val" id="demoPop">--</span></div>
                        <div class="stat-row"><span>Med. Income</span> <span class="stat-val" id="demoInc">--</span></div>
                        <div class="stat-row"><span>Avg Age</span> <span class="stat-val" id="demoAge">--</span></div>
                        <div class="stat-row"><span>Growth</span> <span class="stat-val" id="demoGrowth">--</span></div>
                        
                        <div style="margin-top: 10px;">
                            <div class="progress-row">
                                <div class="p-head"><span>Disposable Inc</span> <span id="disposableVal">0%</span></div>
                                <div class="p-track"><div id="disposableBar" class="p-fill" style="width:0%; background:var(--accent);"></div></div>
                            </div>
                            <div class="progress-row">
                                <div class="p-head"><span>Education (B+)</span> <span id="educationVal">0%</span></div>
                                <div class="p-track"><div id="educationBar" class="p-fill" style="width:0%; background:#8b5cf6;"></div></div>
                            </div>
                        </div>
                        <div class="verif-footer">
                            <span id="verifStatus">---</span> | <span id="verifZip">---</span>
                        </div>
                    </div>
                </div>

                <!-- Advice/Notes (Moved here or kept in Summary?) Let's keep specific advice here if needed, or remove since we have summary. 
                     Actually, let's put the "State Notes" here as a "Strategy" card.
                -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">State Strategy</div>
                    </div>
                    <div class="advice-box" style="margin:0; border:none; background:transparent; padding:0.75rem;">
                        <div class="advice-text" id="stateNotes">---</div>
                    </div>
                </div>

            </aside>

        </div>
    </main>

    <!-- Overlay Loader -->
    <div class="loader-overlay" id="loader">
        <div class="spinner"></div>
        <div style="margin-top: 10px; font-weight: 600; color: var(--primary);">Gathering Intelligence...</div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <div id="taxOverlay" class="tax-overlay" aria-hidden="true">
        <div class="tax-drawer" role="dialog" aria-modal="true" aria-label="State income tax information">
            <div class="tax-drawer-header">
                <div class="tax-drawer-title">State Tax Information</div>
                <button class="tax-close" id="closeTaxInfoBtn" type="button" aria-label="Close">×</button>
            </div>
            <div class="tax-drawer-body">
                <iframe id="taxMapFrame" class="tax-iframe" src="GLM-4.6.html?mode=tax" loading="lazy"></iframe>
            </div>
        </div>
    </div>

    <div id="placerOverlay" class="placer-overlay" aria-hidden="true">
        <div class="placer-drawer" role="dialog" aria-modal="true" aria-label="Foot traffic and points of interest">
            <div class="placer-drawer-header">
                <div class="placer-drawer-title">Foot Traffic & POI</div>
                <button class="tax-close" id="closePlacerBtn" type="button" aria-label="Close">×</button>
            </div>
            <div class="placer-drawer-body">
                <div class="map-card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" color="#7c3aed"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                            Property Area Insights
                        </div>
                        <span style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">PLACER.AI</span>
                    </div>
                    <div class="iframe-wrapper">
                        <iframe id="placerFrame" src="" loading="lazy"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CENSUS_API_KEY = "b1819672ea28ef76ff4262612aea81b018db6674";

        const stateData = {
            'AL': { name: 'Alabama', tier: 'mid', score: 65, notes: 'Low cost of entry. Slower growth than Sun Belt.' },
            'AK': { name: 'Alaska', tier: 'low', score: 45, notes: 'High operational costs. Limited inventory.' },
            'AZ': { name: 'Arizona', tier: 'top', score: 88, notes: 'Explosive growth. High demand for NNN.' },
            'AR': { name: 'Arkansas', tier: 'mid', score: 62, notes: 'Low taxes. Steady economy.' },
            'CA': { name: 'California', tier: 'low', score: 40, notes: 'Strict regulations, high taxes, cap rate compression.' },
            'CO': { name: 'Colorado', tier: 'top', score: 85, notes: 'Strong economy. Denver is a prime hub.' },
            'CT': { name: 'Connecticut', tier: 'low', score: 50, notes: 'High taxes dampen long-term stability.' },
            'DE': { name: 'Delaware', tier: 'mid', score: 70, notes: 'Tax-friendly. Good for corporate leases.' },
            'FL': { name: 'Florida', tier: 'top', score: 95, notes: '#1 for 1031 exchanges. No state tax, massive growth.' },
            'GA': { name: 'Georgia', tier: 'top', score: 90, notes: 'Atlanta logistics hub. High growth rate.' },
            'HI': { name: 'Hawaii', tier: 'low', score: 48, notes: 'High costs/difficult regulations.' },
            'ID': { name: 'Idaho', tier: 'top', score: 82, notes: 'Boise rapid appreciation.' },
            'IL': { name: 'Illinois', tier: 'low', score: 42, notes: 'Fiscal instability drives businesses out.' },
            'IN': { name: 'Indiana', tier: 'mid', score: 72, notes: 'Conservative. Solid cap rates.' },
            'IA': { name: 'Iowa', tier: 'mid', score: 68, notes: 'Stolid, slow growth. Low risk.' },
            'KS': { name: 'Kansas', tier: 'mid', score: 66, notes: 'Central location logistics. Steady.' },
            'KY': { name: 'Kentucky', tier: 'mid', score: 69, notes: 'Low costs. Benefits from Cincinnati overflow.' },
            'LA': { name: 'Louisiana', tier: 'low', score: 52, notes: 'Economic volatility/insurance costs.' },
            'ME': { name: 'Maine', tier: 'mid', score: 71, notes: 'Seasonal economy. Safe but limited.' },
            'MD': { name: 'Maryland', tier: 'mid', score: 74, notes: 'High income density near DC.' },
            'MA': { name: 'Massachusetts', tier: 'mid', score: 63, notes: 'Tenant-friendly laws make remediation hard.' },
            'MI': { name: 'Michigan', tier: 'mid', score: 67, notes: 'Resurging manufacturing. Value-add opps.' },
            'MN': { name: 'Minnesota', tier: 'mid', score: 73, notes: 'Strong corporate tenants. Stable economy.' },
            'MS': { name: 'Mississippi', tier: 'low', score: 48, notes: 'Lowest income levels.' },
            'MO': { name: 'Missouri', tier: 'mid', score: 70, notes: 'St. Louis and KC provide diverse options.' },
            'MT': { name: 'Montana', tier: 'mid', score: 75, notes: 'Growing popularity, scarce inventory.' },
            'NE': { name: 'Nebraska', tier: 'mid', score: 71, notes: 'Omaha hidden gem. Very low unemployment.' },
            'NV': { name: 'Nevada', tier: 'top', score: 86, notes: 'No state income tax. High appreciation.' },
            'NH': { name: 'New Hampshire', tier: 'mid', score: 74, notes: 'No income tax. Limited inventory.' },
            'NJ': { name: 'New Jersey', tier: 'low', score: 52, notes: 'High taxes/regulatory burden.' },
            'NM': { name: 'New Mexico', tier: 'low', score: 55, notes: 'Economic struggles. High poverty rates.' },
            'NY': { name: 'New York', tier: 'low', score: 44, notes: 'Upstate stagnant; Downstate overpriced.' },
            'NC': { name: 'North Carolina', tier: 'top', score: 92, notes: 'Massive financial hub. Top 1031 performer.' },
            'ND': { name: 'North Dakota', tier: 'mid', score: 69, notes: 'Energy-dependent.' },
            'OH': { name: 'Ohio', tier: 'mid', score: 71, notes: 'Heartland value play.' },
            'OK': { name: 'Oklahoma', tier: 'mid', score: 64, notes: 'Landlord friendly. Energy-dependent.' },
            'OR': { name: 'Oregon', tier: 'mid', score: 58, notes: 'Regulations hurt climate.' },
            'PA': { name: 'Pennsylvania', tier: 'mid', score: 68, notes: 'Philly/Pittsburgh offer stability.' },
            'RI': { name: 'Rhode Island', tier: 'low', score: 56, notes: 'High taxes. Small market.' },
            'SC': { name: 'South Carolina', tier: 'top', score: 89, notes: 'Massive influx of businesses.' },
            'SD': { name: 'South Dakota', tier: 'top', score: 80, notes: 'No income tax. Business-friendly.' },
            'TN': { name: 'Tennessee', tier: 'top', score: 93, notes: 'No income tax. Nashville boomtown.' },
            'TX': { name: 'Texas', tier: 'top', score: 91, notes: 'Massive economy. Diverse industries.' },
            'UT': { name: 'Utah', tier: 'top', score: 87, notes: 'Young demographic. Booming tech sector.' },
            'VT': { name: 'Vermont', tier: 'low', score: 54, notes: 'Strict regulations. Aging pop.' },
            'VA': { name: 'Virginia', tier: 'top', score: 84, notes: 'Highest income levels. Gov/tech backing.' },
            'WA': { name: 'Washington', tier: 'top', score: 81, notes: 'No income tax. Strong economy.' },
            'WV': { name: 'West Virginia', tier: 'low', score: 50, notes: 'Economic struggles/Pop decline.' },
            'WI': { name: 'Wisconsin', tier: 'mid', score: 70, notes: 'Madison/Milwaukee stable.' },
            'WY': { name: 'Wyoming', tier: 'mid', score: 72, notes: 'Tax-friendly. Energy based.' }
        };

        const stateNameMap = {
            'alabama': 'AL', 'alaska': 'AK', 'arizona': 'AZ', 'arkansas': 'AR', 'california': 'CA',
            'colorado': 'CO', 'connecticut': 'CT', 'delaware': 'DE', 'florida': 'FL', 'georgia': 'GA',
            'hawaii': 'HI', 'idaho': 'ID', 'illinois': 'IL', 'indiana': 'IN', 'iowa': 'IA',
            'kansas': 'KS', 'kentucky': 'KY', 'louisiana': 'LA', 'maine': 'ME', 'maryland': 'MD',
            'massachusetts': 'MA', 'michigan': 'MI', 'minnesota': 'MN', 'mississippi': 'MS', 'missouri': 'MO',
            'montana': 'MT', 'nebraska': 'NE', 'nevada': 'NV', 'new hampshire': 'NH', 'new jersey': 'NJ',
            'new mexico': 'NM', 'new york': 'NY', 'north carolina': 'NC', 'north dakota': 'ND', 'ohio': 'OH',
            'oklahoma': 'OK', 'oregon': 'OR', 'pennsylvania': 'PA', 'rhode island': 'RI', 'south carolina': 'SC',
            'south dakota': 'SD', 'tennessee': 'TN', 'texas': 'TX', 'utah': 'UT', 'vermont': 'VT',
            'virginia': 'VA', 'washington': 'WA', 'west virginia': 'WV', 'wisconsin': 'WI', 'wyoming': 'WY',
            'district of columbia': 'DC'
        };

        const sortedStates = Object.entries(stateData).sort((a, b) => b[1].score - a[1].score);

        // --- Major Cities Data (Top ~50 US Cities for Proximity) ---
        const majorCities = [
            { name: "New York, NY", lat: 40.7128, lon: -74.0060 },
            { name: "Los Angeles, CA", lat: 34.0522, lon: -118.2437 },
            { name: "Chicago, IL", lat: 41.8781, lon: -87.6298 },
            { name: "Houston, TX", lat: 29.7604, lon: -95.3698 },
            { name: "Phoenix, AZ", lat: 33.4484, lon: -112.0740 },
            { name: "Philadelphia, PA", lat: 39.9526, lon: -75.1652 },
            { name: "San Antonio, TX", lat: 29.4241, lon: -98.4936 },
            { name: "San Diego, CA", lat: 32.7157, lon: -117.1611 },
            { name: "Dallas, TX", lat: 32.7767, lon: -96.7970 },
            { name: "San Jose, CA", lat: 37.3382, lon: -121.8863 },
            { name: "Austin, TX", lat: 30.2672, lon: -97.7431 },
            { name: "Jacksonville, FL", lat: 30.3322, lon: -81.6557 },
            { name: "Fort Worth, TX", lat: 32.7555, lon: -97.3308 },
            { name: "Columbus, OH", lat: 39.9612, lon: -82.9988 },
            { name: "Indianapolis, IN", lat: 39.7684, lon: -86.1581 },
            { name: "Charlotte, NC", lat: 35.2271, lon: -80.8431 },
            { name: "San Francisco, CA", lat: 37.7749, lon: -122.4194 },
            { name: "Seattle, WA", lat: 47.6062, lon: -122.3321 },
            { name: "Denver, CO", lat: 39.7392, lon: -104.9903 },
            { name: "Oklahoma City, OK", lat: 35.4676, lon: -97.5164 },
            { name: "Nashville, TN", lat: 36.1627, lon: -86.7816 },
            { name: "El Paso, TX", lat: 31.7619, lon: -106.4850 },
            { name: "Washington, DC", lat: 38.9072, lon: -77.0369 },
            { name: "Boston, MA", lat: 42.3601, lon: -71.0589 },
            { name: "Las Vegas, NV", lat: 36.1699, lon: -115.1398 },
            { name: "Portland, OR", lat: 45.5152, lon: -122.6784 },
            { name: "Detroit, MI", lat: 42.3314, lon: -83.0458 },
            { name: "Louisville, KY", lat: 38.2527, lon: -85.7585 },
            { name: "Memphis, TN", lat: 35.1495, lon: -90.0490 },
            { name: "Baltimore, MD", lat: 39.2904, lon: -76.6122 },
            { name: "Milwaukee, WI", lat: 43.0389, lon: -87.9065 },
            { name: "Albuquerque, NM", lat: 35.0844, lon: -106.6504 },
            { name: "Tucson, AZ", lat: 32.2226, lon: -110.9747 },
            { name: "Fresno, CA", lat: 36.7378, lon: -119.7871 },
            { name: "Sacramento, CA", lat: 38.5816, lon: -121.4944 },
            { name: "Kansas City, MO", lat: 39.0997, lon: -94.5786 },
            { name: "Mesa, AZ", lat: 33.4152, lon: -111.8315 },
            { name: "Atlanta, GA", lat: 33.7490, lon: -84.3880 },
            { name: "Omaha, NE", lat: 41.2565, lon: -95.9345 },
            { name: "Colorado Springs, CO", lat: 38.8339, lon: -104.8214 },
            { name: "Raleigh, NC", lat: 35.7796, lon: -78.6382 },
            { name: "Long Beach, CA", lat: 33.7701, lon: -118.1937 },
            { name: "Virginia Beach, VA", lat: 36.8529, lon: -75.9780 },
            { name: "Miami, FL", lat: 25.7617, lon: -80.1918 },
            { name: "Oakland, CA", lat: 37.8044, lon: -122.2711 },
            { name: "Minneapolis, MN", lat: 44.9778, lon: -93.2650 },
            { name: "Tulsa, OK", lat: 36.1540, lon: -95.9928 },
            { name: "Tampa, FL", lat: 27.9506, lon: -82.4572 },
            { name: "Arlington, TX", lat: 32.7357, lon: -97.1081 },
            { name: "New Orleans, LA", lat: 29.9511, lon: -90.0715 }
        ];

        // DOM
        const addressInput = document.getElementById('addressInput');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loader = document.getElementById('loader');
        const dashboard = document.getElementById('dashboard');
        const summaryRow = document.getElementById('summaryRow'); // New

        // Summary Row Elements
        const stateBadgeSmall = document.getElementById('stateBadgeSmall');
        const scoreCircleSmall = document.getElementById('scoreCircleSmall');
        const stateNameSmall = document.getElementById('stateNameSmall');
        const exchangeAdviceSmall = document.getElementById('exchangeAdviceSmall');
        const neighborContainerSmall = document.getElementById('neighborContainerSmall');
        const rankBadgeSmall = document.getElementById('rankBadgeSmall');

        // Facts & Environment
        const msaName = document.getElementById('msaName');
        const cityProximityList = document.getElementById('cityProximityList');
        const countyName = document.getElementById('countyName');
        const elevationDisplay = document.getElementById('elevationDisplay');
        const weatherTemp = document.getElementById('weatherTemp');
        const weatherDesc = document.getElementById('weatherDesc');

        // Existing
        const stateNotes = document.getElementById('stateNotes');
        
        const googleMapFrame = document.getElementById('googleMapFrame');
        const placerFrame = document.getElementById('placerFrame');

        const demoPop = document.getElementById('demoPop');
        const demoInc = document.getElementById('demoInc');
        const demoAge = document.getElementById('demoAge');
        const demoGrowth = document.getElementById('demoGrowth');
        const disposableBar = document.getElementById('disposableBar');
        const disposableVal = document.getElementById('disposableVal');
        const educationBar = document.getElementById('educationBar');
        const educationVal = document.getElementById('educationVal');
        const verifStatus = document.getElementById('verifStatus');
        const verifZip = document.getElementById('verifZip');

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('active');
            setTimeout(() => t.classList.remove('active'), 3000);
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function createGoogleMapsUrl(lat, lng, address) {
            const encodedAddress = encodeURIComponent(address);
            return `https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d1000!2d${lng}!3d${lat}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2s${encodedAddress}!5e1!3m2!1sen!2sus!4v${Date.now()}!5m1!1e4`;
        }

        function createPlacerUrl(zipCode, address) {
            const encodedAddress = encodeURIComponent(address);
            return `https://embedded-widget.placer.ai/widgets/v1/zip-code-map/?zipCode=${zipCode}&address=${encodedAddress}&utm_source=https%3A%2F%2Fwww.placer.ai%2Fexplore%2Fpoints-of-interest`;
        }

        async function fetchAddressData(address) {
            try {
                const osmUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&addressdetails=1`;
                const osmResponse = await fetch(osmUrl);
                if (!osmResponse.ok) throw new Error(`Server Error: ${osmResponse.status}`);
                const osmData = await osmResponse.json();

                if (!osmData || !Array.isArray(osmData) || osmData.length === 0) throw new Error("Address not found.");
                const locationData = osmData[0];

                if (!locationData || !locationData.address) throw new Error("Incomplete address data.");

                const lat = parseFloat(locationData.lat);
                const lon = parseFloat(locationData.lon);
                const zipCode = locationData.address.postcode;
                if (!zipCode) throw new Error("Zip code missing.");

                let stateNameRaw = locationData.address.state || locationData.address.region || locationData.address.state_district;
                if (!stateNameRaw) throw new Error("State not found.");
                
                const cleanStateName = stateNameRaw.replace("State of ", "").trim().toLowerCase();
                const stateAbbr = stateNameMap[cleanStateName];
                if (!stateAbbr) throw new Error(`State "${stateNameRaw}" not supported.`);

                // Extract County if available
                const county = locationData.address.county || "Unknown County";

                return {
                    stateAbbr,
                    stateName: stateData[stateAbbr].name,
                    zipCode,
                    lat,
                    lon,
                    county,
                    formattedAddress: locationData.display_name
                };
            } catch (error) { throw error; }
        }

        function renderNeighbors(stateAbbr) {
            neighborContainerSmall.innerHTML = '';
            const currentIndex = sortedStates.findIndex(s => s[0] === stateAbbr);
            if (currentIndex === -1) return;
            
            const currentState = sortedStates[currentIndex][1];
            let html = '';

            if (currentIndex > 0) {
                const above = sortedStates[currentIndex - 1];
                html += `<div class="comp-item"><div class="comp-score" style="color:var(--success)">${above[1].score}</div><div class="comp-name">${above[1].name}</div><div style="font-size:10px;color:var(--success)">▲</div></div>`;
            } else { html += `<div style="text-align:center;color:#94a3b8;font-size:0.7rem;padding:4px;">#1 Ranked</div>`; }

            if (currentIndex < sortedStates.length - 1) {
                const below = sortedStates[currentIndex + 1];
                html += `<div class="comp-item"><div class="comp-score" style="color:var(--danger)">${below[1].score}</div><div class="comp-name">${below[1].name}</div><div style="font-size:10px;color:var(--danger)">▼</div></div>`;
            } else { html += `<div style="text-align:center;color:#94a3b8;font-size:0.7rem;padding:4px;">Lowest Ranked</div>`; }
            
            neighborContainerSmall.innerHTML = html;
        }

        async function fetchCensusData(zipCode) {
            if (!CENSUS_API_KEY) return null;
            try {
                const censusUrl = `https://api.census.gov/data/2020/acs/acs5?get=NAME,B19013_001E,B01002_001E,B01003_001E,B15003_022E&for=zip%20code%20tabulation%20area:${zipCode}&key=${CENSUS_API_KEY}`;
                const response = await fetch(censusUrl);
                const data = await response.json();
                if (data.length < 2) return null;

                const stats = data[1];
                const headers = data[0];
                const getVal = (name) => stats[headers.indexOf(name)];

                const pop = parseInt(getVal("B01003_001E")) || 0;
                const income = parseInt(getVal("B19013_001E")) || 0;
                const age = parseFloat(getVal("B01002_001E")) || 0;
                const edu = parseInt(getVal("B15003_022E")) || 0;
                const eduPercent = pop > 0 ? ((edu / pop) * 100) : 0;

                return {
                    pop,
                    income,
                    age,
                    growth: "0.8",
                    disposable: Math.min(100, Math.max(40, (income / 120000) * 100)),
                    education: eduPercent
                };
            } catch (error) { return null; }
        }

        function generateFallbackDemographics(stateCode) {
            const tier = stateData[stateCode].tier;
            let incMultiplier = tier === 'top' ? 1.4 : (tier === 'mid' ? 1.0 : 0.8);
            let popMultiplier = tier === 'top' ? 1.5 : (tier === 'mid' ? 1.0 : 0.8);
            let eduPercent = tier === 'top' ? 38 : (tier === 'mid' ? 26 : 18);
            return {
                pop: Math.floor((45000 * popMultiplier) + (Math.random() * 50000)),
                income: Math.floor((55000 * incMultiplier) + (Math.random() * 15000)),
                age: (35 + Math.random() * 10).toFixed(1),
                growth: (0.5 + Math.random() * 1.5).toFixed(1),
                disposable: eduPercent + 15,
                education: eduPercent
            };
        }

        // --- New Helper Functions for Insights ---

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 3958.8; // Radius of Earth in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        async function fetchFCCData(lat, lon) {
            try {
                // Use the FCC Block API to get MSA info
                const url = `https://geo.fcc.gov/api/census/block/find?latitude=${lat}&longitude=${lon}&showall=true&format=json`;
                const res = await fetch(url);
                if (!res.ok) return null;
                const data = await res.json();
                
                // The API returns MSA info inside the 'Block' object or root depending on version
                if (data && data.Block && data.Block.MSA) {
                    return data.Block.MSA.MSAName || data.Block.MSA.MsaName || null;
                }
                if (data && data.MsaName) return data.MsaName;
                
                return null;
            } catch (e) {
                console.warn("FCC API Error:", e);
                return null;
            }
        }

        async function fetchWeatherAndElevation(lat, lon) {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&daily=sunrise,sunset&timezone=auto&elevation=true&temperature_unit=fahrenheit`;
                const res = await fetch(url);
                if (!res.ok) return null;
                const data = await res.json();
                
                return {
                    temp: data.current.temperature_2m,
                    unit: data.current_units.temperature_2m,
                    code: data.current.weather_code,
                    elevation: data.elevation
                };
            } catch (e) {
                console.warn("Weather API Error:", e);
                return null;
            }
        }

        function getWeatherDesc(code) {
             if (code === 0) return "Clear Sky";
             if (code >= 1 && code <= 3) return "Partly Cloudy";
             if (code >= 45 && code <= 48) return "Fog";
             if (code >= 51 && code <= 67) return "Rain/Drizzle";
             if (code >= 71 && code <= 77) return "Snow";
             if (code >= 80 && code <= 82) return "Rain Showers";
             if (code >= 95) return "Thunderstorm";
             return "Overcast/Varied";
        }

        analyzeBtn.addEventListener('click', async () => {
            const input = addressInput.value.trim();
            if (!input) { showToast("Enter an address."); return; }
            
            dashboard.style.display = 'none';
            summaryRow.style.display = 'none';
            loader.style.display = 'flex';
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'Processing...';

            try {
                const locationInfo = await fetchAddressData(input);
                const stateCode = locationInfo.stateAbbr;
                const data = stateData[stateCode];
                currentAnalyzedState = stateCode;
                updateTaxMapFrame();

                const rankIndex = sortedStates.findIndex(s => s[0] === stateCode);
                const currentRank = rankIndex + 1;

                // Update Summary Row
                stateNameSmall.textContent = data.name;
                stateNotes.textContent = data.notes;
                
                scoreCircleSmall.textContent = data.score;
                rankBadgeSmall.textContent = `Rank #${currentRank} / 50`;
                
                scoreCircleSmall.className = 'summary-icon';
                stateBadgeSmall.className = 'badge';

                if (data.tier === 'top') {
                    scoreCircleSmall.style.background = 'var(--success-bg)';
                    scoreCircleSmall.style.color = 'var(--success)';
                    stateBadgeSmall.classList.add('top');
                    stateBadgeSmall.textContent = "TOP TIER";
                    exchangeAdviceSmall.textContent = "High 1031 Priority";
                } else if (data.tier === 'mid') {
                    scoreCircleSmall.style.background = 'var(--warning-bg)';
                    scoreCircleSmall.style.color = '#b45309';
                    stateBadgeSmall.classList.add('mid');
                    stateBadgeSmall.textContent = "MID TIER";
                    exchangeAdviceSmall.textContent = "Value-Add Potential";
                } else {
                    scoreCircleSmall.style.background = 'var(--danger-bg)';
                    scoreCircleSmall.style.color = 'var(--danger)';
                    stateBadgeSmall.classList.add('low');
                    stateBadgeSmall.textContent = "LOW TIER";
                    exchangeAdviceSmall.textContent = "High Risk Factors";
                }

                renderNeighbors(stateCode);

                if (locationInfo.lat && locationInfo.lon) {
                    googleMapFrame.src = createGoogleMapsUrl(locationInfo.lat, locationInfo.lon, locationInfo.formattedAddress);
                    placerFrame.src = createPlacerUrl(locationInfo.zipCode, locationInfo.formattedAddress);
                    
                    countyName.textContent = locationInfo.county || "Unknown";

                    // --- Insights & Environment ---
                    
                    // 1. Fetch MSA
                    const msaEl = document.getElementById('msaName');
                    msaEl.textContent = "Loading...";
                    fetchFCCData(locationInfo.lat, locationInfo.lon).then(msa => {
                        msaEl.textContent = msa || "Not in a Metro Area";
                    });

                    // 2. Weather & Elevation
                    weatherTemp.textContent = "--";
                    weatherDesc.textContent = "Loading...";
                    fetchWeatherAndElevation(locationInfo.lat, locationInfo.lon).then(w => {
                        if (w) {
                            weatherTemp.textContent = `${w.temp}${w.unit}`;
                            weatherDesc.textContent = getWeatherDesc(w.code);
                            elevationDisplay.textContent = `${w.elevation.toFixed(0)} m`;
                        } else {
                            weatherDesc.textContent = "Unavail";
                        }
                    });

                    // 3. Nearest Major Cities
                    const distances = majorCities.map(city => {
                        return {
                            ...city,
                            dist: haversineDistance(locationInfo.lat, locationInfo.lon, city.lat, city.lon)
                        };
                    });
                    
                    distances.sort((a, b) => a.dist - b.dist);
                    const nearest = distances.slice(0, 3);

                    const cityListEl = document.getElementById('cityProximityList');
                    cityListEl.innerHTML = nearest.map(c => `
                        <div style="display:flex; justify-content:space-between; font-size:0.8rem;">
                            <span style="font-weight:600; color:var(--primary);">${c.name}</span>
                            <span style="color:var(--text-muted);">${c.dist.toFixed(1)} mi</span>
                        </div>
                    `).join('');
                }

                let demos = await fetchCensusData(locationInfo.zipCode);
                verifZip.textContent = locationInfo.zipCode;
                
                if (demos) {
                    verifStatus.textContent = "Verified (Census)";
                    verifStatus.style.color = "var(--success)";
                } else {
                    if (CENSUS_API_KEY === "") showToast("Simulation Mode (No API Key).");
                    verifStatus.textContent = "Est. (Sim)";
                    verifStatus.style.color = "var(--warning)";
                    demos = generateFallbackDemographics(stateCode);
                }

                demoPop.textContent = formatNumber(demos.pop);
                demoInc.textContent = "$" + formatNumber(demos.income);
                demoAge.textContent = demos.age + " yrs";
                demoGrowth.textContent = (demos.growth > 0 ? "+" : "") + demos.growth + "%";

                disposableVal.textContent = demos.disposable.toFixed(1) + "%";
                educationVal.textContent = demos.education.toFixed(1) + "%";
                
                disposableBar.style.width = '0%';
                educationBar.style.width = '0%';

                loader.style.display = 'none';
                dashboard.style.display = 'grid'; 
                summaryRow.style.display = 'grid'; // Show Summary Row
                
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Analyze';

                setTimeout(() => {
                    disposableBar.style.width = demos.disposable + "%";
                    educationBar.style.width = demos.education + "%";
                }, 100);

            } catch (error) {
                loader.style.display = 'none';
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Analyze';
                showToast(error.message);
            }
        });

        addressInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') analyzeBtn.click();
        });

        const openTaxInfoBtn = document.getElementById('openTaxInfoBtn');
        const taxOverlay = document.getElementById('taxOverlay');
        const closeTaxInfoBtn = document.getElementById('closeTaxInfoBtn');
        const taxMapFrame = document.getElementById('taxMapFrame');
        let currentAnalyzedState = null;
        let taxLastFocus = null;
        const openPlacerBtn = document.getElementById('openPlacerBtn');
        const placerOverlay = document.getElementById('placerOverlay');
        const closePlacerBtn = document.getElementById('closePlacerBtn');
        let placerLastFocus = null;

        function updateTaxMapFrame() {
            if (!taxMapFrame) return;
            const selected = currentAnalyzedState ? `&selected=${encodeURIComponent(currentAnalyzedState)}` : '';
            const nextSrc = `GLM-4.6.html?mode=tax${selected}`;
            if (taxMapFrame.getAttribute('src') !== nextSrc) taxMapFrame.setAttribute('src', nextSrc);
        }

        function openTaxDrawer() {
            taxLastFocus = document.activeElement;
            updateTaxMapFrame();
            if (placerOverlay.classList.contains('active')) closePlacerDrawer();
            taxOverlay.classList.add('active');
            taxOverlay.setAttribute('aria-hidden', 'false');
            closeTaxInfoBtn.focus();
        }

        function closeTaxDrawer() {
            taxOverlay.classList.remove('active');
            taxOverlay.setAttribute('aria-hidden', 'true');
            if (taxLastFocus && typeof taxLastFocus.focus === 'function') taxLastFocus.focus();
        }

        function openPlacerDrawer() {
            placerLastFocus = document.activeElement;
            if (taxOverlay.classList.contains('active')) closeTaxDrawer();
            placerOverlay.classList.add('active');
            placerOverlay.setAttribute('aria-hidden', 'false');
            closePlacerBtn.focus();
        }

        function closePlacerDrawer() {
            placerOverlay.classList.remove('active');
            placerOverlay.setAttribute('aria-hidden', 'true');
            if (placerLastFocus && typeof placerLastFocus.focus === 'function') placerLastFocus.focus();
        }

        openTaxInfoBtn.addEventListener('click', openTaxDrawer);
        closeTaxInfoBtn.addEventListener('click', closeTaxDrawer);
        taxOverlay.addEventListener('click', (e) => {
            if (e.target === taxOverlay) closeTaxDrawer();
        });
        openPlacerBtn.addEventListener('click', openPlacerDrawer);
        closePlacerBtn.addEventListener('click', closePlacerDrawer);
        placerOverlay.addEventListener('click', (e) => {
            if (e.target === placerOverlay) closePlacerDrawer();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key !== 'Escape') return;
            if (placerOverlay.classList.contains('active')) { closePlacerDrawer(); return; }
            if (taxOverlay.classList.contains('active')) closeTaxDrawer();
        });
    </script>
    </body>
</html>

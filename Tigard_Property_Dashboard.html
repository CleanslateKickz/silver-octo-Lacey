<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tigard Property Dashboard - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet-geocoder@3.1.4/dist/esri-leaflet-geocoder.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --light: #ecf0f1;
            --border: #bdc3c7;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --sidebar-width: 500px;
            --collapsed-width: 60px;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif; background-color: #f1f5f9; }
        .hidden { display: none !important; }
        .main-container { display: flex; flex-direction: column; height: 100vh; }
        .main-nav { background: white; padding: 0 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 1001; display: flex; justify-content: space-between; align-items: center; }
        .nav-title { font-size: 1.5rem; font-weight: 700; color: var(--dark); }
        .nav-tabs button { padding: 1.25rem 1rem; border: none; background: transparent; font-size: 1rem; font-weight: 600; color: #64748b; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s ease; }
        .nav-tabs button:hover { color: var(--primary); }
        .nav-tabs button.active { color: var(--primary); border-bottom-color: var(--primary); }
        .content-area { flex-grow: 1; overflow: hidden; position: relative; }
        .view { height: 100%; width: 100%; position: absolute; top: 0; left: 0; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .view.active { opacity: 1; visibility: visible; z-index: 100; }
        #dashboard-view { overflow-y: auto; padding: 2.5rem; }
        #data-view { overflow-y: auto; padding: 2.5rem; }
        .dashboard-header { text-align: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; }
        .dashboard-header h1 { font-size: 2.5rem; font-weight: 700; color: var(--dark); }
        .dashboard-header p { font-size: 1.1rem; color: #64748b; }
        .filters { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 2.5rem; background-color: white; padding: 1rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .filters select, .filters input { width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db; background-color: #f9fafb; font-weight: 500; }
        .filters > div { flex: 1; min-width: 200px; }
        .properties-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 1.5rem; }
        .property-card { background: #ffffff; border: 1px solid #e0e6ed; border-radius: 8px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: all 0.3s ease; display:flex; flex-direction: column; }
        .property-card.top-prospect { border-left: 5px solid var(--warning); }
        .property-card:hover { transform: translateY(-5px); box-shadow: 0 4px 16px rgba(0,0,0,0.12); border-color: var(--primary); }
        .property-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 16px; }
        .property-name { font-size: 1.2rem; font-weight: 600; color: #2c3e50; }
        .property-price { font-size: 1.1rem; font-weight: 700; color: #27ae60; white-space: nowrap; background: #ecf9f3; padding: 4px 12px; border-radius: 20px; }
        .property-address { font-size: 0.95rem; color: #7f8c8d; margin-bottom: 16px; font-style: italic; }
        .property-specs { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
        .spec-tag { background: #f8f9fa; border: 1px solid #dee2e6; color: #495057; font-size: 0.85rem; padding: 6px 12px; border-radius: 20px; }
        .property-notes { background: #f8f9fc; border-left: 4px solid var(--primary); padding: 14px; margin: 16px 0; font-size: 0.9rem; color: #34495e; border-radius: 0 4px 4px 0; flex-grow: 1; }
        .property-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: auto; padding-top: 1rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 10px 16px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 0.9rem; transition: all 0.2s ease; border: 1px solid transparent; text-align: center; }
        .btn-primary { background: var(--primary); color: white; } .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: #ffffff; color: var(--primary); border-color: var(--primary); } .btn-secondary:hover { background: var(--primary); color: white; }
        .btn-empty { visibility: hidden; }
        #map-view { display: flex; height: calc(100vh - 64px); /* Adjust 64px if your nav bar/header is taller */; min-height: 0; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 1rem; gap: 1rem; }
        .sidebar { background: white; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 100%; min-height: 0; z-index: 1000; transition: width 0.3s ease; position: relative; border-radius: 0.75rem; overflow:hidden; }
        .sidebar-left { width: var(--sidebar-width); } .sidebar-left.collapsed { width: var(--collapsed-width); }
        .sidebar-right { width: var(--sidebar-width); } .sidebar-right.collapsed { width: var(--collapsed-width); }
        .sidebar-header { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 1.5rem; display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .sidebar-header h2 { font-size: 1.5rem; font-weight: 700; margin: 0; white-space: nowrap; overflow: hidden; }
        .sidebar.collapsed .sidebar-header h2 { display: none; }
        .sidebar-content { padding: 1rem; overflow-y: auto; flex: 1; min-height: 0;}
        .sidebar-content.compact { padding: 0.75rem; }
        .form-control { padding: 0.5rem; font-size: 0.9rem; }
        .sidebar-content label { font-size: 0.85rem; font-weight: 600; }
        .sidebar.collapsed .sidebar-content { display: none; }
        .form-control { width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db; background: #f9fafb; transition: all 0.2s ease; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
        .map-container { flex: 1; position: relative; height: 100%; min-height: 0; }
        #map { height: 100%; width: 100%; min-height: 0; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .toggle-btn { position: absolute; top: 1rem; width: 2.5rem; height: 2.5rem; border-radius: 50%; background: white; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 1002; transition: all 0.3s ease; }
        .toggle-left { right: -1.25rem; } .toggle-right { left: -1.25rem; }
        .collapsed-btn { display: none; width: var(--collapsed-width); height: var(--collapsed-width); align-items: center; justify-content: center; color: var(--dark); font-size: 1.5rem; cursor: pointer; transition: background-color 0.3s ease; }
        .sidebar.collapsed .collapsed-btn { display: flex; } .collapsed-btn:hover { background-color: #f1f5f9; }
        #map-properties-list .list-item { padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; border-left: 4px solid transparent; margin-bottom: 0.5rem; }
        #map-properties-list .list-item:hover { background-color: #f4f4f5; }
        #map-properties-list .list-item.active { background-color: #eef2ff; border-left-color: var(--primary); }
        .leaflet-popup-content-wrapper { border-radius: 0.5rem; } .leaflet-popup-content { font-size: 0.9rem; }
        .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); background-color: var(--dark); color: white; padding: 0.75rem 1.5rem; border-radius: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 9999; opacity: 0; transition: opacity 0.3s, transform 0.3s; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(-1rem); }
        .nav-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
            justify-content: center;
        }
        .nav-button {
            background: var(--light);
            border: 1px solid var(--border);
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 20px;
            font-weight: 600;
            color: var(--secondary);
            transition: all 0.3s ease;
        }
        .nav-button:hover {
            background: var(--border);
        }
        .nav-button.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        @media (max-width: 768px) { .properties-grid { grid-template-columns: 1fr; } .filters { flex-direction: column; } .sidebar { width: 100% !important; } .toggle-btn { display: none; } }
        
        /* Data Management Styles */
        .view-toggle { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .view-toggle button { padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; background: white; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s ease; }
        .view-toggle button:hover { background: #f3f4f6; }
        .view-toggle button.active { background: var(--primary); color: white; border-color: var(--primary); }
        .table-container { background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: auto; max-height: 60vh; }
        .table-container table { width: 100%; border-collapse: collapse; }
        .table-container th, .table-container td { padding: 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .table-container th { background: #f9fafb; font-weight: 600; color: #374151; }
        .table-container tr:hover { background: #f9fafb; }
        .table-container .action-btn { padding: 0.5rem 1rem; margin: 0 0.25rem; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; transition: all 0.2s ease; }
        .table-container .edit-btn { background: #3b82f6; color: white; }
        .table-container .edit-btn:hover { background: #2563eb; }
        .table-container .delete-btn { background: #ef4444; color: white; }
        .table-container .delete-btn:hover { background: #dc2626; }
        .data-list-item { background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .data-list-item h3 { margin: 0 0 0.5rem 0; color: #1f2937; }
        .data-list-item p { margin: 0.25rem 0; color: #6b7280; }
        .data-list-item .actions { margin-top: 1rem; display: flex; gap: 0.5rem; }
        .data-list-item .action-btn { padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; transition: all 0.2s ease; }
        .data-list-item .edit-btn { background: #3b82f6; color: white; }
        .data-list-item .edit-btn:hover { background: #2563eb; }
        .data-list-item .delete-btn { background: #ef4444; color: white; }
        .data-list-item .delete-btn:hover { background: #dc2626; }
        
        .category-section { margin-bottom: 2rem; }
        .category-header {
          font-size: 1.5rem;
          font-weight: bold;
          color: var(--primary);
          margin-bottom: 1rem;
          border-bottom: 2px solid var(--border);
          padding-bottom: 0.5rem;
        }
        .category-items {
          display: flex;
          flex-direction: column;
          gap: 1rem;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <nav class="main-nav">
            <div class="nav-title"><i class="fa-solid fa-store text-indigo-500"></i> Tigard Cash & Carry Property Dashboard</div>
            <div class="nav-tabs">
                <button id="nav-dashboard" class="active"><i class="fas fa-th-large mr-2"></i> Client Dashboard</button>
                <button id="nav-map"><i class="fas fa-map-marked-alt mr-2"></i> Internal Map</button>
                <button id="nav-data"><i class="fas fa-table mr-2"></i> Data Management</button>
            </div>
        </nav>

        <main class="content-area">
            <!-- Client Dashboard View -->
            <div id="dashboard-view" class="view active">
                <div class="dashboard-header">
                    <h1>Property Opportunities in Tigard Area</h1>
                    <p>Curated listings matching your 35K-65K SF industrial/flex needs with 2+ acres, 18-20' clear height, and I-5 access.</p>
                </div>
                <div class="nav-bar">
                    <button class="nav-button active" data-category="all">All Properties</button>
                    <button class="nav-button" data-category="Top Prospect">Top Prospects / Client Mentioned</button>
                    <button class="nav-button" data-category="For Sale: Land">For Sale: Land</button>
                    <button class="nav-button" data-category="For Sale: Building">For Sale: Buildings</button>
                    <button class="nav-button" data-category="Off-Market Target">Outreach / Off-Market Targets</button>
                    <button class="nav-button" data-category="For Lease">For Lease (Sale Conversion)</button>
                    <button class="nav-button" data-category="IPA Owned">IPA Properties</button>
                </div>
                <div class="filters">
                    <div><input type="text" id="dashboard-search" placeholder="Search by name, address, or notes..."></div>
                    <div><select id="sort-by">
                        <option value="default">Sort by Default</option>
                        <option value="price-desc">Price: High to Low</option>
                        <option value="price-asc">Price: Low to High</option>
                        <option value="acres-desc">Acres: Large to Small</option>
                        <option value="acres-asc">Acres: Small to Large</option>
                    </select></div>
                </div>
                <div id="properties-grid" class="properties-grid">
                    <!-- Dynamic property cards -->
                </div>
            </div>

            <!-- Internal Map View -->
            <div id="map-view" class="view">
                <div class="sidebar sidebar-left" id="sidebar-left">
                    <div class="sidebar-header"><i class="fas fa-edit text-xl"></i><h2>Property Editor</h2></div>
                    <div class="collapsed-btn" id="collapsed-left-btn"><i class="fas fa-edit"></i></div>
                    <div class="sidebar-content compact form-container">
                        <button id="new-property-btn" class="btn btn-primary w-full mb-4"><i class="fas fa-plus"></i> Add New Property</button>
                        <form id="property-form">
                            <input type="hidden" id="form-id" />
                            <div class="mb-3"><label class="font-bold block mb-1 text-gray-700">Property Name</label><input type="text" id="form-name" class="form-control" required /></div>
                            <div class="mb-3"><label class="font-bold block mb-1 text-gray-700">Address</label><input type="text" id="form-address" class="form-control" /></div>
                            <div class="mb-4"><label class="font-bold block mb-1 text-gray-700">Image URL</label><input type="url" id="form-image_url" class="form-control" placeholder="https://example.com/property-image.jpg" /></div>
                            <div class="flex gap-3 mb-3">
                                <div class="flex-1"><label class="font-bold block mb-1 text-gray-700">Latitude</label><input type="number" id="form-lat" class="form-control" step="any" required /></div>
                                <div class="flex-1"><label class="font-bold block mb-1 text-gray-700">Longitude</label><input type="number" id="form-lng" class="form-control" step="any" required /></div>
                            </div>
                            <div class="flex gap-3 mb-3">
                                <div class="flex-1"><label class="font-bold block mb-1 text-gray-700">Category</label><select id="form-category" class="form-control"><option value="">Select Category</option></select></div>
                                <div class="flex-1"><label class="font-bold block mb-1 text-gray-700">Contact Status</label><select id="form-contacted" class="form-control"><option>Not Contacted</option><option>Contacted</option><option>Attempted</option></select></div>
                            </div>
                            <div class="mb-3"><label class="font-bold block mb-1 text-gray-700">Price</label><input type="text" id="form-price" class="form-control" placeholder="e.g., 1234567" /></div>
                            <div class="flex gap-3 mb-3">
                                <div class="flex-1"><label class="font-bold block mb-1 text-gray-700">Building SF</label><input type="text" id="form-size_sf" class="form-control" placeholder="e.g., 40000" /></div>
                                <div class="flex-1"><label class="font-bold block mb-1 text-gray-700">Land Acres</label><input type="text" id="form-size_acres" class="form-control" placeholder="e.g., 2.5" /></div>
                            </div>
                            <div class="mb-3"><label class="font-bold block mb-1 text-gray-700">OM/PDF URL</label><input type="url" id="form-pdf_url" class="form-control" /></div>
                            <div class="mb-3"><label class="font-bold block mb-1 text-gray-700">Listing URL</label><input type="url" id="form-listing_url" class="form-control" /></div>
                            <div class="mb-4"><label class="font-bold block mb-1 text-gray-700">Notes / Owner Info</label><textarea id="form-notes" class="form-control" rows="4" placeholder="Owner details, contact notes, criteria match..."></textarea></div>
                            <div class="flex gap-3 mt-4">
                                <button type="submit" id="save-btn" class="btn btn-primary flex-1"><i class="fas fa-save mr-2"></i>Save Property</button>
                                <button type="button" id="delete-btn" class="btn bg-red-600 text-white hover:bg-red-700 hidden flex-1"><i class="fas fa-trash mr-2"></i>Delete</button>
                            </div>
                        </form>
                    </div>
                </div>
                <button class="toggle-btn toggle-left" id="toggle-left"><i class="fas fa-chevron-left"></i></button>

                <div class="map-container">
                    <div id="map"></div>
                </div>

                <button class="toggle-btn toggle-right" id="toggle-right"><i class="fas fa-chevron-right"></i></button>

                <div class="sidebar sidebar-right" id="sidebar-right">
                    <div class="sidebar-header"><i class="fas fa-list text-xl"></i><h2>Properties List</h2></div>
                    <div class="collapsed-btn" id="collapsed-right-btn"><i class="fas fa-list"></i></div>
                    <div class="sidebar-content">
                        <div id="properties-list-section">
                            <input type="text" id="map-search-input" placeholder="Search properties..." class="form-control w-full mb-3">
                            <div id="map-properties-list" class="h-full overflow-y-auto space-y-2 max-h-96"></div>
                        </div>
                        <div id="property-details-section" class="hidden">
                            <button id="back-to-list-btn" class="btn btn-secondary w-full mb-3"><i class="fas fa-arrow-left mr-2"></i>Back to List</button>
                            <div id="selected-property-details" class="space-y-3"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Management View -->
            <div id="data-view" class="view">
                <div class="dashboard-header">
                    <h1>Property Data Management</h1>
                    <p>View, edit, and manage all property data in table and list formats</p>
                </div>
                
                <div class="filters">
                    <div><input type="text" id="data-search" placeholder="Search properties..."></div>
                    <div><select id="data-sort">
                        <option value="default">Sort by Default</option>
                        <option value="name-asc">Name: A-Z</option>
                        <option value="name-desc">Name: Z-A</option>
                        <option value="category-asc">Category: A-Z</option>
                        <option value="category-desc">Category: Z-A</option>
                        <option value="price-desc">Price: High to Low</option>
                        <option value="price-asc">Price: Low to High</option>
                    </select></div>
                    <div>
                        <button id="add-property-btn" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Add Property</button>
                        <button id="export-data-btn" class="btn btn-secondary"><i class="fas fa-download mr-2"></i>Export CSV</button>
                        <button id="reset-data-btn" class="btn btn-secondary"><i class="fas fa-refresh mr-2"></i>Reset to Full Data</button>
                    </div>
                </div>
            
                <div class="nav-bar">
                    <button class="nav-button active" data-category="all">All Properties</button>
                    <button class="nav-button" data-category="Top Prospect">Top Prospects / Client Mentioned</button>
                    <button class="nav-button" data-category="For Sale: Land">For Sale: Land</button>
                    <button class="nav-button" data-category="For Sale: Building">For Sale: Buildings</button>
                    <button class="nav-button" data-category="Off-Market Target">Outreach / Off-Market Targets</button>
                    <button class="nav-button" data-category="For Lease">For Lease (Sale Conversion)</button>
                    <button class="nav-button" data-category="IPA Owned">IPA Properties</button>
                </div>
            
                <div class="view-toggle">
                    <button id="table-view-btn" class="active"><i class="fas fa-table mr-2"></i>Table View</button>
                    <button id="list-view-btn"><i class="fas fa-list mr-2"></i>List View</button>
                </div>

                <!-- Table View -->
                <div id="table-view" class="table-container">
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acres</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SF</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Dynamic table rows -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- List View -->
                <div id="list-view" class="hidden">
                    <div id="data-list" class="space-y-4">
                        <!-- Dynamic list items -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = 'https://tigard-api.vercel.app/api';
        const STORAGE_KEY = 'tigard_properties_enhanced';
        let properties = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];


        // Utility Functions
        const getEl = id => document.getElementById(id);
        const formatCurrency = num => num ? `$${parseFloat(num).toLocaleString()}` : '';
        const formatSize = (val, unit) => val ? `${parseFloat(val).toLocaleString()} ${unit}` : '';
        const showToast = msg => {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        };

        const loadProperties = async () => {
          try {
            const response = await fetch(`${API_BASE}/properties`);
            if (!response.ok) throw new Error('Failed to load properties');
            properties = await response.json();
            // Reconstruct coords for backward compatibility (map uses coords array)
            properties.forEach(p => {
              if (p.lat && p.lng && !p.coords) p.coords = [p.lat, p.lng];
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(properties)); // Cache to localStorage
            // Re-render all views
            renderDashboard();
            renderMapWorkspace();
            renderDataTable();
            renderDataList();
            initCategories();
            showToast('Properties loaded from database');
          } catch (err) {
            console.error('Load error:', err);
            // Fallback to localStorage
            properties = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            if (properties.length === 0) {
              // Initialize with sample data if empty
              properties = [
                {"id":1,"name":"Sample Property 1","address":"123 Main St, Tigard, OR","coords":[45.430,-122.770],"price":500000,"size_acres":2.5,"size_sf":40000,"contacted":"Not Contacted","notes":"Sample notes","category":"Top Prospect"},
                {"id":2,"name":"Sample Property 2","address":"456 Oak Ave, Tigard, OR","coords":[45.435,-122.775],"price":750000,"size_acres":3.0,"size_sf":50000,"contacted":"Contacted","notes":"Another sample","category":"For Sale: Land"}
              ];
              localStorage.setItem(STORAGE_KEY, JSON.stringify(properties));
            }
            // Re-render all views
            renderDashboard();
            renderMapWorkspace();
            renderDataTable();
            renderDataList();
            initCategories();
            showToast('Using local data (API unavailable)');
          }
        };

        // Save/update property to API
        const saveProperty = async (propData) => {
          try {
            const method = propData.id ? 'PUT' : 'POST';
            const url = propData.id ? `${API_BASE}/properties?id=${propData.id}` : `${API_BASE}/properties`;
            // Ensure lat/lng are numbers
            propData.lat = parseFloat(propData.lat);
            propData.lng = parseFloat(propData.lng);
            propData.coords = [propData.lat, propData.lng];
            if (propData.price) propData.price = parseFloat(propData.price) || null;
            if (propData.size_acres) propData.size_acres = parseFloat(propData.size_acres) || null;
            if (propData.size_sf) propData.size_sf = parseInt(propData.size_sf) || null;
            const response = await fetch(url, {
              method,
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(propData)
            });
            if (!response.ok) throw new Error('Save failed');
            await loadProperties();  // Reload to sync
            localStorage.setItem(STORAGE_KEY, JSON.stringify(properties)); // Update cache
            showToast(`Property ${propData.id ? 'updated' : 'created'} successfully`);
            return await response.json();
          } catch (err) {
            console.error('Save error:', err);
            // Fallback: save to localStorage
            const index = properties.findIndex(p => p.id === propData.id);
            if (index > -1) {
              properties[index] = propData;
            } else {
              propData.id = Date.now(); // Generate ID if new
              properties.unshift(propData);
            }
            localStorage.setItem(STORAGE_KEY, JSON.stringify(properties));
            renderDashboard();
            renderMapWorkspace();
            renderDataTable();
            renderDataList();
            initCategories();
            showToast(`Property ${propData.id ? 'updated' : 'created'} locally (API unavailable)`);
          }
        };

        // Delete property from API
        const deletePropertyById = async (id) => {
          try {
            const response = await fetch(`${API_BASE}/properties?id=${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('Delete failed');
            await loadProperties();
            showToast('Property deleted successfully');
          } catch (err) {
            console.error('Delete error:', err);
            // Fallback: delete from localStorage
            properties = properties.filter(p => p.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(properties));
            renderDashboard();
            renderMapWorkspace();
            renderDataTable();
            renderDataList();
            initCategories();
            showToast('Property deleted locally (API unavailable)');
          }
        };

        // View Switching - will be redefined later with Data Management support

        // Dashboard Rendering
        const propertiesGrid = getEl('properties-grid');
        const dashboardSearch = getEl('dashboard-search');
        const sortByEl = getEl('sort-by');
        const navButtons = document.querySelectorAll('#dashboard-view .nav-bar .nav-button');
        let currentCategory = 'all';
        let currentDataCategory = 'all';

        // Data Management category navigation
        const dataNavButtons = document.querySelectorAll('#data-view .nav-bar .nav-button');
        dataNavButtons.forEach(button => {
            button.addEventListener('click', () => {
                dataNavButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                currentDataCategory = button.dataset.category;
                renderDataTable();
                renderDataList();
            });
        });
        
        // Add event listeners for category navigation buttons
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all buttons
                navButtons.forEach(btn => btn.classList.remove('active'));
                // Add active class to clicked button
                button.classList.add('active');
                // Update current category
                currentCategory = button.dataset.category;
                // Re-render dashboard
                renderDashboard();
            });
        });
        
        const renderDashboard = () => {
            let filtered = properties;
            const searchTerm = dashboardSearch.value.toLowerCase();
            if (searchTerm) filtered = filtered.filter(p => (p.name || '') + (p.address || '') + (p.notes || '').toLowerCase().includes(searchTerm));
            if (currentCategory !== 'all') filtered = filtered.filter(p => p.category === currentCategory);
            const sortVal = sortByEl.value;
            if (sortVal !== 'default') {
                const [key, dir] = sortVal.split('-');
                filtered.sort((a, b) => dir === 'asc' ? (parseFloat(a[key]) || 0) - (parseFloat(b[key]) || 0) : (parseFloat(b[key]) || 0) - (parseFloat(a[key]) || 0));
            }
            propertiesGrid.innerHTML = filtered.map(p => `
                <article class="property-card ${p.category === 'Top Prospect' ? 'top-prospect' : ''}">
                    <div class="property-header">
                        <div class="property-name">${p.category === 'Top Prospect' ? '⭐ ' : ''}${p.name}</div>
                        ${p.price ? `<div class="property-price">${formatCurrency(p.price)}</div>` : ''}
                    </div>
                    <div class="property-address">${p.address || 'Coordinates-based location'}</div>
                    <div class="property-specs">
                        ${p.size_acres ? `<span class="spec-tag"><i class="fas fa-expand-alt mr-2"></i>${p.size_acres} Acres</span>` : ''}
                        ${p.size_sf ? `<span class="spec-tag"><i class="far fa-building mr-2"></i>${formatSize(p.size_sf, 'SF')}</span>` : ''}
                        ${p.category ? `<span class="spec-tag bg-${p.category.includes('Top') ? 'yellow' : 'blue'}-100">${p.category}</span>` : ''}
                    </div>
                    ${p.notes ? `<div class="property-notes">${p.notes.replace(/\n/g, '<br>')}</div>` : '<div class="property-notes" style="visibility:hidden;">&nbsp;</div>'}
                    <div class="property-actions">
                        ${p.pdf_url ? `<a class="btn btn-primary" href="${p.pdf_url}" target="_blank"><i class="fas fa-file-pdf mr-2"></i>OM/PDF</a>` : '<span class="btn-empty"></span>'}
                        ${p.listing_url ? `<a class="btn btn-secondary" href="${p.listing_url}" target="_blank"><i class="fas fa-external-link-alt mr-2"></i>Listing</a>` : '<span class="btn-empty"></span>'}
                    </div>
                </article>
            `).join('');
        };
        
        // Navigation buttons handled by the new switchView function
        
        dashboardSearch.addEventListener('input', renderDashboard);
        sortByEl.addEventListener('change', renderDashboard);

        // Map Workspace
        const map = L.map('map').setView([45.429, -122.775], 13);
        L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom: 20, attribution: '© Google' }).addTo(map);
        const taxlotService = L.esri.query({ url: "https://www.portlandmaps.com/arcgis/rest/services/Public/Taxlots/MapServer/0" });
        const mapLayers = {};
        const mapSearchInput = getEl('map-search-input');
        const mapPropertiesList = getEl('map-properties-list');
        const form = getEl('property-form');
        const formInputs = { id: getEl('form-id'), name: getEl('form-name'), address: getEl('form-address'), lat: getEl('form-lat'), lng: getEl('form-lng'), category: getEl('form-category'), contacted: getEl('form-contacted'), price: getEl('form-price'), size_acres: getEl('form-size_acres'), size_sf: getEl('form-size_sf'), pdf_url: getEl('form-pdf_url'), listing_url: getEl('form-listing_url'), image_url: getEl('form-image_url'), notes: getEl('form-notes') };
        const propertiesListSection = getEl('properties-list-section');
        const propertyDetailsSection = getEl('property-details-section');
        const selectedPropertyDetails = getEl('selected-property-details');
        const backToListBtn = getEl('back-to-list-btn');
        const renderMapWorkspace = () => {
            const searchTerm = mapSearchInput.value.toLowerCase();
            const filtered = properties.filter(p => JSON.stringify(p).toLowerCase().includes(searchTerm));
            Object.values(mapLayers).forEach(layer => map.removeLayer(layer));
            mapPropertiesList.innerHTML = '';
            filtered.forEach(p => {
                const colors = { 'Top Prospect': '#f59e0b', 'For Sale: Land': '#10b981', 'For Sale: Building': '#3b82f6', 'Off-Market Target': '#ef4444', 'IPA Owned': '#8b5cf6', default: '#64748b' };
                const style = { color: colors[p.category] || colors.default, weight: 3, opacity: 0.9, fillOpacity: 0.3 };
                
                // Enhanced popup content for IPA properties
                let popupContent = `<strong>${p.name}</strong><br>`;
                if (p.image_url) {
                    popupContent += `<img src="${p.image_url}" style="max-width: 200px; height: auto; border-radius: 4px; margin-bottom: 8px;" alt="Property Image"><br>`;
                }
                popupContent += `${p.address || 'Location'}<br>`;
                popupContent += `<strong>Category:</strong> ${p.category || 'Uncategorized'}<br>`;
                popupContent += `<strong>Status:</strong> ${p.contacted || 'Not Contacted'}`;
                
                // Add additional details for IPA properties
                if (p.category === 'IPA Owned') {
                    popupContent += `<br><strong>Type:</strong> Institutional Property`;
                    if (p.notes) {
                        popupContent += `<br><strong>Owner/Contact:</strong> ${p.notes}`;
                    }
                } else {
                    popupContent += `<br><strong>Notes:</strong> ${p.notes || ''}`;
                }
                
                taxlotService.contains(L.latLng(p.coords[0], p.coords[1])).run((err, fc) => {
                    const layer = err || !fc?.features?.length ? L.marker(p.coords) : L.geoJSON(fc.features[0], { style });
                    layer.bindPopup(popupContent).on('click', () => fillForm(p));
                    mapLayers[p.id] = layer.addTo(map);
                });
                const li = document.createElement('div');
                li.className = `list-item ${p.category === 'Top Prospect' ? 'bg-yellow-50' : p.category === 'IPA Owned' ? 'bg-purple-50 border-purple-200' : ''}`;
                li.dataset.id = p.id;
                li.innerHTML = `<div class="font-bold text-gray-800">${p.name}</div><div class="text-sm text-gray-500">${p.category || 'Uncategorized'}</div><div class="text-xs text-gray-400">${p.contacted}</div>`;
                li.onclick = (e) => {
                    e.stopPropagation();
                    fillForm(p);
                    map.flyTo(p.coords, 16);
                    document.querySelectorAll('.list-item').forEach(item => item.classList.remove('active'));
                    li.classList.add('active');
                    showPropertyDetails(p);
                };
                mapPropertiesList.appendChild(li);
            });
        };
        const fillForm = p => {
            Object.keys(formInputs).forEach(key => formInputs[key].value = p[key] || '');
            formInputs.lat.value = p.coords[0];
            formInputs.lng.value = p.coords[1];
            getEl('form-id').value = p.id;
            getEl('delete-btn').classList.remove('hidden');
            getEl('save-btn').innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Update Property';
            document.querySelectorAll('.list-item').forEach(li => li.classList.remove('active'));
            document.querySelector(`.list-item[data-id='${p.id}']`)?.classList.add('active');
            showPropertyDetails(p);
        };
        const resetForm = () => {
            form.reset();
            getEl('form-id').value = '';
            getEl('delete-btn').classList.add('hidden');
            getEl('save-btn').innerHTML = '<i class="fas fa-save mr-2"></i>Save Property';
            document.querySelectorAll('.list-item.active').forEach(li => li.classList.remove('active'));
            // Hide details if open
            propertyDetailsSection.classList.add('hidden');
            propertiesListSection.classList.remove('hidden');
        };

        const showPropertyDetails = (p) => {
            propertiesListSection.classList.add('hidden');
            propertyDetailsSection.classList.remove('hidden');
            
            let detailsHtml = `
                <div class="property-detail-header">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">${p.name || 'Unnamed Property'}</h3>
                    <p class="text-sm text-gray-600 mb-3">${p.address || 'No address'}</p>
                </div>
            `;
            
            if (p.image_url) {
                detailsHtml += `<img src="${p.image_url}" alt="Property Image" class="w-full h-48 object-cover rounded-lg mb-3">`;
            }
            
            detailsHtml += `
                <div class="property-detail-info space-y-2 text-sm">
                    <p><strong>Category:</strong> <span class="text-gray-700">${p.category || 'Uncategorized'}</span></p>
                    <p><strong>Contact Status:</strong> <span class="text-gray-700">${p.contacted || 'Not Contacted'}</span></p>
                    ${p.price ? `<p><strong>Price:</strong> <span class="text-gray-700">${formatCurrency(p.price)}</span></p>` : ''}
                    ${p.size_acres ? `<p><strong>Acres:</strong> <span class="text-gray-700">${p.size_acres}</span></p>` : ''}
                    ${p.size_sf ? `<p><strong>SF:</strong> <span class="text-gray-700">${formatSize(p.size_sf, 'SF')}</span></p>` : ''}
                    <p><strong>Notes:</strong></p>
                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-700">${(p.notes || 'No notes available.').replace(/\n/g, '<br>')}</div>
                    ${p.pdf_url ? `<p class="mt-3"><a href="${p.pdf_url}" target="_blank" class="btn btn-primary text-xs">View OM/PDF</a></p>` : ''}
                    ${p.listing_url ? `<p><a href="${p.listing_url}" target="_blank" class="btn btn-secondary text-xs">View Listing</a></p>` : ''}
                </div>
            `;
            
            selectedPropertyDetails.innerHTML = detailsHtml;
        };

        backToListBtn.addEventListener('click', () => {
            propertyDetailsSection.classList.add('hidden');
            propertiesListSection.classList.remove('hidden');
            document.querySelectorAll('.list-item.active').forEach(li => li.classList.remove('active'));
        });
        form.addEventListener('submit', async e => {
          e.preventDefault();
          const id = getEl('form-id').value ? parseInt(getEl('form-id').value) : null;
          const propData = {
            id,
            lat: parseFloat(formInputs.lat.value),
            lng: parseFloat(formInputs.lng.value),
            coords: [parseFloat(formInputs.lat.value), parseFloat(formInputs.lng.value)]  // For map compat
          };
          Object.keys(formInputs).forEach(key => {
            if (key !== 'id' && key !== 'lat' && key !== 'lng') propData[key] = formInputs[key].value;
          });
          await saveProperty(propData);
          resetForm();
        });
        getEl('delete-btn').addEventListener('click', async () => {
          if (confirm('Delete this property?')) {
            const id = parseInt(getEl('form-id').value);
            await deletePropertyById(id);
            resetForm();
          }
        });

        // Sidebar Toggles (Fixed)
        const toggleSidebar = (sidebar, toggleBtn, isRight = false) => {
            sidebar.classList.toggle('collapsed');
            const isCollapsed = sidebar.classList.contains('collapsed');
            const iconClass = `fas fa-chevron-${isCollapsed ? (isRight ? 'left' : 'right') : (isRight ? 'right' : 'left')}`;
            toggleBtn.querySelector('i').className = iconClass;
            setTimeout(() => map.invalidateSize(), 350);
        };
        const sidebarLeft = getEl('sidebar-left'), toggleLeft = getEl('toggle-left'), collapsedLeft = getEl('collapsed-left-btn');
        const sidebarRight = getEl('sidebar-right'), toggleRight = getEl('toggle-right'), collapsedRight = getEl('collapsed-right-btn');
        [toggleLeft, collapsedLeft].forEach(btn => btn.addEventListener('click', () => toggleSidebar(sidebarLeft, toggleLeft)));
        [toggleRight, collapsedRight].forEach(btn => btn.addEventListener('click', () => toggleSidebar(sidebarRight, toggleRight, true)));

        // Event Listeners
        getEl('new-property-btn').addEventListener('click', resetForm);
        mapSearchInput.addEventListener('input', renderMapWorkspace);
        map.on('click', e => { if (!getEl('form-id').value) { formInputs.lat.value = e.latlng.lat.toFixed(5); formInputs.lng.value = e.latlng.lng.toFixed(5); } });

        const initCategories = () => {
          const categories = [...new Set(properties.map(p => p.category).filter(Boolean))].sort();
          const catOptions = categories.map(c => `<option value="${c}">${c}</option>`).join('');
          formInputs.category.innerHTML = '<option value="">Select Category</option>' + catOptions;
        };

        // Data Management View
        const dataView = getEl('data-view');
        const dataSearch = getEl('data-search');
        const dataSort = getEl('data-sort');
        const tableView = getEl('table-view');
        const listView = getEl('list-view');
        const tableViewBtn = getEl('table-view-btn');
        const listViewBtn = getEl('list-view-btn');
        const dataTableBody = getEl('data-table-body');
        const dataList = getEl('data-list');
        const addPropertyBtn = getEl('add-property-btn');
        const exportDataBtn = getEl('export-data-btn');

        // View Switching for Data Management
        const switchDataView = (viewType) => {
            if (viewType === 'table') {
                tableView.classList.remove('hidden');
                listView.classList.add('hidden');
                tableViewBtn.classList.add('active');
                listViewBtn.classList.remove('active');
            } else {
                tableView.classList.add('hidden');
                listView.classList.remove('hidden');
                tableViewBtn.classList.remove('active');
                listViewBtn.classList.add('active');
            }
        };

        // Render Data Table
        const renderDataTable = () => {
            let filtered = properties;
            const searchTerm = dataSearch.value.toLowerCase();
            if (searchTerm) filtered = filtered.filter(p => (p.name || '') + (p.address || '') + (p.notes || '').toLowerCase().includes(searchTerm));
            
            if (currentDataCategory !== 'all') {
                filtered = filtered.filter(p => p.category === currentDataCategory);
            }
            
            const sortVal = dataSort.value;
            if (sortVal !== 'default') {
                const [key, dir] = sortVal.split('-');
                filtered.sort((a, b) => {
                    if (key === 'name' || key === 'category') {
                        return dir === 'asc' ?
                            (a[key] || '').localeCompare(b[key] || '') :
                            (b[key] || '').localeCompare(a[key] || '');
                    } else {
                        return dir === 'asc' ?
                            (parseFloat(a[key]) || 0) - (parseFloat(b[key]) || 0) :
                            (parseFloat(b[key]) || 0) - (parseFloat(a[key]) || 0);
                    }
                });
            }

            dataTableBody.innerHTML = filtered.map(p => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${p.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.name || ''}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate" title="${p.address || ''}">${p.address || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${p.category || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${p.contacted || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${p.price ? formatCurrency(p.price) : ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${p.size_acres || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${p.size_sf || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${p.image_url ? `<img src="${p.image_url}" style="max-width: 50px; height: auto; border-radius: 4px;" alt="Property Image">` : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="action-btn edit-btn" onclick="editProperty(${p.id})">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteProperty(${p.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        };

        // Render Data List
        const renderDataList = () => {
            let filtered = properties;
            const searchTerm = dataSearch.value.toLowerCase();
            if (searchTerm) filtered = filtered.filter(p => (p.name || '') + (p.address || '') + (p.notes || '').toLowerCase().includes(searchTerm));
            
            if (currentDataCategory !== 'all') {
                filtered = filtered.filter(p => p.category === currentDataCategory);
            }
            
            const sortVal = dataSort.value;
            if (sortVal !== 'default') {
                const [key, dir] = sortVal.split('-');
                filtered.sort((a, b) => {
                    if (key === 'name' || key === 'category') {
                        return dir === 'asc' ?
                            (a[key] || '').localeCompare(b[key] || '') :
                            (b[key] || '').localeCompare(a[key] || '');
                    } else {
                        return dir === 'asc' ?
                            (parseFloat(a[key]) || 0) - (parseFloat(b[key]) || 0) :
                            (parseFloat(b[key]) || 0) - (parseFloat(a[key]) || 0);
                    }
                });
            }

            // Group by category for list view
            const grouped = {};
            filtered.forEach(p => {
                const cat = p.category || 'Uncategorized';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(p);
            });
            
            let html = '';
            Object.keys(grouped).sort().forEach(cat => {
                const items = grouped[cat];
                html += `
<div class="category-section">
    <h2 class="category-header">${cat} (${items.length})</h2>
    <div class="category-items">
        ${items.map(p => `
            <div class="data-list-item">
                <h3>${p.name || 'Unnamed Property'}</h3>
                <p><strong>Address:</strong> ${p.address || 'No address'}</p>
                <p><strong>Category:</strong> ${p.category || 'Uncategorized'}</p>
                <p><strong>Contact Status:</strong> ${p.contacted || 'Not Contacted'}</p>
                <p><strong>Price:</strong> ${p.price ? formatCurrency(p.price) : 'No price'}</p>
                <p><strong>Size:</strong> ${p.size_acres ? p.size_acres + ' acres' : ''} ${p.size_sf ? p.size_sf + ' SF' : ''}</p>
                <div class="actions">
                    <button class="action-btn edit-btn" onclick="editProperty(${p.id})">Edit</button>
                    <button class="action-btn delete-btn" onclick="deleteProperty(${p.id})">Delete</button>
                </div>
            </div>
        `).join('')}
    </div>
</div>
                `;
            });
            dataList.innerHTML = html;
        };

        // Edit Property
        window.editProperty = (id) => {
            const property = properties.find(p => p.id === id);
            if (property) {
                fillForm(property);
                switchView('map'); // Switch to map view to use the existing form
            }
        };

        // Delete Property
        window.deleteProperty = async (id) => {
          if (confirm('Are you sure you want to delete this property?')) {
            await deletePropertyById(id);
            renderDataTable();
            renderDataList();
          }
        };

        // Export to CSV
        const exportToCSV = () => {
            const headers = ['ID', 'Name', 'Address', 'Category', 'Contacted', 'Price', 'Size (Acres)', 'Size (SF)', 'Image URL', 'Notes'];
            const csvContent = [
                headers.join(','),
                ...properties.map(p => [
                    p.id,
                    `"${p.name || ''}"`,
                    `"${p.address || ''}"`,
                    `"${p.category || ''}"`,
                    `"${p.contacted || ''}"`,
                    p.price || '',
                    p.size_acres || '',
                    p.size_sf || '',
                    `"${p.image_url || ''}"`,
                    `"${p.notes || ''}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tigard_properties.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            showToast('Data exported successfully!');
        };

        // Event Listeners for Data Management
        tableViewBtn.addEventListener('click', () => switchDataView('table'));
        listViewBtn.addEventListener('click', () => switchDataView('list'));
        dataSearch.addEventListener('input', () => {
            renderDataTable();
            renderDataList();
        });
        dataSort.addEventListener('change', () => {
            renderDataTable();
            renderDataList();
        });
        addPropertyBtn.addEventListener('click', () => {
            resetForm();
            switchView('map'); // Switch to map view to use the existing form
        });
        exportDataBtn.addEventListener('click', exportToCSV);
        
        // Reset data button
        getEl('reset-data-btn').addEventListener('click', () => {
            if (confirm('Are you sure? This will reset to the default full dataset and lose any unsaved changes.')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        });

        // Update View Switching to include Data Management
        const navBtns = { dashboard: getEl('nav-dashboard'), map: getEl('nav-map'), data: getEl('nav-data') };
        const views = { dashboard: getEl('dashboard-view'), map: getEl('map-view'), data: dataView };
        const switchView = viewName => {
            Object.values(views).forEach(v => v.classList.remove('active'));
            Object.values(navBtns).forEach(b => b.classList.remove('active'));
            views[viewName].classList.add('active');
            navBtns[viewName].classList.add('active');
            if (viewName === 'map') setTimeout(() => map?.invalidateSize(), 350);
            if (viewName === 'data') {
                renderDataTable();
                renderDataList();
            }
        };
        navBtns.dashboard.addEventListener('click', () => switchView('dashboard'));
        navBtns.map.addEventListener('click', () => switchView('map'));
        navBtns.data.addEventListener('click', () => switchView('data'));

        // Initial Load
        loadProperties();
        resetForm();
    </script>
</body>
</html>
